# خطة تشخيص غير معطِّلة

## الهدف
- تحديد سبب رسالة الخطأ عند إنشاء حقل جديد عبر التكامل بين Vercel وSupabase، دون أي تعديل على الإنتاج.

## ما سنفحصه (قراءة فقط)
1. مخطط قاعدة البيانات:
   - مقارنة أعمدة جدول `fields` المستخدمة في الكود مع المهاجرات الفعلية:
     - الكود يرسل `boundary_coordinates`, `centroid`, `latitude`, `longitude`, `user_id` (app/api/fields/route.ts:280-293).
     - مخطط قديم: يعرض `boundaries` فقط دون أعمدة الموقع وبدون `user_id` (scripts/003_create_fields.sql:14-18).
     - مخطط أحدث: يحتوي على `boundary_coordinates`, `centroid`, `latitude`, `longitude`, و`user_id` (scripts/013_supabase_schema.sql:282-301).
2. سياسات RLS:
   - المخطط القديم يعتمد على `farms.owner_id` (scripts/003_create_fields.sql:35-43، 25-33، 45-63).
   - المخطط الأحدث يعتمد على `fields.user_id` (scripts/013_supabase_schema.sql:309-315) مع تريغر يملأ `user_id` تلقائيًا.
   - الكود يتحقق من الملكية عبر `farm_owners` مع مسار تراجعي لـ`farms.owner_id/user_id` (app/api/fields/route.ts:106-163).
3. البيئة على Vercel:
   - تأكيد ضبط `NEXT_PUBLIC_SUPABASE_URL` و`NEXT_PUBLIC_SUPABASE_ANON_KEY` صحيحة، لأن فقدانها يفشل عميل الخادم مباشرة (lib/supabase/server.ts:10-14).
4. وحدات المساحة:
   - الواجهة تحفظ المساحة بوحدة الفدان، بينما المخطط القديم يعلّق أنها هكتار؛ سنوصي بتوحيد التحويل.

## التشخيص الأولي
- احتمال قوي أن الإنتاج يستخدم مخططًا قديمًا لـ`fields`؛ إدراج أعمدة غير موجودة يسبب 500 برسالة شبيهة بـ"column boundary_coordinates does not exist" أو خطأ RLS.
- احتمال ثانوي رُفض الإدراج بسبب سياسة RLS غير متسقة مع طريقة التحقق من الملكية.
- احتمال ثالث فشل مصادقة Supabase بسبب مفاتيح بيئة غير صحيحة.

## تقرير سنقدّمه
- ملخص فرق المخطط وسياسات RLS مع مراجع `file_path:line`.
- قائمة الأسباب المحتملة مرتّبة حسب الترجيح.
- توصيات آمنة قابلة للتطبيق لاحقًا: توافق الإدخال مع المخططين، توحيد RLS، تحويل وحدات المساحة.

## خطوات لاحقة (اختيارية بعد الموافقة على التنفيذ)
1. تعديل مسار الإدراج ليكون متوافقًا مع كلا المخططين (الاكتشاف الديناميكي للأعمدة):
   - إرسال `boundaries` إذا لم تتوفر `boundary_coordinates`، وتجاهل أعمدة غير موجودة.
   - عدم إرسال `user_id` وترك التريغر يملؤه عندما يكون موجودًا.
2. توحيد RLS:
   - إضافة سياسة إدراج/تحديث تعتمد على ملكية المزرعة (`owner_id`) بالإضافة إلى `user_id` لتغطية النسختين.
3. توحيد وحدة "المساحة":
   - تحويل الفدان إلى هكتار قبل التخزين، أو تحديث الوصف/التحويل في الواجهة.
4. تدقيق بيئة Vercel:
   - التحقق من مفاتيح Supabase العامة ومفاتيح المزودين (Mapbox/EOSDA/Sentinel) دون كشف أي مفاتيح سرية.

## افتراضات
- تطبيق الإنتاج مرتبط بـVercel ومصدر قاعدة البيانات Supabase قائم ومفاتيحه مضبوطة هناك.

## نتيجة متوقعة
- تحديد السبب المرجّح بدقة مع توصيات عملية، دون أي تعطيل للإنتاج. 