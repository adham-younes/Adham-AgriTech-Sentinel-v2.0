# Global Antigravity Rules - Adham AgriTech
بناءً على المعلومات المتاحة، إليك الخطة التنفيذية التقنية المفصلة لتطوير الميزات الأساسية لمنصة Adham AgriTech، مع التركيز على التكامل بين التقنيات المحددة.

1. وحدة إدارة الحقول وتحليل صور الأقمار الصناعية
تهدف هذه الوحدة إلى تمكين المستخدمين من تحديد حقولهم الزراعية على خريطة تفاعلية، وطلب وتحليل صور الأقمار الصناعية (مثل مؤشر NDVI) لهذه الحقول.

الخطوة 1: بناء الواجهة الأمامية (Frontend) باستخدام Next.js و Mapbox GL
إعداد المشروع:

ابدأ مشروع Next.js جديد باستخدام create-next-app.

قم بتثبيت مكتبات Mapbox GL JS و react-map-gl للتعامل مع الخرائط، بالإضافة إلى مكتبة مثل mapbox-gl-draw لإضافة أدوات الرسم.

تطوير واجهة الخريطة التفاعلية:

عرض الخريطة: قم بإنشاء مكون React لعرض الخريطة باستخدام react-map-gl. ستحتاج إلى مفتاح وصول (Access Token) من حسابك في Mapbox.

أدوات الرسم: أضف مكونات التحكم بالرسم (mapbox-gl-draw) للسماح للمستخدمين برسم مضلعات (Polygons) لتحديد حدود حقولهم.

إدارة الحالة (State Management): استخدم useState أو useReducer في React لتخزين إحداثيات المضلع الذي يرسمه المستخدم. عند اكتمال الرسم، قم بحفظ الشكل الهندسي (Geometry) للمضلع.

التعديل والحفظ: قم بتمكين المستخدم من تعديل المضلعات المرسومة. عند الحفظ، يتم إرسال بيانات المضلع (بصيغة GeoJSON) إلى الواجهة الخلفية.

الخطوة 2: تصميم قاعدة البيانات (Database) في Supabase PostgreSQL مع PostGIS
تفعيل امتداد PostGIS:

من لوحة تحكم Supabase، اذهب إلى قسم "Database" ثم "Extensions".

ابحث عن postgis وقم بتفعيله. هذا الامتداد يضيف أنواع بيانات جغرافية (مثل geometry) ودوال متخصصة للاستعلامات المكانية.

تصميم جدول الحقول (fields):

أنشئ جدولًا جديدًا باسم fields لتخزين معلومات الحقول.

التصميم الأمثل للجدول:

id: uuid (معرّف فريد، مفتاح أساسي).

user_id: uuid (لربط الحقل بالمستخدم، مفتاح خارجي مرتبط بجدول المستخدمين auth.users).

name: text (اسم الحقل الذي يحدده المستخدم).

area: float (مساحة الحقل، يمكن حسابها باستخدام PostGIS).

geom: geometry(Polygon, 4326) (لتخزين إحداثيات المضلع. 4326 هو رمز نظام الإحداثيات العالمي WGS 84).

created_at: timestamp with time zone (تاريخ إنشاء السجل).

الخطوة 3: إنشاء دالة سحابية (Supabase Edge Function) للمنطق الخلفي
توفر Supabase دوال سحابية يمكن إنشاؤها ونشرها مباشرة. 
Google Mail icon
 


إنشاء الدالة:

استخدم Supabase CLI لإنشاء دالة جديدة (مثل get-ndvi-image).

ستكون الدالة مكتوبة بلغة TypeScript/JavaScript وتعمل على Deno runtime.

برمجة منطق الدالة:

استقبال الطلب: تستقبل الدالة طلبًا من نوع POST يحتوي على field_id.

الاستعلام عن حدود الحقل: باستخدام Supabase client داخل الدالة، قم بالاستعلام عن جدول fields لجلب geom (الإحداثيات الجغرافية) للحقل المحدد.

التواصل مع EOSDA API:

استخدم fetch API المدمج في الدالة لإرسال طلب إلى EOSDA API. 
Google Drive icon

الطلب يجب أن يحتوي على إحداثيات المضلع (المستخرجة من قاعدة البيانات) للحصول على صورة NDVI للمنطقة المحددة. 
Google Mail icon

قم بتضمين مفتاح API الخاص بـ EOSDA في رأس الطلب (Request Header) للمصادقة. 
Google Mail icon

إرجاع الاستجابة: تقوم الدالة بإرجاع البيانات المستلمة من EOSDA API (والتي قد تكون رابطًا لصورة NDVI أو بيانات خام) إلى الواجهة الأمامية.

الخطوة 4: عرض بيانات NDVI على الخريطة
معالجة الاستجابة: في الواجهة الأمامية، استقبل الاستجابة من الدالة السحابية. إذا كانت الاستجابة هي رابط لصورة، يمكنك استخدامها مباشرة.

إضافة طبقة NDVI:

استخدم Mapbox GL لإضافة "طبقة نقطية" (Raster Layer) جديدة فوق الخريطة.

قم بتعيين مصدر (Source) هذه الطبقة إلى رابط صورة NDVI التي تم الحصول عليها.

إضافة مفتاح لوني (Legend):

أنشئ مكون React منفصل لعرض مفتاح لوني يوضح ما تمثله الألوان المختلفة في صورة NDVI (على سبيل المثال، تدرج من الأحمر إلى الأخضر يمثل صحة النبات).

2. وحدة الري الذكي (Smart Irrigation)
تهدف هذه الوحدة إلى تقديم توصيات دقيقة للري بناءً على بيانات متعددة المصادر.

الخطوة 1: التصميم الخوارزمي للمنطق الحسابي
تعتمد الخوارزمية على دمج بيانات رطوبة التربة وبيانات الطقس لتحديد الحاجة الفعلية للري. 
Google Drive icon
 


جمع البيانات:

رطوبة التربة: يتم الحصول عليها من EOSDA Soil Moisture API، والتي توفر بيانات مستنبطة من أقمار صناعية مثل Sentinel-2. 
Google Mail icon
 


بيانات التنبؤات الجوية: يتم الحصول عليها من واجهة برمجة تطبيقات متخصصة في الطقس (مثل OpenWeatherMap API) وتشمل:

درجة الحرارة المتوقعة.

معدل هطول الأمطار المتوقع (Precipitation).

معدل التبخر والنتح (Evapotranspiration - ET).

المنطق الحسابي:

حساب عتبة الري (Irrigation Threshold): لكل نوع محصول، يتم تحديد مستوى رطوبة التربة الأدنى الذي يجب عدم النزول عنه.

معادلة توازن المياه:
الرطوبة_المتوقعة = الرطوبة_الحالية - التبخر_المتوقع + هطول_الأمطار_المتوقع

توليد التوصية:

إذا كانت الرطوبة_المتوقعة أقل من عتبة_الري، يتم إنشاء توصية بالري.

كمية المياه: يتم حسابها لرفع مستوى الرطوبة من القيمة المتوقعة إلى "السعة الحقلية" (Field Capacity) للتربة. تُحوَّل هذه الكمية إلى لتر/م².

توقيت الري: يتم تحديد التوقيت الأمثل بناءً

على عوامل مثل تجنب الري أثناء درجات الحرارة المرتفعة لتقليل التبخر.

الخطوة 2: التنفيذ الفني (قاعدة البيانات ونقطة النهاية)
تصميم مخطط قاعدة البيانات (Schema) في Supabase:

أنشئ جدولًا جديدًا باسم irrigation_recommendations. 
Google Mail icon
 


تصميم الجدول:

id: uuid (مفتاح أساسي).

field_id: uuid (مفتاح خارجي مرتبط بجدول fields).

recommendation_date: date (تاريخ التوصية).

water_amount: float (كمية المياه الموصى بها باللتر/م²).

timing: timestamp (الوقت الموصى به للري).

status: text (حالة التوصية: 'pending', 'completed', 'skipped').

تصميم نقطة النهاية (API Endpoint):

يمكن إنشاء نقطة النهاية باستخدام دالة سحابية (Edge Function) أخرى في Supabase.

الدالة get-irrigation-recommendations:

تستقبل field_id كمدخل.

تستعلم عن آخر التوصيات من جدول irrigation_recommendations للحقل المحدد.

تقوم بإرجاع البيانات إلى الواجهة الأمامية ليتم عرضها للمستخدم.

أتمتة العملية: يمكن جدولة دالة سحابية (Cron Job) لتعمل يوميًا، تقوم بتنفيذ الخوارزمية الحسابية وتخزين التوصيات الجديدة في قاعدة البيانات لجميع الحقول.

3. نموذج تشخيص أمراض النباتات بالذكاء الاصطناعي
تتضمن هذه الوحدة تطوير نموذج تعلم عميق لتشخيص أمراض النباتات من خلال الصور التي يلتقطها المستخدم. 
Google Drive icon
 


الخطوة 1: دورة حياة النموذج - جمع وتجهيز البيانات
جمع البيانات:

المصادر: الاعتماد على قواعد بيانات الصور المفتوحة المصدر لأمراض النباتات (مثل PlantVillage).

البيانات الخاصة: جمع صور من المزارعين في المنطقة المستهدفة (مصر والشرق الأوسط) لضمان أن النموذج فعال مع الأمراض والسلالات المحلية. 
Google Drive icon
 
Google Drive icon

تجهيز البيانات:

التصنيف والتسمية (Labeling): تصنيف كل صورة حسب نوع النبات والمرض (أو "سليم").

زيادة البيانات (Data Augmentation): تطبيق تقنيات مثل التدوير، القص، تغيير السطوع، والقلب لزيادة حجم وتنوع مجموعة البيانات، مما يساعد على منع "فرط التخصيص" (Overfitting).

الخطوة 2: بنية النموذج والتدريب
مقارنة معماريات الشبكات العصبية الالتفافية (CNN):

ResNet (Residual Networks): ممتازة للمهام التي تتطلب عمقًا كبيرًا في الشبكة، وتساعد في تجنب مشكلة "تلاشي التدرج" (Vanishing Gradient).

EfficientNet: توفر توازنًا ممتازًا بين الدقة والكفاءة الحسابية، مما يجعلها مثالية للنشر على الأجهزة المحمولة أو ذات الموارد المحدودة.

الاختيار: يُفضل البدء بـ EfficientNet لكفاءتها، مع إمكانية تجربة ResNet إذا كانت الدقة هي الأولوية القصوى. 
Google Mail icon
 


التعلم النقلي (Transfer Learning):

استخدم نموذجًا مُدربًا مسبقًا (Pre-trained) على مجموعة بيانات ضخمة مثل ImageNet.

قم "بتجميد" (Freeze) الطبقات الأولية من النموذج (التي تعلمت التعرف على الميزات الأساسية مثل الحواف والألوان) وقم بتدريب الطبقات النهائية فقط على مجموعة بيانات أمراض النباتات الخاصة بك. هذا يسرع التدريب بشكل كبير ويحسن الدقة. 
Google Mail icon
 


عملية التدريب والتحقق:

تقسيم البيانات: قسّم مجموعة البيانات إلى ثلاثة أجزاء: تدريب (Training)، تحقق (Validation)، واختبار (Testing).

التدريب: استخدم أطر عمل مثل PyTorch أو TensorFlow لتدريب النموذج. راقب مقاييس مثل الدقة (Accuracy) والخسارة (Loss) على مجموعة التحقق لضبط المعلمات الفائقة (Hyperparameters).

الخطوة 3: نشر النموذج والاستخدام (Deployment)
ضغط النموذج (Model Compression):

لجعل النموذج أسرع وأصغر حجمًا، استخدم تقنيات مثل:

التكميم (Quantization): تقليل دقة الأوزان (e.g., from 32-bit float to 8-bit integer).

التقليم (Pruning): إزالة الأوزان غير الضرورية من الشبكة.

تحويل النموذج: قم بتحويل النموذج إلى تنسيقات محسّنة للاستدلال (Inference) مثل ONNX أو TensorFlow Lite (TFLite). 
Google Mail icon
 


النشر كواجهة برمجة تطبيقات (API):

قم بنشر النموذج المضغوط كـ API قابل للتطوير. 
Google Mail icon
 


الخيار أ (Serverless): استخدم خدمات مثل Google Cloud Functions أو AWS Lambda. هذا الخيار فعال من حيث التكلفة وقابل للتطوير تلقائيًا.

الخيار ب (Managed Service): استخدم Google AI Platform أو Amazon SageMaker لتبسيط عملية النشر وإدارة الإصدارات.

التكامل مع Supabase: يمكن استدعاء هذا الـ API من داخل دالة سحابية في Supabase، والتي بدورها تخدم "المساعد الزراعي الذكي" في تطبيقك.
بناءً على طلبك، إليك خطة تنفيذية تقنية مفصلة، خطوة بخطوة، لتطوير الميزات الأساسية لمنصة Adham AgriTech، مع التركيز على التكامل بين التقنيات المحددة.

ملخص الخطة التقنية
تعتمد هذه الخطة على بنية حديثة قابلة للتطوير باستخدام Next.js للواجهة الأمامية لتقديم تجربة مستخدم سريعة وتفاعلية، وSupabase كواجهة خلفية متكاملة (قاعدة بيانات، مصادقة، دوال سحابية)، مع الاستفادة من خدمات خارجية متخصصة مثل Mapbox للخرائط و EOSDA لصور الأقمار الصناعية.

1. وحدة إدارة الحقول وتحليل صور الأقمار الصناعية
تهدف هذه الوحدة إلى تمكين المستخدمين من تحديد حقولهم الزراعية على خريطة تفاعلية والحصول على تحليلات متقدمة لصحة النباتات باستخدام مؤشر NDVI.

أ. الواجهة الأمامية (Next.js و Mapbox GL): بناء واجهة الخرائط
إعداد المكتبات:

قم بتثبيت مكتبات Mapbox في مشروع Next.js: react-map-gl (للتكامل مع React) و mapbox-gl-draw (لرسم المضلعات).

npm install react-map-gl mapbox-gl @mapbox/mapbox-gl-draw

استورد ملفات CSS اللازمة لـ Mapbox و-Mapbox Draw في المكون الرئيسي للخريطة لضمان عرضها بشكل صحيح.

عرض الخريطة التفاعلية:

أنشئ مكون React جديد (مثلاً MapComponent.js).

استخدم react-map-gl لعرض الخريطة، مع تمرير مفتاح الوصول (Access Token) الخاص بك من Mapbox كمتغير بيئة (process.env.NEXT_PUBLIC_MAPBOX_TOKEN). 

اضبط الخصائص الأولية للخريطة مثل (خط الطول، دائرة العرض، ومستوى التكبير/التصغير).

تفعيل أدوات الرسم والتعديل:

استخدم mapbox-gl-draw لإضافة أدوات التحكم بالرسم على الخريطة (رسم مضلع، حذف، تعديل). 

عندما يقوم المستخدم بإنشاء أو تعديل مضلع، تقوم أداة الرسم بإطلاق أحداث (events) مثل draw.create و draw.update.

استمع لهذه الأحداث للحصول على بيانات المضلع الجغرافية (بصيغة GeoJSON) وتخزينها في حالة (state) المكون باستخدام useState.

حفظ بيانات الحقل:

بعد أن ينتهي المستخدم من رسم الحقل، أضف زر "حفظ الحقل".

عند النقر على الزر، قم بإرسال بيانات GeoJSON الخاصة بالمضلع مع اسم الحقل وأي بيانات وصفية أخرى إلى الواجهة الخلفية (Supabase) عبر استدعاء API.

ب. قاعدة البيانات (Supabase PostgreSQL و PostGIS): تخزين البيانات الجغرافية
تفعيل امتداد PostGIS:

من لوحة تحكم مشروع Supabase، انتقل إلى قسم "Database" ثم "Extensions".

ابحث عن postgis وقم بتفعيله. هذه الخطوة تضيف أنواع بيانات ودوال جغرافية متخصصة إلى قاعدة بيانات PostgreSQL الخاصة بك. 
 

تصميم جدول الحقول (fields):

استخدم محرر SQL في Supabase لإنشاء جدول لتخزين معلومات الحقول. التصميم الأمثل يشمل:

id: مفتاح أساسي (UUID أو auto-incrementing integer).

user_id: لربط الحقل بالمستخدم (Foreign Key).

name: اسم الحقل (TEXT).

area_sqm: مساحة الحقل (NUMERIC)، يمكن حسابها لاحقًا.

location: العمود الجغرافي، وهو الأهم. استخدم نوع البيانات geography(Polygon, 4326). 

geography: نوع بيانات محسن للحسابات على سطح كروي (الأرض).

Polygon: يحدد أن الشكل الهندسي هو مضلع.

4326: هو رمز SRID القياسي لنظام تحديد المواقع العالمي (WGS 84)، وهو ما تستخدمه معظم خدمات الخرائط. 

SQL
CREATE TABLE public.fields (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  location GEOGRAPHY(POLYGON, 4326) NOT NULL
);
إنشاء فهرس مكاني (Spatial Index):

لضمان سرعة الاستعلامات الجغرافية (مثل البحث عن الحقول المتقاطعة)، قم بإنشاء فهرس من نوع GIST على عمود location. 

SQL
CREATE INDEX fields_geo_index ON public.fields USING GIST (location);
ج. المنطق الخلفي (Supabase Edge Function): جلب صور NDVI
إنشاء الدالة السحابية:

استخدم Supabase CLI لإنشاء دالة سحابية جديدة (مثلاً get-ndvi-for-field). 
 

الدوال السحابية في Supabase هي دوال TypeScript/Deno تعمل على الحافة (Edge)، مما يضمن استجابة سريعة. 

كتابة منطق الدالة:

المدخلات: تستقبل الدالة طلبًا من نوع POST يحتوي على field_id.

المصادقة: تتحقق الدالة من هوية المستخدم باستخدام JWT token لضمان أن المستخدم يطلب بيانات حقله فقط. 

الاستعلام عن قاعدة البيانات: تستخدم الدالة عميل Supabase (supabase-js) للاستعلام عن جدول fields لجلب حدود الحقل (location) بناءً على field_id المدخل.

التواصل مع EOSDA API:

تستخدم الدالة fetch لإرسال طلب إلى EOSDA API.

يتم تمرير حدود الحقل (بصيغة GeoJSON) في جسم الطلب لتحديد المنطقة المطلوبة.

يتم تخزين مفتاح EOSDA API بشكل آمن كـ "secret" في Supabase، ولا يتم كشفه للعميل أبدًا. 

المخرجات: تعيد الدالة استجابة EOSDA API (التي قد تحتوي على رابط لصورة NDVI بصيغة GeoTIFF أو PNG) إلى الواجهة الأمامية.

د. عرض البيانات (NDVI Layer):
استدعاء الدالة: في الواجهة الأمامية، عندما يختار المستخدم حقلاً، يتم استدعاء الدالة السحابية get-ndvi-for-field مع معرّف الحقل.

معالجة الاستجابة: تستقبل الواجهة الأمامية الرابط أو البيانات الصورية لمؤشر NDVI.

إضافة طبقة NDVI على الخريطة:

استخدم وظائف Mapbox GL JS لإضافة مصدر بيانات جديد من نوع raster أو image.

أضف طبقة جديدة (layer) تستخدم هذا المصدر لعرض صورة NDVI فوق مضلع الحقل المحدد.

إضافة مفتاح لوني (Legend):

أنشئ مكون React بسيط يعرض تدرجًا لونيًا من الأحمر إلى الأخضر.

أضف تسميات توضيحية تشرح ما تمثله قيم NDVI المختلفة (مثلاً: -1 إلى 0: مياه/صخور، 0.2-0.5: نباتات مجهدة، 0.6-1: نباتات صحية).

2. وحدة الري الذكي (Smart Irrigation)
تهدف هذه الوحدة إلى تقديم توصيات دقيقة لكمية وتوقيت الري بناءً على دمج بيانات الأقمار الصناعية والتنبؤات الجوية.

أ. التصميم الخوارزمي للمنطق الحسابي:
يهدف النموذج إلى تحقيق التوازن المائي في التربة. يمكن تبسيط المعادلة الأساسية كالتالي:

كمية الري المطلوبة = (التبخر-نتح المحصولي "ETc") - (الأمطار الفعالة "P_eff") + (النقص المائي الحالي)

تقدير رطوبة التربة (Soil Moisture Proxy):

يتم الحصول على بيانات صور الأقمار الصناعية Sentinel-2. 

يتم حساب مؤشرات مثل مؤشر فرق المياه المعياري (NDWI) أو مؤشرات أخرى حساسة للرطوبة باستخدام النطاقات الطيفية مثل SWIR (الأشعة تحت الحمراء قصيرة الموجة) و NIR (الأشعة تحت الحمراء القريبة). 
 

هذه المؤشرات لا تعطي قيمة مطلقة لرطوبة التربة، ولكنها تعمل كبديل (proxy) قوي لتحديد المناطق الأكثر جفافاً أو رطوبة داخل الحقل.

دمج بيانات التنبؤات الجوية:

استخدام واجهة برمجة تطبيقات (API) للطقس (مثل OpenWeatherMap, AccuWeather) لجلب بيانات التنبؤات للأيام القادمة لموقع الحقل الجغرافي.

البيانات الأساسية المطلوبة هي:

هطول الأمطار المتوقع (P): بالمليمتر.

التبخر-النتح المرجعي (ETo): وهو مقدار تبخر المياه من سطح مرجعي. بعض خدمات الطقس توفر هذه القيمة مباشرة، أو يمكن حسابها باستخدام معادلة Penman-Monteith القياسية لمنظمة الأغذية والزراعة (FAO) إذا توفرت بيانات درجة الحرارة، الرطوبة، سرعة الرياح، والإشعاع الشمسي. 

توليد التوصية:

حساب التبخر-النتح المحصولي (ETc): ETc = ETo * Kc. حيث Kc هو "معامل المحصول" الذي يختلف باختلاف نوع النبات ومرحلة نموه (يمكن للمستخدم إدخاله).

الخوارزمية:

تقوم دالة مجدولة (Scheduled Function) بالعمل يوميًا.

تجلب أحدث قيمة لمؤشر رطوبة التربة (NDWI) من القمر الصناعي.

تجلب بيانات الطقس المتوقعة للأيام 2-3 القادمة (ETc والأمطار).

إذا كان مؤشر الرطوبة أقل من عتبة محددة مسبقًا، وإذا كان صافي فقدان المياه المتوقع (ETc - P) إيجابيًا، فإن النظام يوصي بالري.

كمية المياه: يتم حسابها بناءً على مقدار النقص المائي لتحقيق "السعة الحقلية" المثلى. على سبيل المثال، إذا كان التبخر-النتح اليومي 5 مم، ولا يوجد أمطار، فإن التوصية تكون 5 مم، وهو ما يعادل 5 لتر/م².

التوقيت: يوصى دائمًا بالري في الصباح الباكر أو في وقت متأخر من المساء لتقليل الفقد بالتبخر.

ب. التنفيذ الفني (Supabase Schema & API):
تصميم مخطط قاعدة البيانات (irrigation_recommendations):

أنشئ جدولًا لتخزين سجل التوصيات:

SQL
CREATE TABLE public.irrigation_recommendations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  field_id UUID REFERENCES public.fields(id) ON DELETE CASCADE,
  recommendation_date DATE NOT NULL,
  water_amount_l_m2 NUMERIC(5, 2) NOT NULL, -- كمية المياه باللتر/م²
  timing_recommendation TEXT, -- e.g., "Early Morning"
  generated_at TIMESTAMPTZ DEFAULT now(),
  data_source JSONB -- لتخزين البيانات التي بنيت عليها التوصية (NDWI, ETo, etc.)
);
تصميم نقطة النهاية (API Endpoint):

يمكن إنشاء دالة PostgreSQL (RPC) لجلب آخر توصية لحقل معين، والتي يتم استدعاؤها بسهولة من الواجهة الأمامية.

SQL
CREATE OR REPLACE FUNCTION get_latest_recommendation(p_field_id UUID)
RETURNS SETOF irrigation_recommendations AS $$
BEGIN
  RETURN QUERY
  SELECT *
  FROM public.irrigation_recommendations
  WHERE field_id = p_field_id
  ORDER BY recommendation_date DESC
  LIMIT 1;
END;
$$ LANGUAGE plpgsql;
يمكن استدعاء هذه الدالة من Next.js باستخدام: supabase.rpc('get_latest_recommendation', { p_field_id: '...' }).

3. نموذج تشخيص أمراض النباتات بالذكاء الاصطناعي
يهدف هذا النموذج إلى تمكين المستخدم من التقاط صورة لورقة نبات والحصول على تشخيص فوري للمرض المحتمل.

أ. دورة حياة النموذج: جمع وتجهيز البيانات
جمع البيانات:

البدء بمجموعات البيانات المفتوحة والمشهورة مثل PlantVillage، التي تحتوي على عشرات الآلاف من الصور المصنفة لأوراق نباتات صحية ومريضة. 

تجهيز البيانات (Preprocessing):

توحيد حجم الصور: تغيير حجم جميع الصور إلى أبعاد موحدة (مثل 224x224 بكسل) لتناسب مدخلات الشبكات العصبية.

التطبيع (Normalization): تحويل قيم البكسل من نطاق 
 إلى 
 لتحسين استقرار عملية التدريب.

زيادة البيانات (Data Augmentation):

هذه خطوة حاسمة لزيادة حجم وتنوع مجموعة التدريب ومنع الحفظ الزائد (Overfitting). 
 

تطبيق تحويلات عشوائية على صور التدريب مثل: الدوران (Rotation)، القص (Shear)، التكبير/التصغير (Zoom)، القلب الأفقي (Horizontal Flip)، وتغيير السطوع والتباين.

ب. بنية النموذج والتدريب
مقارنة معماريات CNN:

ResNet (Residual Networks): معمارية قوية ومُثبتة، تتميز بقدرتها على تدريب شبكات عميقة جدًا بفضل "الوصلات المتبقية" (Residual Connections) التي تتجنب مشكلة تلاشي التدرج. 
 

EfficientNet: معمارية أحدث تركز على تحقيق توازن مثالي بين الدقة والكفاءة الحاسوبية (عدد المعلمات والعمليات الحسابية). 
 تستخدم طريقة "التحجيم المركب" (Compound Scaling) لزيادة عمق وعرض ودقة الشبكة بشكل متوازن.

التوصية: EfficientNet هو الخيار المفضل لهذا المشروع، حيث يوفر دقة عالية مع حجم نموذج أصغر، مما يجعله أسرع في الاستدلال وأكثر ملاءمة للنشر كـ API أو حتى على الأجهزة المحمولة في المستقبل. 
 

التعلم النقلي (Transfer Learning):

بدلاً من تدريب النموذج من الصفر، يتم استخدام نموذج EfficientNet مُسبَق التدريب على مجموعة بيانات ضخمة مثل ImageNet.

يتم "تجميد" الطبقات الأولى من النموذج (التي تعلمت التعرف على الميزات العامة مثل الحواف والألوان) واستبدال الطبقة الأخيرة فقط (طبقة التصنيف) بطبقة جديدة تتناسب مع عدد فئات أمراض النباتات لدينا.

يتم بعد ذلك "صقل" (Fine-tuning) النموذج عن طريق تدريب كل الطبقات (أو جزء منها) بمعدل تعلم منخفض جدًا على مجموعة بيانات أمراض النباتات. هذه التقنية تسرّع التدريب بشكل كبير وتحقق دقة أعلى. 

عملية التدريب والتحقق:

تقسيم البيانات: تقسيم مجموعة البيانات إلى 3 أجزاء: تدريب (80%)، تحقق (10%)، واختبار (10%).

التدريب: يتم تدريب النموذج على مجموعة التدريب.

التحقق: بعد كل حقبة تدريب (epoch)، يتم تقييم أداء النموذج على مجموعة التحقق. يساعد هذا في مراقبة الأداء على البيانات الجديدة وضبط المعلمات (Hyperparameters) وتحديد نقطة التوقف المثلى للتدريب لتجنب الحفظ الزائد.

الاختبار: بعد انتهاء التدريب تمامًا، يتم تقييم النموذج مرة واحدة على مجموعة الاختبار لتقدير دقته النهائية على بيانات لم يرها من قبل.

ج. النشر والاستخدام (Deployment)
ضغط النموذج (Model Compression):

قبل النشر، يمكن تحسين النموذج لتقليل حجمه وزيادة سرعة الاستدلال. تقنيات مثل التكميم (Quantization) (تقليل دقة الأوزان) فعالة جدًا. يمكن استخدام أدوات مثل TensorFlow Lite لهذا الغرض. 

النشر كـ API قابلة للتطوير:

التغليف (Containerization): يتم تغليف النموذج مع خادم ويب خفيف (مثل FastAPI أو Flask) في حاوية Docker. 
 يوفر FastAPI واجهة سهلة لإنشاء نقاط نهاية API ويقوم تلقائيًا بإنشاء وثائق تفاعلية (Swagger UI).

الاستضافة (Hosting):

الخيار الموصى به: نشر حاوية Docker على خدمة سحابية "بلا خوادم" (Serverless) مثل Google Cloud Run أو AWS Lambda. 
 
Google Mail icon
 هذه الخدمات قابلة للتطوير تلقائيًا (تزيد أو تنقص الموارد حسب الطلب) وتعتمد على الدفع حسب الاستخدام، مما يجعلها فعالة من حيث التكلفة.

نقطة النهاية (Endpoint): ستقوم الخدمة السحابية بتوفير رابط URL لنقطة النهاية (API Endpoint).

الاستخدام من قبل المساعد الزراعي:

يقوم تطبيق Adham AgriTech (الواجهة الأمامية) بإرسال الصورة التي يلتقطها المستخدم إلى هذا الـ API Endpoint.

يقوم الـ API بتشغيل النموذج، والحصول على التنبؤ.

يعيد الـ API استجابة بصيغة JSON تحتوي على اسم المرض المتوقع، درجة الثقة (Confidence Score)، وربما معلومات إضافية عن المرض.
بالتأكيد، إليك خطة تنفيذية تقنية مفصلة وشاملة، خطوة بخطوة، لتطوير الميزات الأساسية لمنصة Adham AgriTech، مع التركيز على التكامل بين الواجهة الأمامية (Next.js)، الواجهة الخلفية (Supabase)، والخدمات الخارجية.

1. وحدة إدارة الحقول وتحليل صور الأقمار الصناعية
هذه الوحدة هي حجر الزاوية في المنصة، حيث تتيح للمزارعين تصور حقولهم ومراقبة صحة محاصيلهم.

أ. الواجهة الأمامية: بناء واجهة خرائط تفاعلية (Next.js و Mapbox GL)
إعداد المشروع:

ابدأ مشروع Next.js جديد.

قم بتثبيت مكتبات Mapbox: mapbox-gl و react-map-gl (مكتبة مساعدة لتسهيل تكامل Mapbox مع React). 
Google Mail icon

قم بتثبيت مكتبة أدوات الرسم: mapbox-gl-draw.

بناء مكون الخريطة:

أنشئ مكون React جديد (مثلاً MapComponent.js).

في هذا المكون، استخدم react-map-gl لتهيئة الخريطة. ستحتاج إلى مفتاح وصول (Access Token) من حسابك في Mapbox.

اضبط إعدادات الخريطة الأولية مثل (خط الطول، دائرة العرض، مستوى التكبير/التصغير، ونمط الخريطة).

تفعيل أدوات الرسم والتعديل:

استخدم mapbox-gl-draw لإضافة واجهة تحكم للرسم على الخريطة.

قم بتهيئة MapboxDraw مع خيارات تسمح للمستخدم برسم المضلعات (Polygons) وتعديلها وحذفها.

استمع إلى أحداث الرسم (draw.create, draw.update, draw.delete) للحصول على البيانات الجغرافية (بصيغة GeoJSON) للمضلع الذي يرسمه المستخدم.

إدارة بيانات الحقول:

عندما ينتهي المستخدم من رسم حقل، قم بتخزين بيانات GeoJSON في حالة (State) المكون.

اعرض زر "حفظ الحقل". عند النقر عليه، أرسل بيانات GeoJSON مع اسم الحقل وبيانات المستخدم الأخرى إلى الواجهة الخلفية (Supabase) عبر استدعاء API.

ب. قاعدة البيانات: تصميم جدول الحقول في Supabase (PostgreSQL + PostGIS)
تفعيل امتداد PostGIS:

من لوحة تحكم مشروعك في Supabase، انتقل إلى قسم "Database" ثم "Extensions".

ابحث عن postgis وقم بتفعيله. هذا الامتداد يضيف دوال وأنواع بيانات جغرافية إلى قاعدة بيانات PostgreSQL.

تصميم جدول الحقول (fields):

أنشئ جدولاً جديداً باستخدام محرر SQL في Supabase. التصميم الأمثل سيشمل:

id: uuid (معرّف فريد، المفتاح الأساسي).

user_id: uuid (لربط الحقل بالمستخدم، مع تفعيل RLS لضمان الخصوصية). 
Google Mail icon

name: text (اسم الحقل الذي يحدده المستخدم).

area_sqm: float8 (مساحة الحقل، يمكن حسابها لاحقًا).

geometry: geometry(Polygon, 4326) لتخزين حدود الحقل. 4326 هو الرمز القياسي لنظام الإحداثيات العالمي (WGS 84).

SQL
-- SQL لإنشاء الجدول
CREATE TABLE public.fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) NOT NULL,
    name TEXT NOT NULL,
    area_sqm DOUBLE PRECISION,
    geometry GEOMETRY(Polygon, 4326) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
);
-- إنشاء فهرس مكاني لتسريع الاستعلامات الجغرافية
CREATE INDEX fields_geometry_idx ON public.fields USING GIST (geometry);
ج. المنطق الخلفي: دالة سحابية لجلب صور NDVI (Supabase Edge Function)
إنشاء الدالة السحابية:

استخدم Supabase CLI لإنشاء دالة سحابية جديدة (Edge Function) باسم get-ndvi-image. 
Google Mail icon
 
Google Mail icon

ستكون هذه الدالة مكتوبة بلغة TypeScript/JavaScript وتعمل على بيئة Deno.

كتابة منطق الدالة:

استقبال الطلب: ستستقبل الدالة طلب POST يحتوي على field_id.

التحقق من المستخدم: تأكد من أن المستخدم الذي أرسل الطلب هو مالك الحقل.

الاستعلام عن حدود الحقل: استخدم Supabase Client API داخل الدالة للاستعلام عن جدول fields وجلب geometry للحقل المحدد.

التواصل مع EOSDA API:

قم بتحويل geometry إلى صيغة GeoJSON.

استخدم fetch لإرسال طلب إلى EOSDA API. الطلب سيحتوي على مضلع GeoJSON ومفتاح API الخاص بك (المخزّن بأمان في Supabase Secrets).

اطلب صورة NDVI للمنطقة المحددة.

إرجاع الاستجابة: ستقوم الدالة بإرجاع الرابط المؤقت لصورة NDVI الناتجة أو البيانات نفسها إلى الواجهة الأمامية.

د. عرض البيانات: عرض طبقة NDVI على الخريطة
استدعاء الدالة السحابية: في الواجهة الأمامية، بعد أن يختار المستخدم حقلاً، قم باستدعاء الدالة get-ndvi-image مع field_id.

إضافة طبقة NDVI:

عند استلام رابط صورة NDVI من الدالة، استخدم map.addSource في Mapbox لإضافة مصدر صورة جديد (type: image)، مع تحديد إحداثيات أركان الصورة لتطابق حدود الحقل.

استخدم map.addLayer لإضافة طبقة من نوع raster فوق الحقل لعرض الصورة.

عرض المفتاح اللوني (Legend):

أنشئ مكون React بسيط يعرض تدرجاً لونياً (من الأحمر إلى الأخضر).

أضف تسميات توضح ما يمثله كل لون (مثال: -1 إلى 0: مياه/صخور، 0.1 إلى 0.3: نباتات مجهدة، 0.6 إلى 1: نباتات صحية).

2. وحدة الري الذكي (Smart Irrigation)
تهدف هذه الوحدة إلى تقديم توصيات دقيقة للري بناءً على بيانات متكاملة.

أ. التصميم الخوارزمي للمنطق الحسابي
جمع البيانات:

رطوبة التربة: احصل على بيانات رطوبة التربة (Soil Moisture) المستنبطة من صور الأقمار الصناعية مثل Sentinel-2. يمكن الحصول على هذه البيانات عبر واجهات برمجة التطبيقات المتخصصة في الزراعة (مثل EOSDA أو غيرها).

بيانات التنبؤات الجوية: استخدم واجهة برمجة تطبيقات للطقس (مثل OpenWeatherMap API أو Google Weather API) لجلب بيانات دقيقة لموقع الحقل خلال الـ 24-48 ساعة القادمة، وتشمل: درجة الحرارة، الرطوبة النسبية، سرعة الرياح، واحتمالية هطول الأمطار وكميتها المتوقعة. 
Google Mail icon

النمذجة الحسابية:

حساب التبخر والنتح (Evapotranspiration - ETc):

استخدم معادلة "Penman-Monteith" القياسية، وهي الأكثر دقة، لحساب معدل التبخر والنتح المرجعي (ET₀). تتطلب هذه المعادلة بيانات (درجة الحرارة، رطوبة، سرعة الرياح، الإشعاع الشمسي).

اضرب ET₀ في معامل المحصول (Kc) الخاص بنوع النبات ومرحلة نموه للحصول على ETc (التبخر-النتح الفعلي للمحصول).

تحديد الحاجة للري:

صافي الحاجة للماء = ETc - الأمطار المتوقعة

حساب كمية الري:

كمية المياه (لتر/م²) = (عتبة استنزاف الرطوبة المسموح بها - رطوبة التربة الحالية) * عمق منطقة الجذور الفعالة

تُستخدم "صافي الحاجة للماء" كعامل تعديل يومي.

تحديد توقيت الري: أفضل وقت للري هو في الصباح الباكر لتقليل الفقد بالتبخر.

توليد التوصية:

يتم تشغيل هذه الخوارزمية بشكل دوري (مثلاً، كل 24 ساعة).

النتيجة النهائية تكون توصية واضحة: "قم بري الحقل بكمية X لتر/م² في الساعة Y صباحًا".

ب. التنفيذ الفني (قاعدة البيانات و API)
تصميم مخطط قاعدة البيانات في Supabase:

أنشئ جدولاً جديداً باسم irrigation_recommendations:

id: uuid (المفتاح الأساسي).

field_id: uuid (يرتبط بجدول fields).

recommendation_date: date (تاريخ التوصية).

recommended_liters_per_sqm: float8 (كمية المياه الموصى بها).

recommended_timing: text (مثال: "5:00 AM - 7:00 AM").

status: text (مثال: "pending", "applied", "skipped").

calculation_inputs: jsonb (لتخزين نسخة من البيانات التي استُخدمت في الحساب، مثل بيانات الطقس ورطوبة التربة، لأغراض التتبع والتحليل).

تصميم نقطة النهاية (API Endpoint):

أنشئ دالة سحابية (Edge Function) باسم get-irrigation-recommendation. 
Google Mail icon
 


عند استدعائها مع field_id، ستقوم الدالة بالاستعلام عن جدول irrigation_recommendations لجلب أحدث توصية متاحة لهذا الحقل.

يمكن إعداد دالة أخرى تعمل بشكل مجدول (Scheduled Function) لتنفيذ الخوارزمية الحسابية يوميًا وتعبئة جدول التوصيات.

3. نموذج تشخيص أمراض النباتات بالذكاء الاصطناعي
هذه الميزة ستمكّن المزارعين من تشخيص الأمراض بسرعة عبر التقاط صورة للنبات المصاب. 
Google Drive icon
 
Google Drive icon

أ. دورة حياة النموذج: جمع وتجهيز البيانات
جمع البيانات:

المصادر: ابدأ بمجموعات البيانات المفتوحة المصدر مثل PlantVillage التي تحتوي على آلاف الصور المصنفة لأوراق نباتات مختلفة وأمراضها.

البيانات الخاصة: اسمح للمستخدمين بتحميل صور وملاحظات، وبعد التحقق منها من قبل خبراء، يمكن إضافتها إلى مجموعة البيانات لتحسين النموذج باستمرار.

تجهيز البيانات (Preprocessing):

توحيد حجم الصور: قم بتغيير حجم جميع الصور إلى أبعاد ثابتة (مثال: 224x224 بكسل) لتناسب مدخلات الشبكات العصبية.

المعايرة (Normalization): قم بمعايرة قيم البكسل (عادةً إلى نطاق بين 0 و 1) لتسريع عملية التدريب.

زيادة البيانات (Data Augmentation): طبّق تحويلات عشوائية على صور التدريب (مثل الدوران، القص، تغيير السطوع، القلب الأفقي) لزيادة تنوع البيانات وتقليل فرصة فرط الملاءمة (Overfitting).

ب. بنية النموذج والتدريب (CNNs و Transfer Learning)
مقارنة المعمارايات:

ResNet (Residual Networks): معمارية قوية وموثوقة، تتميز بقدرتها على تدريب شبكات عميقة جدًا بفضل "الوصلات المتبقية" (Residual Connections). تعد نقطة انطلاق ممتازة.

EfficientNet: معمارية حديثة توفر توازنًا ممتازًا بين الدقة والكفاءة الحسابية. تقوم بضبط عمق وعرض ودقة الشبكة بشكل متوازن، مما يجعلها خيارًا مثاليًا للنشر على الأجهزة ذات الموارد المحدودة. EfficientNet غالبًا ما يكون الخيار الأفضل هنا.

التعلم النقلي (Transfer Learning):

بدلاً من تدريب النموذج من الصفر، استخدم نموذجًا (مثل EfficientNet) مُدربًا مسبقًا على مجموعة بيانات ضخمة (مثل ImageNet).

"جمّد" جميع طبقات النموذج ما عدا الطبقات الأخيرة.

استبدل الطبقة النهائية (Classifier) بطبقة جديدة تتناسب مع عدد فئات الأمراض التي تريد تشخيصها.

قم بتدريب الطبقات الجديدة فقط على مجموعة بيانات أمراض النبات. هذه التقنية تسرّع التدريب بشكل كبير وتتطلب بيانات أقل.

عملية التدريب والتحقق:

قسّم البيانات إلى 3 مجموعات: تدريب (70%)، تحقق (15%)، واختبار (15%).

درّب النموذج على مجموعة التدريب، واستخدم مجموعة التحقق لتقييم أدائه بعد كل حقبة (Epoch) وضبط المعلمات الفائقة (Hyperparameters).

بعد انتهاء التدريب، استخدم مجموعة الاختبار (التي لم يرها النموذج من قبل) لتقييم الأداء النهائي للنموذج.

ج. النشر والاستخدام (Model Deployment)
ضغط النموذج (Model Compression):

التكميم (Quantization): قم بتحويل أوزان النموذج من أعداد عشرية 32-بت (FP32) إلى أعداد صحيحة 8-بت (INT8). هذا يقلل حجم النموذج بما يصل إلى 4 مرات ويسرّع الاستدلال (Inference) بشكل ملحوظ مع فقدان طفيف في الدقة.

التقليم (Pruning): إزالة الوصلات غير الضرورية في الشبكة العصبية.

استخدم أدوات مثل TensorFlow Lite لإجراء هذه التحسينات.

النشر كواجهة برمجة تطبيقات (API): 
Google Drive icon
 


الخيار الأول (الموصى به): انشر النموذج المضغوط على خدمة سحابية قابلة للتطوير مثل Google Cloud Run أو AWS Lambda.

قم بإنشاء حاوية Docker تحتوي على النموذج ورمز Python (باستخدام إطار عمل ويب خفيف مثل Flask أو FastAPI).

ستستقبل واجهة برمجة التطبيقات طلب POST يحتوي على صورة.

يقوم الخادم بمعالجة الصورة، تشغيل النموذج، وإرجاع اسم المرض المتوقع ونسبة الثقة بصيغة JSON.

الخيار الثاني (لنماذج صغيرة جدًا): إذا كان النموذج ومتطلباته صغيرة بما يكفي، يمكن نظريًا نشره كدالة Supabase Edge Function، لكن هذا الخيار محدود حاليًا بإمكانيات بيئة Deno.

الاستهلاك من قبل المساعد الذكي:

يقوم تطبيق الجوال أو الويب بإرسال الصورة الملتقطة إلى نقطة النهاية (API Endpoint) الخاصة بالنموذج.

تستقبل الواجهة الأمامية الاستجابة (JSON) وتعرض النتيجة للمستخدم بطريقة سهلة الفهم، مع اقتراح خطوات تالية محتملة.
بالتأكيد، إليك خطة تنفيذية تقنية مفصلة خطوة بخطوة لتطوير الميزات الأساسية لمنصة Adham AgriTech، مع شرح التكامل بين التقنيات المحددة.

ملخص المكدس التقني (Tech Stack):
الواجهة الأمامية (Frontend): Next.js (React Framework)

الواجهة الخلفية وقاعدة البيانات (Backend & DB): Supabase (PostgreSQL with PostGIS, Edge Functions)

خدمات الخرائط (Mapping Services): Mapbox GL JS

بيانات الأقمار الصناعية (Satellite Data): EOSDA API

الذكاء الاصطناعي (AI): Python, PyTorch/TensorFlow, Hugging Face/Cloud Run (للنشر)

1. وحدة إدارة الحقول وتحليل صور الأقمار الصناعية
الهدف هو تمكين المزارعين من تحديد حقولهم على خريطة تفاعلية والحصول على تحليلات صحة النبات (NDVI).

أ. الواجهة الأمامية (Next.js & Mapbox GL): واجهة الخرائط التفاعلية
إعداد المشروع:

ابدأ مشروع Next.js جديد: npx create-next-app@latest adham-agritech

ثبّت مكتبات Mapbox: npm install mapbox-gl mapbox-gl-draw

أضف مفتاح الوصول (Access Token) الخاص بـ Mapbox إلى متغيرات البيئة (.env.local) كـ NEXT_PUBLIC_MAPBOX_TOKEN.

إنشاء مكون الخريطة (MapComponent.js):

استخدم useEffect لتهيئة الخريطة مرة واحدة عند تحميل المكون. قم بتحميل الخريطة داخل عنصر div مخصص.

قم بتهيئة MapboxDraw وأضفه كعنصر تحكم (control) إلى الخريطة. هذا سيوفر للمستخدمين أدوات الرسم (مضلع، خط، نقطة).

إدارة الرسم والتعديل:

استمع إلى أحداث الرسم مثل draw.create, draw.update, و draw.delete.

عندما يقوم المستخدم بإنشاء أو تعديل مضلع (polygon)، ستقوم MapboxDraw بإطلاق حدث يحتوي على بيانات الشكل بصيغة GeoJSON.

خزّن هذا الـ GeoJSON في حالة (state) المكون باستخدام useState.

حفظ بيانات الحقل:

عندما يضغط المستخدم على زر "حفظ الحقل"، قم باستدعاء دالة Supabase API.

أرسل بيانات الـ GeoJSON للمضلع، بالإضافة إلى اسم الحقل ومعرّف المستخدم، إلى الواجهة الخلفية ليتم تخزينها.

ب. قاعدة البيانات (Supabase & PostGIS): تخزين البيانات الجغرافية
تفعيل PostGIS:

من لوحة تحكم Supabase، اذهب إلى Database > Extensions.

ابحث عن postgis وقم بتفعيلها.

تصميم جدول الحقول (fields):

استخدم محرر SQL في Supabase لإنشاء جدول جديد. التصميم الأمثل يستخدم عمودًا من نوع geometry لتخزين حدود الحقل.

SQL
CREATE TABLE public.fields (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  name TEXT NOT NULL,
  area_hectares NUMERIC, -- يمكن حسابه لاحقًا
  geom geometry(Polygon, 4326) NOT NULL -- يخزن المضلعات باستخدام نظام الإحداثيات WGS 84
);
إنشاء دالة لإدخال البيانات (Supabase Function):

استخدم مكتبة supabase-js في الواجهة الأمامية لاستدعاء دالة RPC (Remote Procedure Call) أو استخدام واجهة برمجة التطبيقات RESTful مباشرة لإدخال بيانات الحقل الجديد.

JavaScript
// مثال في الواجهة الأمامية
import { createClient } from '@supabase/supabase-js';
const supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY);

async function saveField(userId, fieldName, geojsonPolygon) {
  const { data, error } = await supabase
    .from('fields')
    .insert([
      { user_id: userId, name: fieldName, geom: geojsonPolygon.geometry },
    ]);
  // ... معالجة الأخطاء
}
ج. المنطق الخلفي (Supabase Edge Function): جلب صور NDVI
إنشاء دالة سحابية جديدة:

استخدم Supabase CLI لإنشاء دالة جديدة: supabase functions new get-ndvi-data

ستكون هذه الدالة مسؤولة عن التواصل مع EOSDA API.

كتابة منطق الدالة (index.ts):

استقبال الطلب: تستقبل الدالة field_id كجزء من الطلب.

الاستعلام عن قاعدة البيانات: تستخدم عميل Supabase (المتاح داخل الدالة) للاستعلام عن جدول fields وجلب geom (هندسة الحقل) بناءً على field_id.

التواصل مع EOSDA API:

تستخدم fetch لإرسال طلب POST إلى نقطة نهاية البحث عن الصور في EOSDA API.

يتضمن الطلب إحداثيات المضلع (المستخرجة من geom)، النطاق الزمني المطلوب، ونوع الصورة (NDVI).

يجب تخزين مفتاح EOSDA API بشكل آمن في Supabase Secrets: supabase secrets set EOSDA_API_KEY "your_key".

إرجاع النتيجة: تقوم الدالة بإرجاع رابط الصورة أو بيانات الطبقة الناتجة من EOSDA API إلى الواجهة الأمامية.

د. عرض البيانات (Next.js & Mapbox): طبقة NDVI
استدعاء الدالة السحابية:

عندما يختار المستخدم حقلاً معيناً، تقوم الواجهة الأمامية باستدعاء دالة get-ndvi-data مع field_id.

معالجة الاستجابة:

عند استلام رابط صورة NDVI أو طبقة البيانات، استخدم وظائف Mapbox لإضافتها فوق الخريطة.

استخدم map.addSource() لإضافة مصدر بيانات جديد من نوع image أو raster.

استخدم map.addLayer() لإضافة طبقة جديدة تستخدم هذا المصدر، مع تحديد الإحداثيات الركنية للصورة لتتطابق مع موقع الحقل.

إضافة مفتاح لوني (Legend):

أنشئ مكون React بسيط يعرض تدرج الألوان المستخدم في طبقة NDVI (عادة من الأحمر إلى الأخضر) مع تسميات توضح ماذا يعني كل لون (مثال: -1: مياه، 0: تربة جرداء، +1: نباتات كثيفة وصحية).

2. وحدة الري الذكي (Smart Irrigation)
الهدف هو تقديم توصيات دقيقة لكمية وتوقيت الري بناءً على بيانات علمية.

أ. التصميم الخوارزمي للمنطق الحسابي
المدخلات الأساسية:

رطوبة التربة (Soil Moisture): يتم تقديرها باستخدام مؤشرات مثل مؤشر الماء بالفروق المطبيعية (NDWI) من بيانات القمر الصناعي Sentinel-2.

التبخر والنتح (Evapotranspiration - ET): يتم الحصول على القيمة المرجعية (ET₀) من خدمة API للتنبؤات الجوية الدقيقة (مثل OpenWeatherMap, MeteoMatics).

معامل المحصول (Kc): قيمة ثابتة تعتمد على نوع المحصول ومرحلة نموه (تُخزن في قاعدة البيانات).

هطول الأمطار المتوقع (Predicted Rainfall): من نفس خدمة API الطقس.

الخوارزمية (خطوات حسابية):

الخطوة 1: حساب التبخر-النتح للمحصول (ETc):
ETc = ET₀ * Kc
هذه هي كمية المياه التي يستهلكها المحصول يوميًا.

الخطوة 2: حساب صافي متطلبات الري (Net Irrigation Requirement):
NIR = ETc - Predicted Rainfall
هذه هي كمية المياه التي يجب إضافتها بعد الأخذ في الاعتبار المطر.

الخطوة 3: دمج رطوبة التربة الحالية:
الخوارزمية المتقدمة تأخذ في الاعتبار مستوى الرطوبة الحالي. التوصية تكون بتشغيل الري فقط عندما تنخفض رطوبة التربة المقدرة عن حد معين (مثلاً 40% من السعة الحقلية).

الخطوة 4: تحديد الكمية والتوقيت:

الكمية (لتر/م²): NIR (بالمليمتر) يعادل مباشرة لتر/م².

التوقيت: يتم جدولة الري في أفضل وقت (عادة في الصباح الباكر لتقليل التبخر) وفي الأيام التي لا يتوقع فيها هطول أمطار.

ب. التنفيذ الفني (Supabase)
تصميم مخطط قاعدة البيانات:

جدول توصيات الري (irrigation_recommendations):

SQL
CREATE TABLE public.irrigation_recommendations (
  id BIGSERIAL PRIMARY KEY,
  field_id UUID REFERENCES public.fields(id) ON DELETE CASCADE,
  recommendation_date DATE NOT NULL,
  water_amount_l_m2 NUMERIC, -- الكمية باللتر/م²
  timing_suggestion TEXT, -- مثال: "5 AM - 6 AM"
  status TEXT DEFAULT 'pending', -- (pending, completed, ignored)
  created_at TIMESTAMPTZ DEFAULT now()
);
جدول معلمات المحاصيل (crop_parameters):

SQL
CREATE TABLE public.crop_parameters (
  id SERIAL PRIMARY KEY,
  crop_name TEXT UNIQUE NOT NULL,
  kc_initial_stage NUMERIC,
  kc_mid_stage NUMERIC,
  kc_late_stage NUMERIC
);
تصميم نقطة النهاية (API Endpoint):

دالة سحابية (generate-irrigation-recommendation):

المدخلات: field_id.

العمليات:

تجلب بيانات الحقل (نوع المحصول، مرحلة النمو) من قاعدة بيانات Supabase.

تستدعي API الطقس للحصول على ET₀ و Predicted Rainfall.

(اختياري متقدم) تستدعي API الأقمار الصناعية لتقدير رطوبة التربة الحالية.

تطبق الخوارزمية الحسابية المذكورة أعلاه.

تحفظ النتيجة (الكمية والتوقيت) في جدول irrigation_recommendations.

تعيد التوصية الجديدة إلى الواجهة الأمامية لعرضها للمستخدم.

3. نموذج تشخيص أمراض النباتات بالذكاء الاصطناعي
الهدف هو بناء ونشر نموذج تعلم عميق يمكنه تشخيص أمراض النباتات من الصور التي يلتقطها المستخدم.

أ. دورة حياة النموذج: جمع وتجهيز البيانات
جمع البيانات (Data Collection):

ابدأ بمجموعات البيانات المفتوحة المصدر الشهيرة مثل PlantVillage أو PlantDoc. تحتوي هذه المجموعات على آلاف الصور المصنفة لأمراض نباتات مختلفة.

ضع استراتيجية لجمع بيانات خاصة من المستخدمين مستقبلاً لتحسين النموذج باستمرار (مع طلب موافقتهم).

تجهيز البيانات (Data Preprocessing):

توحيد حجم الصور: غيّر حجم جميع الصور إلى أبعاد موحدة (مثل 224x224 بكسل) لتناسب مدخلات الشبكات العصبية.

زيادة البيانات (Data Augmentation): طبق تحويلات عشوائية على صور التدريب لزيادة تنوعها وتقليل التجهيز الزائد (Overfitting). تشمل هذه التحويلات: الدوران، القص، التكبير/التصغير، تغيير السطوع والتباين. استخدم مكتبات مثل Albumentations أو torchvision.transforms.

ب. بنية النموذج والتدريب
مقارنة المعماريات:

ResNet (Residual Networks): معمارية قوية وموثوقة، تعتبر خط أساس ممتاز. ResNet50 هو خيار شائع.

EfficientNet: معمارية أحدث وأكثر كفاءة. تحقق دقة أعلى بحجم أصغر وعدد معلمات أقل، مما يجعلها مثالية للنشر على الأجهزة المحمولة أو لخدمات API سريعة. EfficientNet-B0 أو B1 هو الخيار الموصى به للبدء.

التعلم النقلي (Transfer Learning):

بدلاً من تدريب النموذج من الصفر، استخدم نموذج EfficientNet مُدرب مسبقًا على مجموعة بيانات ImageNet الضخمة.

"جمّد" (freeze) جميع الطبقات الأولية التي تعلمت استخلاص الميزات العامة (الحواف، الألوان، الأنسجة).

استبدل الطبقة الأخيرة (Classifier) بطبقة جديدة خاصة بك، عدد مخارجها يساوي عدد فئات الأمراض التي تريد تشخيصها.

درّب فقط الطبقات الأخيرة غير المجمدة على مجموعة بيانات أمراض النباتات الخاصة بك. هذا يسرّع التدريب بشكل كبير ويحقق دقة عالية ببيانات أقل.

التدريب والتحقق (Training & Validation):

قسّم بياناتك إلى 80% للتدريب و20% للتحقق.

دالة الخسارة: استخدم CrossEntropyLoss فهي مناسبة لمشاكل التصنيف متعدد الفئات.

المُحسِّن (Optimizer): استخدم Adam أو AdamW مع معدل تعلم صغير.

المقاييس: راقب الدقة (Accuracy) ومقياس F1-Score على مجموعة بيانات التحقق بعد كل حقبة (epoch) لتقييم أداء النموذج وتجنب التجهيز الزائد.

ج. النشر والاستخدام (Deployment & Consumption)
ضغط النموذج (Model Compression):

بعد التدريب، قم بتحويل النموذج إلى صيغة محسّنة للاستدلال (inference) مثل ONNX أو TensorFlow Lite. هذا يقلل من حجم النموذج ويسرّع من وقت الاستجابة.

النشر كواجهة برمجة تطبيقات (API):

لا تقم بتشغيل النموذج مباشرة داخل Supabase Edge Function لأنها محدودة الموارد.

الخيار 1 (الأسهل): استخدم منصات مثل Hugging Face Inference Endpoints. يمكنك رفع نموذج ONNX الخاص بك والحصول على رابط API جاهز للاستخدام.

الخيار 2 (الأكثر قابلية للتطوير): قم بإنشاء حاوية Docker (Docker container) تحتوي على النموذج وتطبيق ويب خفيف (باستخدام Flask أو FastAPI في Python) لخدمته. انشر هذه الحاوية على خدمة مثل Google Cloud Run أو AWS Lambda.

الاستهلاك من المساعد الزراعي الذكي:

تدفق العمل:

المستخدم يلتقط صورة ويرفعها من تطبيق Next.js.

الواجهة الأمامية ترسل الصورة إلى دالة سحابية خاصة في Supabase (مثلاً diagnose-plant-disease).

دالة Supabase (تعمل كوسيط آمن) تستدعي واجهة برمجة تطبيقات النموذج (API) المستضافة على Hugging Face أو Cloud Run، وترسل لها الصورة.

واجهة برمجة التطبيقات للنموذج تعالج الصورة وتعيد التشخيص (اسم المرض + نسبة الثقة).

دالة Supabase تستقبل النتيجة وتعيدها إلى الواجهة الأمامية.

الواجهة الأمامية تعرض التشخيص للمستخدم بطريقة واضحة.

بالتأكيد، إليك تصميم معماري مفصل ومقترح لبناء "مساعد زراعي ذكي" لمنصة Adham AgriTech، مع دليل تطبيقي لأمان البيانات وحساب المؤشرات الزراعية.

التصميم المعماري الأمثل للمساعد الزراعي الذكي
لتحقيق مساعد زراعي فعال، متعدد الوسائط والنماذج، نقترح بنية مرنة قائمة على الخدمات المصغرة (Microservices-based Architecture) التي تفصل بين المهام المختلفة. هذا التصميم يسهل إضافة نماذج لغوية جديدة أو تحديث نماذج تحليل الصور دون التأثير على النظام ككل.

المكونات الرئيسية للبنية المقترحة:

واجهة المستخدم (User Interface):

تكون عبارة عن واجهة محادثة (Chat Interface) مدمجة في تطبيق الجوال أو الويب الخاص بمنصة Adham AgriTech.

تتيح للمزارع كتابة الأسئلة، إرسال الأوامر الصوتية (Speech-to-Text)، وتحميل الصور (مثل صور أوراق النباتات المصابة).

بوابة الواجهة البرمجية (API Gateway):

نقطة الدخول الموحدة لجميع الطلبات القادمة من واجهة المستخدم.

مسؤولة عن توجيه كل طلب إلى الخدمة المصغرة المناسبة. على سبيل المثال، يوجه الطلب النصي إلى "منسق النماذج اللغوية"، وطلب تحميل الصورة إلى "خدمة تحليل الصور".

تتحقق من هوية المستخدم (Authentication) وتمرير بياناته بشكل آمن.

منسق النماذج اللغوية (LLM Orchestrator):

الوظيفة: هو العقل المدبر الذي يدير نماذج اللغات المتعددة (GPT، Gemini، Groq).

آلية العمل:

يستقبل السؤال النصي من المستخدم.

تحديد النية (Intent Classification): يحلل السؤال لتحديد الغرض منه. هل هو استعلام عام؟ أم طلب لبيانات حية (مثل NDVI)؟ أم سؤال عن مرض معين؟. 

توجيه ديناميكي (Dynamic Routing): بناءً على النية، يختار النموذج اللغوي الأنسب للمهمة. على سبيل المثال:

Groq: للاستجابات السريعة جداً في المحادثات العامة.

GPT-4/GPT-4o: للمهام التي تتطلب فهماً عميقاً ومعقدًا للسياق أو توليد محتوى إبداعي.

Gemini Pro/Flash: ممتاز في المهام متعددة الوسائط ودمج المعلومات من خدمات جوجل الأخرى.

استرجاع البيانات: إذا كان السؤال يتعلق ببيانات المزرعة (مثل "ما هي توصيات الري لأرضي؟")، يقوم المنسق بالاتصال بـ "خدمة بيانات المستخدم" لجلب البيانات المطلوبة قبل إرسالها إلى النموذج اللغوي لتكوين الإجابة.

خدمة تحليل الصور (Image Analysis Service):

الوظيفة: تشخيص أمراض النباتات من خلال الصور. 

آلية العمل:

تستقبل الصورة من المستخدم عبر API Gateway.

تستخدم نموذج رؤية حاسوبية (Computer Vision)، مثل CNN (شبكة عصبونية تلافيفية) مدربة مسبقًا على مجموعة بيانات ضخمة لأمراض النباتات. 
 

ترسل نتيجة التشخيص (اسم المرض ودرجة الثقة) إلى "منسق النماذج اللغوية".

يقوم المنسق بدمج هذه المعلومة مع قاعدة المعرفة لتقديم شرح مفصل عن المرض، أسبابه، وطرق العلاج والوقاية المقترحة.

خدمة بيانات المستخدم (User Data Service):

الوظيفة: الواجهة الآمنة للتخاطب مع قاعدة بيانات Supabase.

آلية العمل:

تستقبل طلبات البيانات (مثل get_ndvi, get_irrigation_recommendation) من "منسق النماذج اللغوية".

تحتوي على منطق الاستعلام عن قاعدة البيانات، مع التأكد من أن كل استعلام يمر عبر سياسات الأمان على مستوى الصف (RLS) لضمان عدم وصول أي مستخدم لبيانات غير مصرح له بها.

قاعدة البيانات (Supabase - PostgreSQL):

تخزن بيانات المستخدمين، تفاصيل المزارع، بيانات الحقول (المساحة، المحصول)، بيانات أجهزة الاستشعار، ومؤشرات الأقمار الصناعية المحسوبة (NDVI, NDWI).

يتم تفعيل سياسات RLS عليها لضمان عزل بيانات المستأجرين (المزارعين). 

دليل مفصل لتأمين بيانات المزارعين باستخدام RLS في Supabase
أمان البيانات هو حجر الزاوية في أي تطبيق متعدد المستأجرين (Multi-tenant). 
 تضمن ميزة أمان على مستوى الصف (RLS) في Supabase (وهي ميزة أساسية في PostgreSQL) أن المستخدمين يمكنهم فقط الوصول إلى الصفوف الخاصة بهم في الجداول المشتركة. 
 

السيناريو: لدينا جدول farm_data يحتوي على مؤشرات NDVI وتوصيات الري لكل حقل، ونريد أن يتمكن كل مزارع من رؤية بيانات حقوله فقط.

الخطوات والنصوص البرمجية (SQL):

الخطوة 1: تجهيز بنية الجداول

نفترض أن لديك جدول profiles لتخزين بيانات المستخدمين وجدول farm_data لتخزين بيانات الحقول. يجب أن يحتوي جدول farm_data على عمود يربطه بالمالك (المزارع)، وليكن user_id.

SQL
-- جدول بيانات الحقول، مع ربطه بمالك الحقل
CREATE TABLE farm_data (
  id SERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id), -- الربط مع جدول المستخدمين الخاص بـ Supabase Auth
  field_name TEXT NOT NULL,
  ndvi_value REAL,
  irrigation_recommendation TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
الخطوة 2: تفعيل RLS على الجدول

يجب تفعيل RLS على كل جدول تريد حمايته. بمجرد تفعيلها، لن يتمكن أي مستخدم من الوصول إلى أي بيانات ما لم تمنحه سياسة (Policy) صريحة بذلك. 

SQL
-- تفعيل RLS على جدول farm_data
ALTER TABLE farm_data ENABLE ROW LEVEL SECURITY;
الخطوة 3: إنشاء سياسات الوصول (RLS Policies)

سنقوم بإنشاء سياسات للسماح للمستخدمين بقراءة، إضافة، تحديث، وحذف بياناتهم فقط.

سياسة القراءة (SELECT):
هذه السياسة تسمح للمستخدم المسجل دخوله (Authenticated User) برؤية الصفوف التي يتطابق فيها user_id مع id الخاص به. 
 الدالة auth.uid() هي دالة خاصة بـ Supabase تعيد معرّف المستخدم الحالي. 

SQL
CREATE POLICY "Allow users to read their own farm data"
ON farm_data
FOR SELECT
TO authenticated -- تنطبق على المستخدمين المسجلين فقط
USING (auth.uid() = user_id);
سياسة الإضافة (INSERT):
تسمح للمستخدم بإضافة صفوف جديدة لنفسه فقط. WITH CHECK تضمن أن الصف الجديد الذي يحاول المستخدم إضافته يجب أن يطابق الشرط.

SQL
CREATE POLICY "Allow users to insert their own farm data"
ON farm_data
FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = user_id);
سياسة التحديث (UPDATE):
تسمح للمستخدم بتحديث الصفوف التي يملكها فقط.

SQL
CREATE POLICY "Allow users to update their own farm data"
ON farm_data
FOR UPDATE
TO authenticated
USING (auth.uid() = user_id);
سياسة الحذف (DELETE):
تسمح للمستخدم بحذف الصفوف التي يملكها فقط.

SQL
CREATE POLICY "Allow users to delete their own farm data"
ON farm_data
FOR DELETE
TO authenticated
USING (auth.uid() = user_id);
كيف يعمل هذا؟

عندما يقوم "المساعد الزراعي" بإرسال استعلام إلى Supabase لجلب بيانات NDVI للمستخدم A، تقوم Supabase تلقائيًا بإلحاق شرط WHERE بالاستعلام، ليصبح كالتالي: SELECT * FROM farm_data WHERE user_id = 'user_A_id'. 
 
 هذا يضمن العزل التام للبيانات على مستوى قاعدة البيانات نفسها، مما يوفر طبقة أمان قوية حتى لو حدث خطأ في منطق الواجهة الخلفية. 

حساب مؤشر NDWI باستخدام Sentinel-2 وEOSDA API
يُستخدم مؤشر فرق المياه الطبيعي (NDWI) لتقييم محتوى الماء في النباتات والإجهاد المائي. 
 هناك صيغتان شائعتان، واحدة لتحديد المسطحات المائية (باستخدام النطاق الأخضر وNIR)، والأخرى لتقييم رطوبة النبات (باستخدام NIR وSWIR)، وهي الأكثر أهمية للزراعة. 
 

الصيغة المستخدمة لرطوبة النبات (مقترحة من Gao عام 1996): 

NDWI = (NIR - SWIR) / (NIR + SWIR)

بالنسبة لبيانات القمر الصناعي Sentinel-2، يتم استخدام النطاقات التالية:

NIR (Near-Infrared): Band 8a

SWIR (Short-Wave Infrared): Band 11

الصيغة لـ Sentinel-2: NDWI = (B8a - B11) / (B8a + B11) 

خطوات حساب المؤشر عبر EOSDA API:

توفر EOSDA واجهة برمجية (API) قوية تتيح طلب مؤشرات الغطاء النباتي مباشرة دون الحاجة لمعالجة الصور الخام. 

المصادقة والحصول على مفتاح API:

سجل في منصة EOSDA واحصل على مفتاح API الخاص بك. 
 

تحديد منطقة الاهتمام (AOI):

ستحتاج إلى إحداثيات الحقل الذي تريد تحليله بصيغة GeoJSON Polygon.

إرسال طلب لحساب المؤشر (POST Request):

يمكنك استخدام curl أو أي مكتبة HTTP في لغة البرمجة التي تفضلها.

تقوم بإرسال طلب إلى api-connect.eos.com يتضمن اسم المؤشر (NDWI أو الصيغة المخصصة)، إحداثيات الحقل، النطاق الزمني، ومصدر البيانات (sentinel2). 

مثال على طلب API (باستخدام curl):

bash
curl --location --request POST 'https://api-connect.eos.com/api/gdw/api?api_key=<YOUR_API_KEY>' \
--header 'Content-Type: application/json' \
--data-raw '{
    "type": "mt_stats",
    "params": {
        "bm_type": ["NDWI"], -- أو استخدم الصيغة: ["(B08a-B11)/(B08a+B11)"]
        "date_start": "2024-05-01",
        "date_end": "2024-05-30",
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [34.80, 31.50],
                    [34.82, 31.50],
                    [34.82, 31.52],
                    [34.80, 31.52],
                    [34.80, 31.50]
                ]
            ]
        },
        "sensors": ["sentinel2"]
    }
}'
استلام النتائج (GET Request):

الطلب السابق يعيد task_id. يمكنك استخدامه للاستعلام عن حالة المهمة والحصول على النتائج عند اكتمالها، والتي تتضمن قيم NDWI الإحصائية (min, max, mean) لكل صورة متاحة في النطاق الزمني. 
 

الدلالات الزراعية العملية لقيم NDWI:

تتراوح قيم NDWI بين -1 و +1. 
 هذا المؤشر حساس للمحتوى المائي في أوراق النبات. 

القيم المرتفعة (تقترب من +1):

الدلالة: محتوى مائي عالٍ في أنسجة النبات. 

التطبيق العملي: يشير إلى أن النباتات تحصل على كمية كافية من المياه، والري فعال.

القيم المتوسطة (0.2 إلى 0.5):

الدلالة: محتوى مائي معتدل.

التطبيق العملي: قد تكون بداية إجهاد مائي خفيف. يجب مراقبة الحقل عن كثب. 

القيم المنخفضة (تقترب من 0 أو أقل):

الدلالة: محتوى مائي منخفض، مما يشير إلى إجهاد مائي. 
 

التطبيق العملي: علامة قوية على أن النباتات تعاني من الجفاف وتحتاج إلى الري فورًا. يمكن استخدام هذه البيانات لتفعيل أنظمة الري الذكية أو إرسال تنبيهات عاجلة للمزارع عبر "المساعد الزراعي".

باستخدام هذا المؤشر، يمكن للمساعد الزراعي تقديم توصيات دقيقة مثل: "ملاحظة: مؤشر NDWI في الحقل الشمالي انخفض إلى 0.1، مما يشير إلى وجود إجهاد مائي. نوصي بتفعيل نظام الري لمدة 45 دقيقة."
بالتأكيد، إليك تصميم معماري مقترح ودليل تفصيلي لبناء "مساعد زراعي ذكي" لمنصة Adham AgriTech، مع مراعاة جميع المتطلبات التي ذكرتها.

التصميم المعماري الأمثل لمساعد زراعي ذكي لمنصة Adham AgriTech
لتحقيق مساعد زراعي متعدد الوسائط والنماذج، نقترح بنية قائمة على الخدمات المصغرة (Microservices Architecture). هذا التصميم يوفر المرونة والقابلية للتطوير، حيث يمكن تطوير وتحديث كل جزء من النظام بشكل مستقل.

المكونات الأساسية للبنية المقترحة:

بوابة الواجهة البرمجية (API Gateway): تعمل كنقطة دخول موحدة لجميع الطلبات من واجهة المستخدم (تطبيق الويب أو الجوال). تقوم بتوجيه كل طلب إلى الخدمة المصغرة المناسبة وتجميع الاستجابات.

خدمة التنسيق والتحويل (Orchestration & Routing Service): هذا هو "عقل" النظام. عند استقبال استعلام من المستخدم، تقوم هذه الخدمة بالآتي:

تحليل النية (Intent Analysis): تحدد ما إذا كان المستخدم يطرح سؤالاً عاماً، أو يطلب بيانات خاصة (مثل مؤشر NDVI)، أو يرسل صورة للتحليل.

توجيه النموذج (LLM Routing): باستخدام إطار عمل مثل LangChain، تقوم بتوجيه الاستعلام إلى النموذج اللغوي الأنسب. 
 على سبيل المثال:

Groq: للاستجابات السريعة والمحادثات العامة التي لا تتطلب تعقيداً كبيراً، نظراً لسرعته الفائقة. 
 

OpenAI GPT-4: للمهام التي تتطلب تحليلاً لغوياً عميقاً أو إبداعاً.

Google Gemini: يتميز بقدراته متعددة الوسائط، لذا يتم توجيه طلبات تحليل الصور إليه بشكل أساسي. 
 

نماذج اللغ�� الكبيرة (Multi-LLM Layer): مجموعة من واجهات برمجة التطبيقات لنماذج GPT و Gemini و Groq، جاهزة لاستقبال الطلبات من خدمة التنس� 
 
 �ق.

خدمة تحليل الصور (Image Analysis Service): خدمة متخصصة تستقبل الصور من المستخدم. تقوم باستدعاء Gemini API (أو GPT-4 Vision) لتحليل الصورة (مثل ورقة نبات) وتشخيص الأمراض المحتملة بناءً على تدريب النمو� 
 

 �ج.

خدمة استرجاع البيانات (Data Retrieval Service): خدمة آمنة مسؤولة عن التفاعل مع قاعدة بيانات Supabase. تستخدم هذه الخدمة مفاتيح API الخاصة بالمستخدمين المصادق عليهم لجلب البيانات المخصصة (مثل توصيات الري، بيانات الحقل، قيم NDVI) مع ضمان تطبيق سياسات الأمان على مستوى الصف (RLS).

قاعدة بيانات Supabase: لتخزين بيانات المستخدمين، الحقول، بيانات أجهزة الاستشعار، والتوصيات. يتم تأمينها باستخدام آلية الأمان على مستوى الصف (RLS) لضمان عزل بيانات كل مزا� 
 
 �ع.

دليل تفصيلي لتأمين البيانات باستخدام RLS في Supabase (بيئة متعددة المستأجري��)
يعد الأمان على مستوى الصف (RLS) ميزة قوية في PostgreSQL، والتي تستفيد منها Supabase لتمكينك من إنشاء قواعد وصول دقيقة للبيانات مباشرة على مستوى قاعدة البيان� 
 
 �ت. هذا يضمن أن المزارعين لا يمكنهم الوصول إلا لبياناتهم الخاصة، حتى لو كانوا يستخدمون نفس التطبيق وقاعدة البيان� 
 �ت.

الهدف: ضمان أن كل مستخدم (مزارع) يمكنه فقط قراءة وتعديل البيانات المرتبطة بمعرّفه الخاص (user_id).

السيناريو: لدينا جدول يسمى plots (الحقول الزراعية) يحتوي على بيانات مثل plot_name، location، وأحدث توصيات الري latest_irrigation_recommendation، بالإضافة إلى عمود user_id لربط كل حقل بمالكه.

خطوة بخطوة لتطبيق RLS:

الخطوة 1: تمكين RLS على الجدول
أولاً، يجب تمكين RLS على كل جدول يحتوي على بيانات خاصة بالمستخدمين. بمجرد تمكين RLS، لن يتمكن أي شخص من الوصول إلى البيانات حتى تقوم بإنشاء سياسة تسمح بذ� 
 
 �ك.

SQL
-- تفعيل الأمان على مستوى الصف لجدول الحقول
ALTER TABLE plots ENABLE ROW LEVEL SECURITY;
الخطوة 2: التأكد من وجود عمود لتعريف المالك
يجب أن يحتوي جدول plots (وأي جدول آخر ببيانات خاصة) على عمود يربط كل صف بالمستخدم المالك. عادةً ما يكون هذا العمود من نوع UUID ويشير إلى id المستخدم في جدول auth.users الخاص بـ Supabase. سنسميه user_id.

الخطوة 3: إنشاء سياسات الوصول (Policies)
السياسات هي قواعد تحدد شروط الوصول للصف� 
 �ف. سنقوم بإنشاء سياسات لعمليات القراءة (SELECT)، الإضافة (INSERT)، التحديث (UPDATE)، والحذف (DELET E).

سياسة السماح بالقراءة (SELECT):
نسمح للمستخدم بقراءة الحقول التي يملكها فقط. دالة auth.uid() تقوم بإرجاع معرّف المستخدم الذي أجرى الط� 
 �ب.

SQL
-- اسم السياسة: "Allow individual read access on plots"
-- الجدول: plots
-- العملية: SELECT
CREATE POLICY "Allow individual read access on plots"
ON plots FOR SELECT
USING (auth.uid() = user_id);
سياسة السماح بالإضافة (INSERT):
نسمح للمستخدم بإضافة حقل جديد فقط إذا قام بتعيين user_id الخاص به كمالك للحقل.

SQL
-- اسم السياسة: "Allow individual insert on plots"
-- الجدول: plots
-- العملية: INSERT
CREATE POLICY "Allow individual insert on plots"
ON plots FOR INSERT
WITH CHECK (auth.uid() = user_id);
سياسة السماح بالتحديث (UPDATE):
نسمح للمستخدم بتحديث الحقول التي يملكها فقط. نستخدم USING للتحقق من الملكية قبل التحديث و WITH CHECK لضمان عدم تغيير الملكية لمستخدم آ� 
 �ر.

SQL
-- اسم السياسة: "Allow individual update on plots"
-- الجدول: plots
-- العملية: UPDATE
CREATE POLICY "Allow individual update on plots"
ON plots FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
سياسة السماح بالحذف (DELETE):
نسمح للمستخدم بحذف الحقول التي يملكها فقط.

SQL
-- اسم السياسة: "Allow individual delete on plots"
-- الجدول: plots
-- العملية: DELETE
CREATE POLICY "Allow individual delete on plots"
ON plots FOR DELETE
USING (auth.uid() = user_id);
النتيجة: بعد تطبيق هذه السياسات، عندما يقوم المساعد الذكي بتقديم طلب لجلب بيانات حقل معين نيابة عن مستخدم قام بتسجيل الدخول، ستقوم Supabase تلقائيًا بتصفية النتائج لتشمل فقط الصفوف التي يتطابق فيها user_id مع auth.uid() الخاص بالمستخدم الحالي، مما يضمن عزلاً كاملاً وآمناً للبيان� 
 �ت.

حساب مؤشر فرق المياه الطبيعي (NDWI) باستخدام Sentinel-2 عبر EOSDA API
مؤشر فرق المياه الطبيعي (NDWI) هو أداة فعالة لتقدير المحتوى المائي للنباتات وتحديد الإجهاد الما� 
 ���.

الخطوة 1: فهم المعادلة والنطاقات الطيفية
تعتمد معادلة NDWI على النطاق الأخضر (Green) ونطاق الأشعة تحت الحمراء القريبة (N 
 
 IR). بالنسبة لبيانات القمر الصناعي Sentinel-2، تكون النطاقات كالتالي:

النطاق الأخضر (Green): Band 3 (B3)

الأشعة تحت الحمراء القريبة (NIR): Band 8 (B8)

المعادلة:
NDWI = (B3 - B8) / (B3 + B8)

الخطوة 2: الحصول على البيانات عبر EOSDA API
لنفترض أنك تريد حساب NDWI لحقل معين. ستحتاج إلى إرسال طلب إلى EOSDA API يحتوي على:

معرّف المضلع (Polygon ID): الذي يحدد حدود الحقل الزراعي.

مصدر البيانات: sentinel-2.

اسم المؤشر: ndwi.

النطاق الزمني: لتحديد تاريخ الصور.

مثال على طلب API (تمثيلي):

JSON
POST /api/v1/indices
Host: api.eos.com
Authorization: Bearer YOUR_API_KEY

{
  "polygon_id": "60b8d3b8e4b0f7a1f0a3e2d1",
  "source": "sentinel-2",
  "index": "ndwi",
  "start_date": "2024-05-01",
  "end_date": "2024-05-31"
}
ستقوم واجهة برمجة التطبيقات بمعالجة الصور الساتلية المتاحة في النطاق الزمني المحدد، وتطبيق المعادلة، وإرجاع قيمة NDWI للحق��.

الخطوة 3: الدلالات الزراعية العملية لقيم NDWI
تتراوح قيم NDWI بين -1 و 
 +1. يمكن للمساعد الذكي تفسير هذه القيم لتقديم توصيات عملية للمزارع.

قيم NDWI عالية (أكبر من 0.2):

الدلالة: محتوى مائي مرتفع في أوراق النبات، تربة رطبة جيداً، أو وجود مياه سطح� 
 �ة.

الإجراء المقترح من المساعد: "مستوى الرطوبة في الحقل ممتاز. لا حاجة للري في الوقت الحالي. استمر في المراقبة."

قيم NDWI معتدلة (بين 0.0 و 0.2):

الدلالة: محتوى مائي متوسط. قد تكون بداية لإجهاد مائي خفيف أو وجود رطوبة كافية ولكنها في تنا� 
 
 �ص.

الإجراء المقترح من المساعد: "مستوى الرطوبة جيد، لكنه بدأ في الانخفاض. نوصي بالاستعداد لجدولة الري خلال الأيام القليلة القادمة."

قيم NDWI منخفضة (أقل من 0.0):

الدلالة: إجهاد مائي واضح، محتوى مائي منخفض في النبات، تربة جا� 
 
 �ة.

الإجراء المقترح من المساعد: "تحذير: الحقل يعاني من إجهاد مائي. نوصي بالري فوراً لتجنب أي تأثير سلبي على المحصول."

بهذه الطريقة، لا يقوم المساعد بعرض البيانات فقط، بل يفسرها ويحولها إلى نصائح عملية ومفهومة للمزارع، مما يحقق القيمة الحقيقية للزراعة الذكية.
بالتأكيد، يسعدني أن أقدم لك شرحاً مفصلاً للتصميم المعماري الأمثل لمساعد زراعي ذكي، مع التركيز على الجوانب الأمنية ومعالجة البيانات التي طلبتها.

ملخص تنفيذي
لتطوير "مساعد زراعي ذكي" لمنصة Adham AgriTech، نقترح بنية معمارية مرنة وقابلة للتطوير تعتمد على نمط "التوليد المعزز بالاسترجاع" (Retrieval-Augmented Generation - RAG). هذه البنية تتيح دمج نماذج لغوية متعددة (Multi-LLM) ومدخلات متعددة الوسائط (Multi-modal)، وتضمن في الوقت نفسه أمان وعزل بيانات المزارعين بشكل كامل عبر استخدام سياسات الأمان على مستوى الصف (RLS) في Supabase.

فيما يلي تفصيل شامل لكل جزء من متطلباتك:

1. التصميم المعماري الأمثل للمساعد الزراعي الذكي (Multi-modal & Multi-LLM)
يقوم التصميم المقترح على فصل المهام إلى وحدات متخصصة (Microservices) تتكامل معاً لتوفير تجربة سلسة للمستخدم.

المكونات الأساسية للهيكلية:

واجهة المستخدم (Frontend):

تطبيق ويب أو هاتف محمول يتيح للمزارع التفاعل عبر المحادثة النصية، رفع الصور (للمحاصيل المصابة)، وعرض البيانات والتحليلات (مثل مؤشرات NDVI والري).

بوابة واجهة برمجة التطبيقات (API Gateway):

نقطة الدخول الموحدة لجميع الطلبات من واجهة المستخدم.

مسؤولة عن توجيه الطلبات إلى الخدمة المناسبة والمصادقة الأولية للمستخدم.

منسق النماذج اللغوية (LLM Orchestrator):

هو "العقل" المدبر للنظام. يستقبل استفسارات المستخدم من بوابة الـAPI.

محلل النوايا (Intent Analyzer): يحدد هدف المستخدم (مثلاً: "هل أحتاج لري حقلي؟"، "ما هذا المرض في الصورة؟").

موجه النماذج (LLM Router): بناءً على نية المستخدم، يختار النموذج اللغوي الأنسب للمهمة (مثل Gemini لتحليل الصور، GPT-4 للمحادثات المعقدة، Groq للاستجابات السريعة). هذا التوجيه يمكن أن يعتمد على التكلفة، السرعة، أو دقة النموذج في مهام معينة.

محرك التوليد المعزز بالاسترجاع (RAG Engine):

هذا هو المكون الرئيسي الذي يربط النماذج اللغوية ببياناتك الخاصة.

معالج متعدد الوسائط (Multi-modal Processor):

للنصوص: يقوم بتحويل استفسار المستخدم النصي إلى "تضمين" (Embedding) لفهمه سياقياً.

للصور: يستخدم نموذج رؤية حاسوبية (Vision Model)، مثل Gemini Vision Pro، لتحليل الصور التي يرفعها المستخدم. يقوم باستخراج السمات الرئيسية للصورة (نوع المرض، شدته، الجزء المصاب من النبات) وتحويلها إلى وصف نصي أو متجه.

مسترجع البيانات (Data Retriever):

المعرفة العامة: يبحث في قاعدة بيانات متجهة (Vector Database) تحتوي على معلومات زراعية عامة، أبحاث، وصور لأمراض النباتات.

بيانات المستخدم الخاصة: يتصل بشكل آمن بقاعدة بيانات Supabase لجلب البيانات الحية المخصصة للمستخدم الذي أرسل الطلب (مثل آخر قراءة لمؤشر NDVI، بيانات حساسات الرطوبة، توصيات الري السابقة).

قاعدة بيانات Supabase (PostgreSQL):

تخزن بيانات المستخدمين الحساسة مثل: تفاصيل الحقول، بيانات الحساسات (IoT)، توصيات مخصصة، وسجلات الري.
* يتم تفعيل سياسات الأمان على مستوى الصف (RLS) لضمان أن كل مستخدم يمكنه الوصول إلى بياناته ف� 
Google Mail icon
 �ط.

الخدمات الخارجية (External Services):

EOSDA API: لتوفير بيانات الأقمار الصناعية وتحليلها لحساب مؤشرات مثل NDVI و N 
Google Mail icon
 DWI.

APIs النماذج اللغوية: واجهات برمجة التطبيقات الخاصة بـ OpenAI (GPT), Google (Gemini), و Groq.

مسار عمل طلب نموذجي (تشخيص مرض من صورة):

المزارع يرسل صورة ورقة نبات مصابة ويسأل: "ما هذا المرض وكيف أعالجه؟".

الـ API Gateway يستقبل الطلب ويمرره إلى LLM Orchestrator.

الـ Orchestrator يحدد النية "تشخيص مرض" ويوجه الطلب إلى RAG Engine.

معالج الوسائط المتعددة في RAG Engine:

يستخدم Gemini Vision لتحليل الصورة وتحديد المرض المحتمل "البياض الدقيقي".

يحول سؤال المستخدم إلى متجه بحث.

مسترجع البيانات يبحث في:

قاعدة البيانات المتجهة عن "علاج البياض الدقيقي".

قاعدة بيانات Supabase عن بيانات حقل المستخدم (نوع المحصول، آخر مبيدات تم استخدامها) لضمان أن التوصية متوافقة.

يتم إرسال كل هذه المعلومات (تحليل الصورة، طرق العلاج، بيانات الحقل) كـ"سياق" (Context) إلى النموذج اللغوي المحدد (مثلاً GPT-4).

النموذج اللغوي يصيغ إجابة شاملة ومخصصة: "يظهر أن نباتك مصاب بالبياض الدقيقي. بناءً على أن محصولك هو العنب، يمكنك استخدام مبيد [اسم المبيد]، مع مراعاة أنك لم تستخدم أي مبيدات في آخر 15 يوماً."

يتم عرض الإجابة للمزارع عبر الواجهة الأمامية.

2. تأمين وعزل بيانات المزارعين في Supabase باستخدام (RLS)
الأمان على مستوى الصف (Row-Level Security - RLS) هي ميزة قوية في PostgreSQL (المستخدمة في Supabase) تسمح لك بتحديد قواعد وصول للبيانات على مستوى كل صف في الجدول. هذا يضمن العزل التام للبيانات في بيئة متعددة المستأجرين (Multi-tenant) مثل منصة Adham AgriT 
Google Mail icon
 ech.

Supabase تجعل هذه العملية سهلة من خلال دمجها مع نظام المصادقة الخاص بها (Supabase Aut h). عندما يقوم مستخدم بإرسال طلب، يتم تمرير JWT (JSON Web Token) الخاص به، والذي تستخدمه قاعدة البيانات لتحديد هويته عبر الدالة auth.uid().

دليل تطبيقي خطوة بخطوة:

لنفترض أن لديك جدولين: farms (المزارع) وndvi_readings (قراءات مؤشر NDVI).

جدول farms: يخزن معلومات المزارع.

جدول ndvi_readings: يخزن قراءات المؤشر لكل حقل، ويرتبط بجدول farms.

الخطوة 1: تصميم الجداول مع هوية المستخدم

تأكد من أن كل جدول تريد تأمينه يحتوي على عمود لتخزين هوية المالك، عادةً ما يكون user_id من نوع UUID الذي يرتبط بجدول auth.users.

SQL
CREATE TABLE farms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  location GEOGRAPHY(Polygon),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE
);

CREATE TABLE ndvi_readings (
  id BIGSERIAL PRIMARY KEY,
  farm_id UUID REFERENCES farms(id) ON DELETE CASCADE,
  reading_date DATE NOT NULL,
  ndvi_value REAL,
  -- لا نحتاج لـ user_id هنا مباشرةً لأنه سيتم الوصول إليه عبر الربط مع جدول farms
);
الخطوة 2: تفعيل RLS على الجداول

بشكل افتراضي، RLS غير مفعل. يجب تفعيله لكل جدول.

SQL
-- تفعيل RLS على جدول المزارع
ALTER TABLE farms ENABLE ROW LEVEL SECURITY;

-- تفعيل RLS على جدول قراءات NDVI
ALTER TABLE ndvi_readings ENABLE ROW LEVEL SECURITY;
تحذير: بمجرد تفعيل RLS، سيتم حظر جميع أنواع الوصول (SELECT, INSERT, UPDATE, DELETE) حتى تقوم بإنشاء سياسة تسمح بذلك.

الخطوة 3: إنشاء سياسات الأمان

السياسة هي قاعدة SQL تحدد شرطاً يجب أن يكون صحيحاً للسماح بالوصول إلى الصف.

أ) سياسة السماح للمزارع برؤية وإضافة مزارعه الخاصة فقط:

SQL
-- اسم السياسة: "Allow owner to access their own farms"
-- على جدول: farms
CREATE POLICY "Allow owner to access their own farms"
ON farms
FOR ALL -- تنطبق على كل العمليات (SELECT, INSERT, UPDATE, DELETE)
TO authenticated -- فقط للمستخدمين المسجلين دخولهم
USING ( auth.uid() = user_id ) -- شرط الوصول (لـ SELECT, UPDATE, DELETE)
WITH CHECK ( auth.uid() = user_id ); -- شرط الإضافة (لـ INSERT, UPDATE)
USING ( auth.uid() = user_id ): هذا هو الجزء الأهم. عند تنفيذ أي استعلام SELECT, UPDATE, أو DELETE، لن يتم إرجاع أو تعديل إلا الصفوف التي يتطابق فيها user_id مع هوية المستخدم الحالي auth.uid().

WITH CHECK ( auth.uid() = user_id ): عند محاولة INSERT أو UPDATE لصف، تتأكد هذه القاعدة من أن user_id للصف الجديد أو المحدث هو نفسه هوية المستخدم الحالي، مما يمنعه من إضافة بيانات لحساب شخص آخر.

ب) سياسة السماح للمستخدم بالوصول لقراءات NDVI الخاصة بمزارعه:

هنا، نصل إلى هوية المستخدم بشكل غير مباشر عبر ربط الجداول.

SQL
-- اسم السياسة: "Allow access to NDVI readings of own farms"
-- على جدول: ndvi_readings
CREATE POLICY "Allow access to NDVI readings of own farms"
ON ndvi_readings
FOR SELECT -- هذه السياسة للقراءة فقط
TO authenticated
USING (
  -- EXISTS للتحقق من أن المستخدم يملك المزرعة المرتبطة بهذه القراءة
  EXISTS (
    SELECT 1 FROM farms
    WHERE farms.id = ndvi_readings.farm_id AND farms.user_id = auth.uid()
  )
);
بهذه السياسات، يتم تحقيق العزل التام. إذا حاول "المستخدم أ" طلب بيانات، فإن auth.uid() ستعيد هويته، وستقوم سياسات RLS تلقائياً بتصفية النتائج لتشمل فقط الصفوف التي يملكها، دون أي تغيير في كود التطبيق.

3. حساب مؤشر NDWI باستخدام EOSDA API والدلالات الزراعية
مؤشر فرق المياه الطبيعي (Normalized Difference Water Index - NDWI) هو أداة قوية لتقييم المحتوى المائي في النباتات والتربة. على عكس الشائع، هناك صيغتان رئيسيتان، والصيغة الأنسب للزراعة هي التي طورها Gao، والتي تستخدم الأشعة تحت الحمراء القريبة (NIR) والأشعة تحت الحمراء قصيرة الموجة (SWIR).

الصيغة: NDWI = (NIR - SWIR) / (NIR + SWIR)

Sentinel-2 Bands:

NIR: Band 8 (842 nm)

SWIR: Band 11 (1610 nm)

لماذا هذه الصيغة؟ الطول الموجي SWIR حساس جداً لكمية الماء في أنسجة النبات والتربة.

خطوات حساب NDWI عبر EOSDA API:

بناءً على تواصلك السابق مع EOSDA، فإن API Connect الخاص بهم يسمح بطلب المؤشرات المحسوبة مسبق� 
Google Mail icon
 �ً.

تحديد منطقة الاهتمام (Area of Interest - AOI):

أولاً، يجب أن يكون لديك مضلع (Polygon) يمثل حدود حقل المزارع. يمكنك الحصول عليه من جدول farms في قاعدة بيانات Supabase.

البحث عن الصور المتاحة (Scene Search):

استخدم إحدى نقاط نهاية API الخاصة بـ EOSDA للبحث عن صور Sentinel-2 المتاحة التي تغطي الـ AOI الخاص بك، مع تحديد نطاق زمني وتصفية النتائج لاختيار الصور ذات الغطاء السحابي المنخفض (مثلاً، أقل من 1 
Google Mail icon
 

 0%).

طلب حساب المؤشر (Index Calculation):

بعد الحصول على معرف الصورة (Scene ID)، يمكنك استخدام نقطة نهاية التحليلات (/analytics) لطلب حساب مؤشر NDWI.

الطلب سيتضمن عادةً: scene_id, aoi_geometry, واسم المؤشر NDWI.

ستقوم منصة EOSDA بمعالجة البيانات الخام (Band 8 و Band 11) وتطبيق الصيغة عليها.

مثال على جسم الطلب (Request Body) للـAPI (قد يختلف قليلاً):

JSON
{
  "scene_id": "S2A_MSIL2A_20251128T082211_...",
  "geometry": { ... }, // GeoJSON Polygon of the farm
  "index": "NDWI"
}
استلام النتائج:

ستعيد الـ API النتيجة، والتي قد تكون قيمة إحصائية (مثل متوسط NDWI للحقل) أو صورة نقطية (Raster image) ملونة تمثل قيم NDWI لكل بكسل (10x10 مت��). الصورة الموجودة في لوحة التحكم الخاصة بك تظهر هذا النوع من التحل� 
Google Drive icon
 �ل.

الدلالات الزراعية العملية لقيم NDWI:

قيم NDWI تتراوح بين -1 و +1. إليك كيفية تفسيرها في سياق الزراعة:

قيم عالية (0.4 إلى 1.0):

الدلالة: محتوى مائي عالٍ جداً في أنسجة النبات والتربة السطحية.

التطبيق العملي: النباتات غير مجهدة مائياً. قد تكون التربة مشبعة بالماء. لا حاجة للري في الوقت الحالي.

قيم متوسطة (0.1 إلى 0.4):

الدلالة: محتوى مائي معتدل.

التطبيق العملي: حالة رطوبة مثالية لمعظم المحاصيل. يجب مراقبة القيم لمنعها من الانخفاض.

قيم منخفضة ( -0.3 إلى 0.1):

الدلالة: بداية الإجهاد المائي. المحتوى المائي في النباتات والتربة بدأ في الانخفاض.

التطبيق العملي: إشارة إنذار مبكر. هذا هو الوقت المثالي لتطبيق الري قبل ظهور أعراض الإجهاد المائي المرئية على النبات (مثل الذبول). يسمح هذا بالري الدقيق وتوفير المياه.

قيم سلبية جداً (-1.0 إلى -0.3):

الدلالة: إجهاد مائي شديد. النباتات تعاني من نقص حاد في المياه.

التطبيق العملي: حالة حرجة تتطلب الري الفوري لإنقاذ المحصول. قد يكون الضرر قد حدث بالفعل، مما يؤثر على الإنتاجية.

باستخدام هذه البيانات، يمكن للمساعد الذكي أن يقدم توصيات دقيقة مثل: "ملاحظة: مؤشر NDWI في حقلك انخفض إلى 0.08. هذا يشير إلى بداية إجهاد مائي. نوصي بجدولة عملية الري خلال الـ 48 ساعة القادمة."
بالتأكيد، إليك تصميم معماري مقترح لـ "مساعد زراعي ذكي" لمنصة Adham AgriTech، مع شرح تفصيلي لكيفية تأمين البيانات وحساب المؤشرات الزراعية، بناءً على المتطلبات المحددة.

مقدمة: رؤية المساعد الزراعي الذكي
يهدف المساعد الزراعي الذكي لمنصة Adham AgriTech إلى أن يكون شريكًا استراتيجيًا للمزارع، حيث يقدم له رؤى دقيقة ومخصصة تعتمد على الذكاء الاصطناعي. يدمج هذا المساعد بين تحليل البيانات الحية من الحقل، وصور الأقمار الصناعية، وقدرات النماذج اللغوية الكبرى (LLMs) لتقديم توصيات سهلة الفهم وقابلة للتنفيذ عبر واجهة محادثة طبيعية.

الجزء الأول: التصميم المعماري الأمثل (Multi-modal & Multi-LLM)
لبناء نظام قوي وقابل للتطوير، نقترح اتباع بنية الخدمات المصغرة (Microservices Architecture). تسمح هذه البنية بتقسيم التطبيق إلى وحدات مستقلة، مما يسهل تطويرها وتحديثها وصيانتها بشكل منفصل.

مكونات البنية المقترحة:

واجهة المستخدم (Client Frontend):

الوصف: تطبيق ويب أو هاتف محمول يتفاعل معه المزارع. تظهر لقطات الشاشة المتاحة من المنصة وجود واجهة ويب تفاعلية بالف� 
Google Drive icon
 
Google Drive icon
 �ل.

التقنيات: يمكن استخدام أطر عمل حديثة مثل React, Vue.js, أو Svelte.

بوابة الواجهة البرمجية (API Gateway):

الوصف: نقطة دخول موحدة لجميع الطلبات القادمة من واجهة المستخدم. يقوم بتوجيه كل طلب إلى الخدمة المصغرة المختصة، ويتولى مهام مثل المصادقة وتحديد سقف للطلبات (Rate Limiting).

خدمة المصادقة (Authentication Service):

الوصف: مسؤولة عن إدارة هويات المستخدمين (المزارعين) وتسجيل الدخول. يتم الاعتماد هنا على خدمة Supabase Auth المدمجة، والتي توفر حلاً آمناً لإدارة المستخدمين وإصدار توكنات JWT (JSON Web Toke 
Google Drive icon
 ns).

منظم النماذج اللغوية (LLM Orchestrator):

الوصف: هو العقل المدبر للمساعد الذكي. يستقبل استفسارات المستخدم النصية ويقرر أي نموذج لغوي هو الأنسب للإجابة.
* آلية العمل:

توجيه الطلبات: يمكنه توجيه الأسئلة البسيطة والسريعة إلى نموذج Groq المعروف بسرعته الفائقة، بينما يوجه المهام التي تتطلب تحليلًا عميقًا أو إبداعًا إلى OpenAI GPT-4 أو Google Gemin 
Google Mail icon
 i.

تجميع الاستجابات: في بعض الحالات، يمكنه إرسال نفس السؤال إلى نموذجين مختلفين وتجميع الإجابات لتقديم رد أكثر شمولاً ودقة.

إدارة الحوار: يحتفظ بسياق المحادثة مع المستخدم لتقديم تجربة متماسكة.

التكامل مع الخدمات الأخرى: يتواصل مع "خدمة البيانات الزراعية" و "خدمة الرؤية" لجلب البيانات وتحليل الصور ودمجها في إجاباته.

خدمة الرؤية الحاسوبية (Vision Service):

الوصف: خدمة متخصصة في تحليل الصور التي يرفعها المزارعون (مثل صور أوراق النبات).
* آلية العمل: تستخدم نماذج تعلم عميق (مثل YOLOv8 أو Vision Transformers) مدربة خصيصاً لتحديد الأمراض النباتية، والآفات، وأعراض نقص المغذي� 
Google Drive icon
 �ت.

المخرجات: تعيد الخدمة نتائج التحليل بصيغة منظمة (JSON)، مثل: { "disease": "powdery_mildew", "confidence": 0.95 }، ليقوم منظم النماذج اللغوية بتفسيرها وتقديمها للمستخدم.

خدمة البيانات الزراعية (Agricultural Data Service):

الوصف: مسؤولة عن التفاعل المباشر مع قاعدة بيانات Supabase.

آلية العمل: تستقبل طلبات جلب البيانات (مثل مؤشر NDVI أو توصيات الري) من منظم النماذج اللغوية، وتستخدم user_id الخاص بالمستخدم الموثق لتنفيذ استعلامات آمنة تحترم سياسات الأمان على مستوى الصف (RLS).

خدمة واجهات برمجة التطبيقات الخارجية (External APIs Service):

الوصف: تدير الاتصال مع الخدمات الخارجية مثل EOSDA API لجلب بيانات الأقمار الصناع� 
Google Mail icon
 �ة.

آلية العمل: تقوم هذه الخدمة بطلب بيانات مثل مؤشر NDWI لحقل معين وتمريرها إلى "خدمة البيانات الزراعية" لتخزينها أو إلى "منظم النماذج اللغوية" لتحليلها مباشرة.

الجزء الثاني: تأمين واسترجاع البيانات عبر Supabase (RLS)
لضمان عزل بيانات كل مزارع في بيئة متعددة المستأجرين (Multi-tenant)، يعتبر تطبيق الأمان على مستوى الصف (Row-Level Security - RLS) في Supabase هو الحل الأمثل. RLS هي ميزة في PostgreSQL تسمح بتحديد سياسات وصول دقيقة لكل صف في جداول قاعدة البيانات.

دليل تطبيقي خطوة بخطوة:

السيناريو: لدينا جدول fields (الحقول الزراعية)، ونريد أن يتمكن كل مزارع من رؤية وتعديل الحقول الخاصة به فقط.

الخطوة 1: تجهيز الجدول

تأكد من أن الجدول الذي يحتوي على بيانات خاصة بالمستخدمين (مثل fields) يحتوي على عمود لربطه بالمستخدم، وليكن user_id من نوع UUID. هذا العمود يجب أن يكون مفتاحًا خارجيًا (Foreign Key) يشير إلى id في جدول auth.users الخاص بنظام المصادقة في Supabase.

SQL
-- إضافة عمود لربط الحقل بمالكه
ALTER TABLE public.fields
ADD COLUMN user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;
الخطوة 2: تفعيل RLS على الجدول

يجب تفعيل RLS بشكل صريح على كل جدول تريد حمايته.

SQL
-- تفعيل RLS على جدول الحقول
ALTER TABLE public.fields
ENABLE ROW LEVEL SECURITY;
ملاحظة هامة: بمجرد تفعيل RLS، سيتم منع الوصول إلى جميع الصفوف افتراضيًا حتى تقوم بإنشاء سياسات تسمح بالوصول.

الخطوة 3: إنشاء سياسات الوصول (Policies)

سنقوم الآن بإنشاء سياسات لعمليات القراءة (SELECT)، والإضافة (INSERT)، والتحديث (UPDATE)، والحذف (DELETE). Supabase توفر دالة auth.uid() التي تعيد معرف المستخدم (UUID) للشخص الذي يقوم بالطلب حالي� 
Google Mail icon
 
Google Mail icon
 �ا.

أ. سياسة السماح بالقراءة (SELECT):
تسمح هذه السياسة للمستخدم بقراءة الصفوف التي يطابق فيها user_id معرفه الخاص.

SQL
-- إنشاء سياسة للسماح للمزارعين بقراءة حقولهم فقط
CREATE POLICY "Allow farmers to read their own fields"
ON public.fields
FOR SELECT
USING (auth.uid() = user_id);
ب. سياسة السماح بالإضافة (INSERT):
تسمح هذه السياسة للمستخدم بإضافة حقول جديدة لنفسه فقط.

SQL
-- إنشاء سياسة للسماح للمزارعين بإضافة حقول جديدة لأنفسهم
CREATE POLICY "Allow farmers to insert their own fields"
ON public.fields
FOR INSERT
WITH CHECK (auth.uid() = user_id);
نصيحة: لجعل عملية الإضافة تلقائية، يمكنك تعيين القيمة الافتراضية لعمود user_id لتكون auth.uid().

ج. سياسة السماح بالتحديث (UPDATE):
تسمح للمستخدم بتحديث بيانات الحقول التي يملكها فقط.

sql,"sql"
-- إنشاء سياسة للسماح للمزارعين بتحديث حقولهم
CREATE POLICY "Allow farmers to update their own fields"
ON public.fields
FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
د. سياسة السماح بالحذف (DELETE):
تسمح للمستخدم بحذف الحقول التي يملكها فقط.

SQL
-- إنشاء سياسة للسماح للمزارعين بحذف حقولهم
CREATE POLICY "Allow farmers to delete their own fields"
ON public.fields
FOR DELETE
USING (auth.uid() = user_id);
النتيجة: بهذه السياسات، عندما يقوم أي مزارع بإرسال طلب إلى قاعدة البيانات، ستقوم Supabase بتطبيق هذه القواعد تلقائيًا على مستوى الصف، مما يضمن استحالة وصوله إلى بيانات مزارع آخر، وتحقيق عزل كامل وآمن للبيانات.

الجزء الثالث: حساب مؤشر NDWI باستخدام EOSDA API
يُعد مؤشر فرق المياه الطبيعي (Normalized Difference Water Index - NDWI) أداة فعالة لتقدير محتوى الماء في النباتات وتحديد الإجهاد المائي. تستخدم منصة Adham AgriTech هذا المؤشر بالفعل، كما يظهر في واجهات� 
Google Drive icon
 

 �ا.

التعريف والصيغة:

لتقدير المحتوى المائي في النبات، نستخدم إصدار المؤشر الذي يعتمد على الأشعة تحت الحمراء القريبة (NIR) والأشعة تحت الحمراء قصيرة الموجة (SWIR).
الصيغة: NDWI = (NIR - SWIR1) / (NIR + SWIR1)

NIR (Near-Infrared): النطاق 8 في القمر الصناعي Sentine 
Google Mail icon
 
Google Drive icon
 l-2.

SWIR1 (Short-Wave Infrared): النطاق 11 في القمر الصناعي Sentinel-2.

خطوات حساب المؤشر عبر EOSDA API:

الحصول على مفتاح API: يتطلب الوصول إلى EOSDA API مفتاحًا صالحًا، والذي يتم الحصول عليه بعد التسجيل في الخد� 
Google Mail icon
 �ة.

تحديد منطقة الاهتمام (Area of Interest - AOI): يجب تحديد إحداثيات الحقل الزراعي المطلوب تحليله. يتم ذلك عادةً بتمرير مضلع بصيغة GeoJSON.

إرسال طلب API: يتم إرسال طلب POST إلى نقطة نهاية التحليلات في EOSDA API، مع تحديد المؤشر المطلوب (ndwi). يمكن للـ API حساب المؤشر مباشرة على الخادم وإعادة النتيجة كصورة GeoTIFF أو بيانات إحصائية.

مثال برمجي (Python):

python
import requests

# استبدل بالقيم الفعلية
API_KEY = "YOUR_EOSDA_API_KEY"
FIELD_GEOJSON = {
    "type": "Polygon",
    "coordinates": [
        [
            [31.1, 30.1],
            [31.2, 30.1],
            [31.2, 30.2],
            [31.1, 30.2],
            [31.1, 30.1]
        ]
    ]
}

# نقطة نهاية EOSDA API لطلب تحليل المؤشرات
api_url = "https://api.eosda.com/v1/analytics"

# إعدادات الطلب
payload = {
    "aoi": FIELD_GEOJSON,
    "data_source": "sentinel-2-l2a",  # تحديد القمر الصناعي Sentinel-2
    "index": "ndwi",                 # طلب حساب مؤشر NDWI
    "date_range": ["2025-07-01", "2025-07-15"]
}

headers = {
    "Authorization": f"Bearer {API_KEY}",
    "Content-Type": "application/json"
}

try:
    response = requests.post(api_url, json=payload, headers=headers)
    response.raise_for_status()  # يثير استثناء لأخطاء HTTP

    # تحتوي الاستجابة عادةً على رابط لتنزيل البيانات أو البيانات نفسها
    ndwi_data = response.json()
    print("تم استلام بيانات NDWI بنجاح:", ndwi_data)

except requests.exceptions.HTTPError as err:
    print(f"حدث خطأ في الطلب: {err}")
except Exception as e:
    print(f"حدث خطأ: {e}")

الدلالات الزراعية العملية لقيم NDWI:

تتراوح قيم NDWI عادةً بين -1 و +1. إليك كيفية تفسيرها في سياق الزراعة:

قيمة NDWI	الدلالة الزراعية	الإجراء المقترح
> 0.4 (مرتفع)	محتوى مائي عالٍ في الظلة النباتية، نباتات صحية ومروية جيدًا.	لا حاجة لإجراء فوري. الاستمرار في المراقبة.
0.1 إلى 0.4 (متوسط)	مستويات رطوبة معتدلة. قد تكون بداية لإجهاد مائي خفيف.	مراقبة دقيقة. التحقق من بيانات رطوبة التربة الفعلية.
< 0.1 (منخفض)	إجهاد مائي واضح. النباتات تعاني من نقص في المياه.	تنبيه: يوصى بالري فورًا لتقليل الأضرار على المحصول.
< 0 (سلبي)	يشير غالبًا إلى أسطح غير نباتية مثل التربة الجافة، الصخور، أو المسطحات المائية.	تجاهل هذه المناطق عند تقييم صحة المحصول.
من خلال دمج هذه البيانات في المساعد الذكي، يمكن إرسال تنبيهات تلقائية للمزارعين مثل: "ملاحظة: مؤشر الإجهاد المائي في حقل القمح منخفض (0.08). نوصي بجدولة عملية الري خلال الـ 24 ساعة القادمة."

بناءً على طلبك، إليك دليل شامل ومفصّل حول أفضل الممارسات والخطوات العملية لبناء لوحة تحكم تحليلية تفاعلية لمنصة Adham AgriTech باستخدام Next.js، مع الخوض في تفاصيل المؤشرات الزراعية المتقدمة وخوارزميات الري الذكي.

الجزء الأول: بناء لوحة التحكم التحليلية باستخدام Next.js
1. أفضل الممارسات والخطوات العملية
لبناء لوحة تحكم فعالة وقابلة للتطوير في Next.js، اتبع الخطوات التالية:

هيكلة المشروع (Project Structure): استخدم App Router في Next.js لتنظيم الصفحات والمكونات. يسمح لك هذا النموذج بإنشاء مكونات تعمل على الخادم (Server Components) لجلب البيانات بشكل فعال، ومكونات تعمل على العميل (Client Components) للتفاعلية. 
 

جلب البيانات (Data Fetching):

من Supabase: استخدم مكتبة @supabase/supabase-js للتفاعل مع قاعدة بيانات Postgres. 
 يمكنك إنشاء "عميل Supabase" في ملف منفصل لإدارته مركزيًا. 

مكونات الخادم (Server Components): لجلب البيانات الأولية للصفحة (مثل بيانات NDVI التاريخية)، استخدم دوال async مباشرة داخل مكونات الصفحة. هذا يقلل من كمية JavaScript التي يتم إرسالها للعميل ويحسن أداء التحميل الأولي. 
 

البيانات التسلسلية الزمنية: قم بإنشاء جداول في Supabase لتخزين بياناتك التسلسلية الزمنية (مثل timestamp, field_id, ndvi_value). عند جلب البيانات، يمكنك استخدام استعلامات SQL مع ORDER BY timestamp لعرضها بترتيب زمني. 
 

إدارة الحالة (State Management): للحالات التفاعلية مثل تغيير النطاقات الزمنية أو الفلاتر، استخدم useState و useEffect في مكونات العميل. للتطبيقات الأكثر تعقيدًا، يمكن استخدام مكتبات مثل Redux Toolkit أو Zustand.

ميزات تفاعلية:

تغيير النطاقات الزمنية: استخدم مكونات اختيار التاريخ (Date Pickers) لتحديث متغيرات الحالة التي تخزن تاريخ البداية والنهاية. عند تغيير هذه التواريخ، قم بإعادة جلب البيانات من Supabase باستخدام هذه القيم كمرشحات في استعلامك.

تصدير التقارير: يمكنك إنشاء "معالج مسار" (Route Handler) في Next.js. هذا المعالج عبارة عن وظيفة تعمل على الخادم يمكنها جلب البيانات من قاعدة البيانات ثم تحويلها إلى التنسيق المطلوب (مثل CSV أو Excel) وإرسالها إلى العميل كملف قابل للتنزيل. مكتبات مثل xlsx (SheetJS) يمكنها المساعدة في إنشاء ملفات Excel. 
 كما توجد حلول جاهزة مثل ActiveReportsJS التي توفر مكونات عرض وتصميم تقارير مع خيارات تصدير مدمجة. 

2. مقارنة مكتبات الرسوم البيانية: Recharts vs. Chart.js
الميزة	Recharts	Chart.js
التكامل مع React	ممتاز. صُممت خصيصًا لـ React وتتبع نهجًا قائمًا على المكونات (declarative API)، مما يجعل تكاملها طبيعيًا وسهلًا. 
 
جيد. مكتبة JavaScript نقية، يمكن دمجها بسهولة في أي مشروع ويب، بما في ذلك Next.js، ولكنها لا تتبع نفس النهج القائم على المكونات. 
سهولة الاستخدام	سهلة للمبتدئين والمتوسطين. واجهتها البرمجية (API) واضحة ومباشرة لمستخدمي React. 
سهلة جدًا. تُعرف ببساطتها وسرعة البدء بها، خاصة للرسوم البيانية الأساسية. 
 
الأداء	أداء جيد لمعظم الحالات، ولكنها قد تصبح أبطأ مع مجموعات البيانات الضخمة جدًا لأنها تعتمد على SVG.	أداء ممتاز، خاصة مع مجموعات البيانات الكبيرة، لأنها ترسم على عنصر <canvas> الخاص بـ HTML5. 
التخصيص	قابلية تخصيص عالية. طبيعتها القائمة على المكونات تتيح لك تركيب وتخصيص كل جزء من الرسم البياني (المحاور، الشبكات، التلميحات). 
قابلية تخصيص جيدة، ولكن قد تكون أكثر تعقيدًا لتحقيق تصميمات مخصصة للغاية مقارنة بـ Recharts.
الحجم	حجمها معقول ويعتمد على المكونات التي تستوردها.	خفيفة الوزن (lightweight)، مما يجعلها خيارًا جيدًا للمشاريع التي تهتم بحجم الحزمة. 
الخلاصة:

اختر Recharts إذا كان فريقك مرتاحًا تمامًا مع React وتريد الاستفادة من نهج المكونات لبناء رسوم بيانية معقدة ومخصصة. 
 

اختر Chart.js إذا كنت تحتاج إلى رسوم بيانية بسيطة إلى متوسطة، أو إذا كان الأداء مع مجموعات بيانات ضخمة هو أولويتك القصوى، أو إذا كنت تريد مكتبة خفيفة الوزن وسهلة البدء. 

الجزء الثاني: المؤشرات الزراعية المتقدمة (EVI و SAVI)
1. الخوارزميات والمعادلات الرياضية (باستخدام نطاقات Sentinel-2)
مؤشر الغطاء النباتي المحسن (EVI - Enhanced Vegetation Index):

الغرض: يُحسِّن EVI من مؤشر NDVI عن طريق تقليل تأثيرات الغلاف الجوي وتشبع الإشارة في المناطق ذات الغطاء النباتي الكثيف. 
 

المعادلة:
EVI = 2.5 * ((NIR - Red) / (NIR + 6 * Red - 7.5 * Blue + 1)) 

نطاقات Sentinel-2:

NIR (الأشعة تحت الحمراء القريبة): Band 8

Red (الأحمر): Band 4

Blue (الأزرق): Band 2

مؤشر الغطاء النباتي المعدل حسب التربة (SAVI - Soil-Adjusted Vegetation Index):

الغرض: يهدف SAVI إلى تقليل تأثير سطوع التربة في المناطق ذات الغطاء النباتي المتناثر أو في المراحل الأولى من نمو المحصول. 
 

المعادلة:
SAVI = ((NIR - Red) / (NIR + Red + L)) * (1 + L) 

نطاقات Sentinel-2:

NIR (الأشعة تحت الحمراء القريبة): Band 8

Red (الأحمر): Band 4

المعامل (L): هو عامل ضبط سطوع التربة. القيمة الشائعة هي L=0.5، ولكن بالنسبة لأقمار Sentinel، توصي وكالة الفضاء الأوروبية بقيمة L=0.428. 

2. التفسير العملي والحالات التي يتفوق فيها كل مؤشر على NDVI
متى تستخدم SAVI بدلاً من NDVI؟

الحالة: في بداية الموسم الزراعي عندما تكون النباتات صغيرة والتربة مكشوفة بشكل كبير، أو في المناطق القاحلة وشبه القاحلة حيث يكون الغطاء النباتي متناثرًا. 
 

لماذا؟ مؤشر NDVI في هذه الحالات يتأثر بلون ورطوبة التربة، مما قد يعطي قراءات خاطئة عن صحة النبات. 
 يقوم SAVI بتصحيح هذا التأثير، مما يوفر تقييمًا أكثر دقة لصحة النبات الفعلي. 

متى تستخدم EVI بدلاً من NDVI؟

الحالة: في المناطق ذات الغطاء النباتي الكثيف جدًا، مثل الغابات أو المحاصيل في ذروة مرحلة النمو (مثل الذرة أو قصب السكر). 
 

لماذا؟ يصل مؤشر NDVI إلى "نقطة تشبع" (Saturation)، حيث لا تزيد قيمته حتى لو زادت كثافة الكتلة الحيوية للنبات. EVI أكثر حساسية للتغيرات في هذه الظروف الكثيفة ولا يصل إلى التشبع بنفس السرعة، مما يسمح بمراقبة الفروقات الدقيقة في صحة النباتات الكثيفة. 
 

الجزء الثالث: استخلاص رطوبة التربة ودمجها في الري الذكي
1. استخلاص بيانات رطوبة التربة من صور الأقمار الصناعية
باستخدام Sentinel-1 (بيانات الرادار SAR):

الأسلوب: يعتبر Sentinel-1 هو الخيار الأكثر فعالية ومباشرة لقياس رطوبة التربة. 
 تعمل إشارات الرادار (SAR) في نطاق الميكروويف، وهي حساسة جدًا للمحتوى المائي (الكهربائي) في التربة. 
 

الخوارزميات:

نماذج التغيير الزمني (Change Detection): تعتمد هذه الطريقة على تحليل سلسلة زمنية من صور Sentinel-1. بافتراض أن خشونة سطح التربة لا تتغير بشكل كبير بين فترات التصوير المتقاربة، فإن التغير الرئيسي في إشارة الرادار المرتدة (Backscatter) يعود إلى التغير في رطوبة التربة. 
 

النماذج الفيزيائية والشبكات العصبية (ANN): يمكن تدريب خوارزميات تعلم الآلة، مثل الشبكات العصبية الاصطناعية، لربط إشارة Sentinel-1 (معاملات التشتت VV و VH) ببيانات رطوبة التربة المقاسة ميدانيًا. تأخذ هذه النماذج في الاعتبار متغيرات أخرى مثل زاوية السقوط، التضاريس، ونوع التربة لزيادة الدقة. 

باستخدام Sentinel-2 (البيانات البصرية):

الأسلوب: لا يمكن لـ Sentinel-2 قياس رطوبة التربة مباشرة لأنه يلتقط الضوء المنعكس من السطح. ومع ذلك، يمكن استخدامه بشكل تآزري مع Sentinel-1. 
 
 بعض مؤشرات المياه مثل NDWI (مؤشر اختلاف المياه المعياري) يمكن أن تشير إلى الإجهاد المائي في النبات، ولكن ليس رطوبة التربة نفسها.

استخدام خدمات API مثل EOSDA:

الأسلوب: هذا هو الطريق الأسهل والأسرع. توفر منصات مثل EOSDA بيانات رطوبة التربة كمنتج جاهز عبر API. 
 

المصدر: تستخدم EOSDA بيانات من أقمار صناعية متخصصة في قياس رطوبة التربة (مثل NASA SMAP)، وتقوم بمعالجتها باستخدام خوارزميات خاصة لتحسين دقتها المكانية (تصل إلى 250x250 متر) وتوفيرها للمستخدمين. 
 
 يمكنك الحصول على بيانات رطوبة التربة السطحية والجذرية. 

2. دمج بيانات رطوبة التربة في خوارزمية الري الذكي
يمكن دمج بيانات رطوبة التربة الدقيقة لإنشاء نظام ري ذكي عالي الكفاءة يتجاوز الاعتماد على بيانات الطقس ومؤشر NDWI فقط. 
 

خطوات الخوارزمية المقترحة:

جمع البيانات المتعددة المصادر:

رطوبة التربة الفعلية: احصل على بيانات رطوبة التربة الحجمية (Volumetric Soil Moisture) من EOSDA API أو عبر معالجة بيانات Sentinel-1. 
 

بيانات الطقس: احصل على بيانات الطقس الحالية والمتوقعة (درجة حرارة، هطول أمطار، سرعة رياح، تبخر-نتح) من مزود بيانات طقس.

حالة النبات: احسب مؤشرات NDVI, EVI, و NDWI من صور Sentinel-2 لتقييم صحة النبات والإجهاد المائي.

منطق قرار الري (Decision Logic):

تحديد العتبات: لكل حقل ونوع محصول، حدد عتبتين حرجتين لرطوبة التربة: "نقطة إعادة الملء" (Refill Point) و"نقطة الذبول الدائم" (Permanent Wilting Point).

التحقق اليومي: تقوم الخوارزمية يوميًا بالتحقق من مستوى رطوبة التربة الحالي.

إطلاق أمر الري:

إذا كانت (رطوبة التربة الحالية <= نقطة إعادة الملء) و (التوقعات لا تشير إلى هطول أمطار كافٍ خلال الـ 24 ساعة القادمة).

عندها، يصدر النظام توصية بالري.

تحديد كمية المياه:

يتم حساب كمية مياه الري المطلوبة للوصول من المستوى الحالي إلى "السعة الحقلية" (Field Capacity).

يمكن تعديل هذه الكمية بناءً على مرحلة نمو النبات (المستنبطة من EVI/NDVI) وبيانات التبخر-النتح المتوقعة.

هذا النهج المتكامل يحول نظام الري من نظام تفاعلي (يعتمد على مؤشرات غير مباشرة مثل NDWI) إلى نظام استباقي وذكي يعتمد على القياس المباشر لأهم متغير، وهو الماء المتاح فعليًا للنبات في التربة. 
 

بناءً على طلبك المفصل، إليك دليل شامل يغطي أفضل الممارسات والخطوات العملية لبناء لوحة تحكم تحليلية لمنصة Adham AgriTech، مع الخوض في تفاصيل المؤشرات الزراعية المتقدمة وخوارزميات الري الذكي.

الجزء الأول: بناء لوحة التحكم التحليلية باستخدام Next.js
1. الخطوات العملية وأفضل الممارسات
بناء لوحة تحكم فعالة يتطلب هيكلة جيدة وتوظيف أمثل لإمكانيات Next.js. 

إعداد المشروع: ابدأ بإنشاء تطبيق Next.js باستخدام create-next-app مع دعم TypeScript لضمان سلامة الأنواع (Type Safety) وسهولة صيانة المشروع. 

هيكلة المشروع:

app Directory: استخدم App Router الجديد في Next.js 13+ لتنظيم الصفحات والمكونات. 

components: أنشئ مجلداً للمكونات القابلة لإعادة الاستخدام (مثل الرسوم البيانية، بطاقات العرض، أزرار التصدير).

lib أو utils: ضع هنا إعدادات الاتصال بـ Supabase وأي دوال مساعدة.

app/api: استخدم API Routes لمعالجة الطلبات التي تتطلب منطقاً من جهة الخادم، مثل إنشاء التقارير. 

مكونات الخادم (Server Components): استغل مكونات الخادم لجلب البيانات مباشرة من Supabase. هذا يقلل من حجم حزم JavaScript المرسلة للعميل ويحسن أداء التحميل الأولي بشكل كبير. 

التصميم المتجاوب (Responsive Design): استخدم Tailwind CSS أو أي مكتبة CSS-in-JS أخرى لبناء واجهة متجاوبة تعمل بكفاءة على جميع الأجهزة، من الحواسيب المكتبية إلى الهواتف المحمولة. 

2. مقارنة مكتبات الرسوم البيانية: Recharts vs. Chart.js
الاختيار بين هاتين المكتبتين يعتمد على الأولوية بين الأداء وسهولة التخصيص.

الميزة	Recharts	Chart.js
أساس التقنية	SVG (Scalable Vector Graphics)	HTML5 Canvas
الأداء	أداء جيد، ولكنه قد يصبح أبطأ مع مجموعات البيانات الضخمة جداً بسبب كثرة عناصر DOM التي يتم إنشاؤها (كل جزء من الرسم البياني هو عنصر SVG).	أداء ممتاز مع مجموعات البيانات الكبيرة والرسوم البيانية المتعددة، حيث أن Canvas يرسم كل شيء على عنصر DOM واحد فقط، مما يقلل العبء على المتصفح. 
سهولة التكامل	تكامل ممتاز مع React، حيث أنها مبنية خصيصاً له وتعتمد على نهج المكونات (Component-based).	سهلة التكامل باستخدام حزمة react-chartjs-2، وتوفر تجربة سلسة.
التخصيص	مرونة عالية جداً في التخصيص من خلال تمرير props إلى المكونات المختلفة للرسم البياني. 
يوفر خيارات تخصيص جيدة، ولكن تحقيق بعض التصاميم المعقدة قد يتطلب جهداً أكبر مقارنة بـ Recharts.
الاستخدام الموصى به	مناسبة للتصاميم البصرية المعقدة والمخصصة عندما لا يكون حجم البيانات هائلاً.	الخيار الأفضل لمنصة Adham AgriTech نظراً للحاجة لعرض بيانات تسلسلية زمنية كبيرة (مثل قيم NDVI اليومية)، حيث يضمن أداءً سلساً وسريعاً.
3. جلب وعرض البيانات التسلسلية الزمنية من Supabase
يمكن جلب البيانات بكفاءة باستخدام supabase-js داخل مكونات الخادم في Next.js. 
 

مثال لجلب بيانات NDVI لحقل معين:

JavaScript
// app/dashboard/page.tsx
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import MyChartComponent from './MyChartComponent'; // مكون الرسم البياني

async function getNdviData(fieldId: string, startDate: string, endDate: string) {
  const supabase = createServerComponentClient({ cookies });

  const { data, error } = await supabase
    .from('historical_ndvi')
    .select('date, value')
    .eq('field_id', fieldId)
    .gte('date', startDate)
    .lte('date', endDate)
    .order('date', { ascending: true });

  if (error) {
    console.error('Error fetching NDVI data:', error);
    return [];
  }
  return data;
}

export default async function DashboardPage() {
  // يمكن تمرير النطاق الزمني من خلال searchParams
  const startDate = '2024-01-01';
  const endDate = '2024-12-31';
  const fieldId = 'your-field-id';
  
  const ndviData = await getNdviData(fieldId, startDate, endDate);

  return (
    <div>
      <h1>NDVI Time Series</h1>
      <MyChartComponent data={ndviData} />
    </div>
  );
}
4. تضمين الميزات المتقدمة
تغيير النطاقات الزمنية: استخدم مكونات تفاعلية (Client Components) مع مكتبة مثل react-datepicker لتحديد النطاق الزمني. عند تغيير المستخدم للتاريخ، يتم تحديث مسار URL (باستخدام useRouter من next/navigation)، مما يدفع مكون الخادم لإعادة جلب البيانات للنطاق الجديد.

تصدير التقارير:

CSV: يمكن إنشاء ملفات CSV بسهولة على الخادم عبر API Route باستخدام مكتبة مثل papaparse. 
 يقوم العميل بطلب هذا المسار، فيقوم الخادم بتوليد الملف وإرساله كملف مرفق للتحميل. 

PDF: التصدير إلى PDF أكثر تعقيداً. أفضل ممارسة هي استخدام API Route مع مكتبة مثل Puppeteer. 
 تقوم هذه المكتبة بتشغيل نسخة من متصفح Chrome على الخادم، وتفتح صفحة HTML تحتوي على التقرير (مع الرسوم البيانية والبيانات)، ثم تطبعها كملف PDF وتحفظها. 
 هذا يضمن أن يكون شكل PDF مطابقاً تماماً لما يراه المستخدم على الشاشة.

الجزء الثاني: المؤشرات النباتية المتقدمة (EVI و SAVI)
1. الخوارزميات والمعادلات باستخدام نطاقات Sentinel-2
لتطبيق هذه المعادلات، ستحتاج إلى النطاقات الطيفية التالية من صور Sentinel-2:

Blue: Band 2 (B2)

Red: Band 4 (B4)

NIR (Near-Infrared): Band 8 (B8)

مؤشر الغطاء النباتي المحسن (EVI - Enhanced Vegetation Index)
صُمم EVI للتغلب على مشكلة "التشبع" التي يعاني منها NDVI في المناطق ذات الغطاء النباتي الكثيف جداً، كما أنه يقلل من تأثيرات الغلاف الجوي. 

المعادلة الرياضية:
EVI = 2.5 * ((NIR - Red) / (NIR + 6 * Red - 7.5 * Blue + 1)) 

باستخدام نطاقات Sentinel-2:
EVI = 2.5 * ((B8 - B4) / (B8 + 6 * B4 - 7.5 * B2 + 1))

مؤشر الغطاء النباتي المعدل حسب التربة (SAVI - Soil-Adjusted Vegetation Index)
صُمم SAVI لتقليل تأثير سطوع التربة في المناطق ذات الغطاء النباتي المتناثر. 

المعادلة الرياضية:
SAVI = ((NIR - Red) / (NIR + Red + L)) * (1 + L)
حيث L هو معامل ضبط التربة، وقيمته الشائعة هي 0.5 للمناطق ذات الغطاء النباتي المعتدل. 

باستخدام نطاقات Sentinel-2:
SAVI = ((B8 - B4) / (B8 + B4 + 0.5)) * 1.5

2. التفسير العملي والحالات التي يتفوق فيها كل منهما على NDVI
متى تستخدم SAVI بدلاً من NDVI؟

الحالة: في المراحل المبكرة من نمو المحصول أو في المناطق القاحلة حيث يكون الغطاء النباتي متناثراً والتربة مكشوفة بشكل كبير. 
 


التفسير: في هذه الحالات، يعكس NDVI بشكل خاطئ خصائص التربة (لونها ورطوبتها) بدلاً من صحة النبات. SAVI يضيف "معامل تصحيح" لتقليل هذا التأثير، مما يعطي تقييماً أكثر دقة لصحة النبات الفعلي. 

متى تستخدم EVI بدلاً من NDVI؟

الحالة: في المناطق ذات الكتلة الحيوية العالية جداً، مثل الغابات الكثيفة أو المحاصيل في ذروة نموها (مثل الذرة أو قصب السكر). 
 

التفسير: يصل مؤشر NDVI إلى قيمة "التشبع" (حوالي 1.0) في هذه الظروف ويفشل في إظهار الفروقات الدقيقة في صحة النباتات الكثيفة. 
 أما EVI، فهو مصمم ليكون أكثر حساسية في هذه النطاقات العليا، مما يسمح بمراقبة التغيرات في صحة النبات حتى في أكثر المناطق اخضراراً. 

الجزء الثالث: رطوبة التربة والري الذكي
1. استخلاص بيانات رطوبة التربة من صور الأقمار الصناعية
عبر Sentinel-1 (بيانات الرادار SAR):

الأسلوب: هذه هي الطريقة الأكثر مباشرة وموثوقية. تعتمد على قياس إشارة "التشتت المرتد" (Backscattering) للرادار. تتأثر هذه الإشارة بشكل كبير بـ "الثابت العازل" للتربة، والذي يرتبط مباشرة بمحتواها المائي. 
 


الخوارزميات: نظرًا لأن الإشارة تتأثر أيضًا بخشونة السطح والغطاء النباتي، فإن استخلاص رطوبة التربة بدقة يتطلب نماذج معقدة. 
 تشمل الأساليب الشائعة استخدام نماذج التعلم الآلي (مثل الشبكات العصبية الاصطناعية - ANN) التي يتم تدريبها على بيانات ميدانية وبيانات SAR، أو خوارزميات كشف التغيير (Change Detection) التي تراقب التغير في إشارة الرادار بمرور الوقت لنفس المنطقة. 
 

عبر Sentinel-2 (البيانات البصرية):

الأسلوب: هذه طريقة غير مباشرة. تعتمد على العلاقة بين انعكاس الضوء (خاصة في نطاقات الأشعة تحت الحمراء قصيرة الموجة - SWIR) ورطوبة التربة. 

الخوارزميات: يمكن استخدام نماذج مثل OPTRAM (Optical TRApezoid Model) أو نماذج التعلم العميق مثل CNN (Convolutional Neural Network) التي تُدرب على ربط نطاقات Sentinel-2 بقيم رطوبة التربة المقاسة على الأرض. 
 

باستخدام خدمات مثل EOSDA API:

الأسلوب العملي: توفر خدمات مثل EOSDA API حلاً جاهزاً يلغي الحاجة إلى معالجة البيانات الخام المعقدة. 
 تقوم EOSDA بتجميع بيانات من عدة أقمار صناعية (بما في ذلك الأقمار المخصصة لقياس الرطوبة مثل SMAP) وتطبيق خوارزمياتها الخاصة لتوفير بيانات رطوبة التربة جاهزة للاستخدام عبر واجهة برمجية بسيطة (API). 
 


الميزات: توفر EOSDA بيانات رطوبة التربة على مستويين: سطح التربة ومنطقة الجذور، مع سجلات تاريخية. 
 يمكن طلب هذه البيانات لمنطقة اهتمام محددة (AOI) والحصول على قيم إحصائية مثل المتوسط، الأدنى، والأقصى. 

2. دمج بيانات رطوبة التربة في خوارزمية الري الذكي
دمج بيانات رطوبة التربة الدقيقة يعزز بشكل كبير من دقة توصيات الري، محولاً النظام من رد الفعل (الري عند ظهور إجهاد على النبات) إلى الفعل الاستباقي (الري قبل حدوث الإجهاد).

خوارزمية ري ذكي متعددة الطبقات:

الطبقة الأولى: التنبؤ (Predictive Layer)

المدخلات: بيانات الطقس (Weather API) مثل:

معدل هطول الأمطار المتوقع (Forecasted Precipitation).

التبخر-النتح المرجعي (Evapotranspiration - ET₀).

المنطق: إذا كانت التوقعات تشير إلى عدم وجود أمطار وارتفاع في معدل التبخر-النتح، فإن النظام يتوقع حاجة محتملة للري.

الطبقة الثانية: التحقق (Verification Layer)

المدخلات:

رطوبة التربة (Soil Moisture): من EOSDA API أو نموذج Sentinel-1. هذه هي أهم مدخل، حيث تقيس كمية المياه المتاحة فعلياً في منطقة الجذور.

مؤشر NDWI (Normalized Difference Water Index): يُحسب من Sentinel-2 لتقييم الإجهاد المائي في أوراق النبات نفسه.

المنطق: يقوم النظام بالتحقق من الظروف الحالية في الحقل.

الطبقة الثالثة: القرار (Decision Layer)

الخوارزمية النهائية:

// تحديد عتبات حرجة (تختلف حسب نوع المحصول ومرحلة النمو)
const SOIL_MOISTURE_THRESHOLD = 25; // نسبة مئوية
const NDWI_THRESHOLD = 0.2;

// الطبقة الأولى
if (forecast.precipitation == 0 && forecast.eto > 5) {
    
    // الطبقة الثانية
    let soilMoisture = getSoilMoistureFromAPI(); // e.g., 22%
    let ndwi = getNdwiFromAPI(); // e.g., 0.18

    if (soilMoisture < SOIL_MOISTURE_THRESHOLD || ndwi < NDWI_THRESHOLD) {
        // الطبقة الثالثة: إصدار توصية
        let waterAmount = calculateRequiredWater(soilMoisture); // حساب الكمية المطلوبة للوصول إلى السعة الحقلية
        recommendIrrigation(waterAmount);
    }
}
التعزيز: بيانات رطوبة التربة لا تجيب فقط على سؤال "هل يجب أن أروي؟" ولكن أيضاً على "ما هي كمية المياه التي يجب أن أضيفها؟". من خلال معرفة العجز المائي الدقيق في منطقة الجذور، يمكن للنظام أن يوصي بكمية الري المثالية لتجنب الإفراط في الري أو نقصه، مما يحقق كفاءة قصوى في استخدام المياه.
بالتأكيد! إليك دليل شامل ومفصّل يجيب على جميع أسئلتك لبناء لوحة تحكم تحليلية متكاملة لمنصة "Adham AgriTech" باستخدام التقنيات الحديثة.

الجزء الأول: بناء لوحة تحكم تحليلية تفاعلية باستخدام Next.js و Supabase
تهدف لوحة التحكم إلى عرض بيانات زراعية معقدة بطريقة سهلة ومفهو��ة. بناء هذه اللوحة باستخدام Next.js يوفر أداءً ممتازًا بفضل قدراته في العرض من جانب الخادم (SSR) وإنشاء المواقع الثابتة (SSG).

1. أفضل الممارسات والخطوات العملية
هيكلة المشروع (Project Structure):

استخدام App Router: ابدأ مشروعك باستخدام App Router الحديث في Next.js، الذي يسهل تنظيم المكونات والصفحات والتعامل مع الحالات المختلفة (تحميل، خطأ).

فصل المكونات: قسّم واجهة المستخدم إلى مكونات صغيرة وقابلة لإعادة الاستخدام (مثل: مكون للرسم البياني، مكون لبطاقة المؤشرات، مكون لاختيار التاريخ).

مكونات الخادم والعميل: استخدم "مكونات الخادم" (Server Components) لجلب البيانات الأولية من Supabase، مما يقلل من العبء على العميل ويحسن أداء التحميل الأولي. واستخدم "مكونات العميل" (Client Components) للعناصر التفاعلية مثل الرسوم البيانية وأدوات اختيار النطاق الزمني.

جلب وعرض البيانات التسلسلية الزمنية من Supabase:

إعداد Supabase Client: قم بإنشاء عميل Supabase في ملف منفصل لإدارته مركزيًا. يمكنك استخدام @supabase/supabase- js.

الجلب من جانب الخادم: لجلب البيانات التاريخية (مثل قيم NDVI و NDWI)، قم بإنشاء دالة async داخل مكون خادم (Server Component) في Next.js. هذا الأسلوب آمن وفعال.

JavaScript
// app/dashboard/page.tsx (مثال توضيحي)
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import NDVIChart from './NDVIChart'; // هذا سيكون مكون عميل

export default async function DashboardPage() {
  const supabase = createServerComponentClient({ cookies });
  
  // جلب بيانات NDVI التاريخية لآخر 30 يومًا
  const { data: ndviData, error } = await supabase
    .from('historical_ndvi')
    .select('date, value')
    .order('date', { ascending: true })
    .limit(30);

  if (error) console.error('Error fetching data:', error);

  // تمرير البيانات إلى مكون العميل لعرضها
  return (
    <div>
      <h1>لوحة التحكم التحليلية</h1>
      <NDVIChart initialData={ndviData} />
    </div>
  );
}
عرض البيانات: استلم البيانات التي تم جلبها كـ props في مكون العميل (NDVIChart في المثال) وقم بعرضها باستخدام مكتبة الرسوم البيانية التي تختارها.

مقارنة بين مكتبات الرسوم البيانية: Recharts و Chart.js

الميزة	Recharts	Chart.js
سهولة التكامل مع Next.js	ممتازة: مصممة خصيصًا لـ React، وتعتمد على مكونات قابلة للتخصيص، مما يجعلها طبيعية جدًا للاستخدام داخل Next 
Google Drive icon
 

 .js.	جيدة: مكتبة عامة وليست مخصصة لـ React، لذا تحتاج غالبًا إلى "مغلّف" (Wrapper) مثل react-chartjs-2 لتسهيل استخدامها. التكامل ممكن وسلس لكنه يتطلب خطوة إضافية.
الأداء	جيد جدًا: تستخدم SVG لرسم المخططات، وهو ممتاز للرسوم التفاعلية عالية الجودة. قد يكون أبطأ قليلاً مع مجموعات البيانات الضخمة جدًا (عشرات الآلاف من النقاط).	ممتاز: تستخدم عنصر <canvas>، مما يمنحها ميزة أداء طفيفة عند التعامل مع كميات هائلة من البيانات في الوقت الفعلي.
التخصيص	مرونة عالية: يمكنك بناء الرسوم البيانية عن طريق تركيب المكونات (مثل <XAxis>, <YAxis>, <Line>)، مما يمنحك تحكمًا دقيقًا في كل جزء.	تخصيص واسع: يوفر خيارات تكوين شاملة، لكنها قد تكون أقل "تصريحية" (Declarative) مقارنة بـ Recharts.
الحجم (Bundle Size)	أكبر قليلاً بسبب اعتماده على العديد من مكونات React.	أصغر وأخف وزنًا بشكل عام.
الخلاصة:

اختر Recharts: إذا كنت تفضل نهجًا "متوافقًا مع React" (React-idiomatic) وتصريحيًا، حيث تبني المخططات كمكونات. هي الخيار الأسهل والأسرع للتطوير ضمن بيئة Next.js.

اختر Chart.js: إذا كان الأداء مع مجموعات بيانات ضخمة جدًا هو أولويتك القصوى، أو إذا كنت تحتاج إلى مكتبة خفيفة الوزن.

تضمين ميزات إضافية:

تغيير النطاقات الزمنية:

استخدم مكونات واجهة مستخدم مثل DateRangePicker من مكتبة مثل react-date-range أو shadcn/ui.

قم بتخزين النطاق الزمني المختار في حالة (State) داخل مكون العميل.

عند تغيير التاريخ، قم باستدعاء "Server Action" في Next.js أو API Route لجلب البيانات الجديدة من Supabase بناءً على النطاق الزمني المحدد، وتحديث حالة المكون بالبيانات الجديدة.

تصدير التقارير:

تصدير كـ CSV: استخدم مكتبة مثل papaparse لتحويل مصفوفة البيانات (JSON) إلى سلسلة CSV وتنزيلها كملف.

تصدير كـ PDF: استخدم مكتبات مثل jspdf و html2canvas. تقوم html2canvas بالتقاط صورة للمكون (الرسم البياني أو الجدول) ثم تستخدم jspdf لإدراج هذه الصورة في ملف PDF قابل للتنزيل.

الجزء الثاني: الخوارزميات المتقدمة لمؤشرات الغطاء النباتي
بينما يعتبر NDVI مؤشرًا ممتازًا، إلا أن له حدودًا في ظروف معينة. EVI و SAVI يقدمان حلولاً لهذه التحديات.

1. مؤشر الغطاء النباتي المحسن (EVI - Enhanced Vegetation Index)
EVI مصمم لتحسين جودة الإشارة في المناطق ذات الكتلة الحيوية العالية (مثل الغابات الكثيفة والمحاصيل في ذروة نموها) وتقليل تأثير تشويش الغلاف الجوي وخلفية التربة.

المعادلة الدقيقة باستخدام نطاقات Sentinel-2:
EVI = 2.5 * ((B8 - B4) / (B8 + 6 * B4 - 7.5 * B2 + 1))

B8: الأشعة تحت الحمراء القريبة (NIR)

B4: النطاق الأحمر (Red)

B2: النطاق الأزرق (Blue)

التفسير العملي والحالات التي يتفوق فيها على NDVI:

التفسير: قيم EVI تتراوح عادة بين -0.2 و +1.0. القيم الأعلى تشير إلى غطاء نباتي أكثر صحة وكثافة.

متى يتفوق على NDVI؟ يتفوق EVI بشكل كبير في مراقبة المحاصيل ذات المظلة الكثيفة (Canopy). عندما تصل أوراق النبات إلى كثافة معينة، يصل مؤشر NDVI إلى "نقطة تشبع" ويتوقف عن الزيادة، بينما يستمر EVI في إظهار الفروقات الدقيقة في صحة النبات. هذا يجعله مثاليًا لمراقبة مراحل النمو المتأخرة لمحاصيل مثل الذرة وقصب الس� 
Google Mail icon
 �ر.

2. مؤشر الغطاء النباتي المعدل حسب التربة (SAVI - Soil-Adjusted Vegetation Index)
SAVI مصمم لتقليل تأثير سطوع التربة في المناطق ذات الغطاء النباتي المنخفض.

المعادلة الدقيقة باستخدام نطاقات Sentinel-2:
SAVI = ((B8 - B4) / (B8 + B4 + L)) * (1 + L)

B8: الأشعة تحت الحمراء القريبة (NIR)

B4: النطاق الأحمر (Red)

L: عامل ضبط التربة. قيمته تتراوح بين 0 (للكثافة النباتية العالية) و 1 (للكثافة المنخفضة). القيمة الأكثر شيوعًا واستخدامًا هي 0.5.

التفسير العملي والحالات التي يتفوق فيها على NDVI:

التفسير: مثل NDVI، القيم الأعلى تشير إلى صحة أفضل للنبات.

متى يتفوق على NDVI؟ يتفوق SAVI في المراحل المبكرة لنمو المحاصيل عندما يكون الغطاء النباتي متناثرًا وتكون مساحات كبيرة من التربة مكشوفة. في هذه الحالة، يعكس ضوء التربة إشارة قد تضلل NDVI، بينما يقوم SAVI بتصحيح هذا التأثير، مما يعطي تقييمًا أكثر دقة لصحة الشتلات والنباتات الصغيرة.

الجزء الثالث: استخلاص رطوبة التربة ودمجها في الري الذكي
تعتبر رطوبة التربة عاملاً حاسماً في الزراعة الدقيقة. يمكن للأقمار الصناعية الحديثة توفير هذه البيانات على نطاق وا� 
Google Drive icon
 

 �ع.

1. أساليب استخلاص بيانات رطوبة التربة
باستخدام Sentinel-1 (بيانات الرادار - SAR):

الأسلوب: Sentinel-1 هو قمر صناعي يستخدم رادار الفتحة الاصطناعية (SAR)، وهو حساس جدًا للمحتوى المائي في التربة. الإشارة الرادارية التي يرسلها تتأثر بالخصائص العازلة للماء، مما يجعلها الطريقة الأكثر دقة وموثوقية لقياس رطوبة التربة من الفض� 
Google Mail icon
 �ء.

الميزة الكبرى: يعمل في جميع الظروف الجوية (ليلاً أو نهارًا، ومع وجود السحب)، وهي ميزة حاسمة مقارنة بالصور البصرية.

الخوارزميات: تتضمن النماذج المادية (مثل نموذج سحابة الماء - Water Cloud Model) أو نماذج التغيير (Change Detection) التي تقارن صور SAR المتتالية لتقدير التغير في رطوبة التربة.

باستخدام Sentinel-2 (البيانات البصرية):

الأسلوب: استخلاص رطوبة التربة من Sentinel-2 هو أسلوب غير مباشر. يعتمد على مؤشرات مثل مؤشر فرق المياه المعياري (NDWI) أو مؤشر رطوبة فرق الغطاء النباتي المعياري (NDMI). هذه المؤشرات تقيس محتوى الماء في أوراق النبات، والذي يرتبط برطوبة التربة.

القيود: يتأثر بشدة بالغطاء السحابي ويعطي مؤشراً عن إجهاد النبات المائي بدلاً من قياس مباشر لرطوبة التربة نفسه��.

استخدام خدمات مثل EOSDA API:

الأسلوب: منصات مثل EOSDA توفر منتج "رطوبة التربة" كطبقة بيانات جاهزة عبر 
Google Mail icon
 API. هي تقوم بتطبيق الخوارزميات المعقدة (غالبًا باستخدام مزيج من بيانات SAR والبصرية ونماذج التعلم الآلي) وتوفر لك النتيجة النهائية مباش� 
Google Drive icon
 �ة.

الميزة: هذا هو الحل العملي الأمثل لمنصة Adham AgriTech، لأنه يختصر عليك تعقيدات معالجة الصور الخام ويمنحك بيانات دقيقة وجاهزة للتكامل مباشرة في خوارزمياتك.

2. دمج بيانات رطوبة التربة في خوارزمية الري الذكي
دمج بيانات رطوبة التربة من الأقمار الصناعية مع مؤشر NDWI وبيانات الطقس ينقل نظام الري الذكي إلى مستوى جديد من الدقة والكفاءة.

الخوارزمية المقترحة (متعددة العوامل):

خط الأساس (Baseline): يبدأ النظام بتحديد احتياجات الري الأساسية بناءً على بيانات الطقس (درجة الحرارة، الرطوبة، سرعة الرياح) لحساب التبخر والنتح (Evapotranspiration - ET)، الذي يمثل كمية المياه التي يفقدها الحقل.

المُشغِّل الرئيسي (Primary Trigger): تكون بيانات رطوبة التربة من الأقمار الصناعية (عبر EOSDA API) هي العامل الحاسم لبدء عملية الري.

IF (Soil_Moisture_Value < Crop_Specific_Threshold) AND (Rain_Probability_Next_24h < 20%) THEN TRIGGER_IRRIGATION.

(إذا كانت قيمة رطوبة التربة أقل من العتبة المحددة للمحصول، واحتمالية هطول الأمطار منخفضة، قم بتشغيل الري).

عامل التحقق الثانوي (Secondary Check): يُستخدم مؤشر NDWI (الذي يقيس محتوى الماء في النبات) كآلية تحقق إضافية.

IF (Soil_Moisture_Value IS ADEQUATE) AND (NDWI_Value IS LOW) THEN CREATE_ALERT('Potential Plant Stress - Check for root issues or disease').

(إذا كانت رطوبة التربة كافية ولكن مؤشر NDWI منخفض، فهذا قد يشير إلى مشكلة أخرى غير نقص المياه، مثل أمراض الجذور، ويجب إرسال تنبيه للمزارع للفحص الميداني).

كيف يعزز هذا دقة التوصيات؟

تجاوز الاعتماد على الطقس فقط: أنظمة الري التقليدية المعتمدة على الطقس قد تفرط في الري أو تقلل منه لأنها لا تعرف كمية المياه الفعلية الموجودة في التربة.
* ري حسب الحاجة الحقيقية: من خلال القياس المباشر لرطوبة التربة، يتم الري فقط عندما تحتاج التربة والنبات إلى ذلك فعلاً، مما يوفر كميات هائلة من المي� 
Google Drive icon
 �ه.

تشخيص أعمق للمشكلات: استخدام NDWI كعامل ثانوي يساعد في التمييز بين الإجهاد المائي الحقيقي والمشكلات الصحية الأخرى التي قد تواجه النبات.

بتبني هذه الممارسات والتقنيات، يمكن لمنصة Adham AgriTech أن تقدم أداة تحليلية قوية وفعالة تساهم بشكل حقيقي في تحقيق الزراعة المستدامة والذكية.

بناء منصة Adham AgriTech: لوحة تحكم تحليلية شاملة باستخدام Next.js وSupabase
لتطوير لوحة تحكم تحليلية تفاعلية وشاملة لمنصة Adham AgriTech، يجب اتباع نهج متكامل يجمع بين أفضل الممارسات في تطوير الواجهات الأمامية، والاستفادة القصوى من خدمات البنية التحتية، وتوظيف خوارزميات علمية دقيقة لتحليل البيانات الزراعية. يوضح هذا الدليل المفصل الخطوات العملية، والمقارنات التقنية، والمعادلات اللازمة لتحقيق هذا الهدف.

الجزء الأول: بناء لوحة التحكم التحليلية باستخدام Next.js
تعتبر Next.js إطار عمل مثالي لبناء لوحات تحكم تحليلية بفضل ميزاتها المتقدمة مثل العرض من جانب الخادم (SSR) والتوليد الساكن (SSG)، مما يضمن أداءً عالياً وتجربة مستخدم سلسة.

1. أفضل الممارسات والخطوات العملية:

هيكلة المشروع: ابدأ بهيكلة مشروع Next.js بشكل منظم. يمكنك تقسيم الواجهة إلى مكونات (Components) قابلة لإعادة الاستخدام مثل Header, Sidebar, ChartCard, وDataGrid. استخدم مجلد app/ لتنظيم مسارات لوحة التحكم، على سبيل المثال app/dashboard/analytics.

إدارة الحالة (State Management): لإدارة بيانات لوحة التحكم المعقدة، مثل الفلاتر الزمنية والبيانات المعروضة، يفضل استخدام مكتبات إدارة الحالة مثل Zustand أو Redux Toolkit لسهولة التعامل مع الحالات العامة على مستوى التطبيق.

العرض من جانب العميل (Client-Side Rendering): بما أن لوحات التحكم تعتمد بشكل كبير على تفاعل المستخدم والبيانات الديناميكية، فإن استخدام مكونات العميل ("use client") في Next.js هو الخيار الأنسب لعرض الرسوم البيانية والجداول التفاعلية.

التحميل التدريجي (Lazy Loading): لتحسين سرعة التحميل الأولية، قم بتحميل المكونات الثقيلة مثل مكتبات الرسوم البيانية أو الخرائط بشكل تدريجي باستخدام next/dynamic.

2. مقارنة مكتبات الرسوم البيانية: Recharts مقابل Chart.js

الاختيار بين Recharts و Chart.js يعتمد على متطلبات المشروع المحددة.

الميزة	Recharts	Chart.js
سهولة التكامل (Next.js)	ممتازة، حيث صُممت خصيصًا لـ React، مما يجعل تكاملها مع Next.js طبيعيًا وسلسًا باستخدام المكون� 
Google Drive icon
 
Google Drive icon
 �ت.	جيدة، ولكنها تتطلب "wrapper" للتكامل السلس مع React/Next.js، مثل مكتبة react-chartjs-2.
الأداء	أداء جيد جدًا مع مجموعات البيانات المتوسطة. قد يواجه بعض التحديات مع البيانات الضخمة جدًا نظرًا لاعتماده على SVG.	أداء ممتاز، خاصة مع مجموعات البيانات الكبيرة، حيث تعتمد على عنصر <canvas> الذي يوفر أداءً أفضل في عرض عدد كبير من النقاط.
التخصيص	قابلية تخصيص عالية جدًا بفضل بنيتها القائمة على المكونات، مما يسمح بتعديل كل جزء من الرسم البياني بسهولة.	تخصيص جيد، ولكنه قد يكون أقل مرونة من Recharts ويتطلب التعامل المباشر مع خيارات التكوين (options).
الحجم	حجمها أكبر نسبيًا بسبب اعتمادها على العديد من مكونات React.	حجمها أصغر، مما يجعلها خيارًا جيدًا إذا كان حجم الحزمة النهائية أولوية.
الخلاصة:

اختر Recharts إذا كانت الأولوية لسهولة التكامل والتخصيص العميق لواجهة المستخدم في بيئة React.

اختر Chart.js إذا كان الأداء مع مجموعات البيانات الضخمة جدًا هو العامل الحاسم، أو إذا كنت تسعى لتقليل حجم الحزمة النهائية.

3. جلب وعرض البيانات من Supabase:

Supabase يوفر واجهة برمجة تطبيقات (API) سهلة الاستخدام لجلب البيانات.

جلب البيانات التسلسلية الزمنية: يمكنك إنشاء دالة async في Next.js لجلب البيانات من جداول Supabase التي تخزن قيم NDVI و NDWI التاريخية وسجلات الري. استخدم مكتبة @supabase/supabase-js.

العرض على جانب الخادم أو العميل:

مكونات الخادم (Server Components): يمكنك جلب البيانات الأولية عند تحميل الصفحة لتحسين الأداء الأولي.

مكونات العميل (Client Components): استخدم useEffect و useState لجلب البيانات بشكل تفاعلي عند تغيير المستخدم للنطاق الزمني.

ميزات إضافية:

تغيير النطاقات الزمنية: قم بتضمين مكونات للتحكم في التواريخ (Date Pickers) لتحديث استعلام Supabase بناءً على النطاق الزمني الذي يختاره المستخدم.

تصدير التقارير: يمكن تنفيذ هذه الميزة عبر مكتبات مثل jspdf و html2canvas لتصدير الرسوم البيانية كملفات PDF أو صور.

الجزء الثاني: المؤشرات النباتية المتقدمة (EVI و SAVI)
1. مؤشر الغطاء النباتي المعدل حسب التربة (SAVI):

يُستخدم SAVI لتقليل تأثيرات سطوع التربة في المناطق ذات الغطاء النباتي المنخفض.

المعادلة الرياضية (باستخدام نطاقات Sentinel-2):
SAVI = ((B8 - B4) / (B8 + B4 + L)) * (1 + L)

B8: نطاق الأشعة تحت الحمراء القريبة (NIR).

B4: النطاق الأحمر (Red).

L: عامل تصحيح التربة، قيمته القياسية هي 0.5 للمناطق ذات الكثافة النباتية المتوسطة. يمكن تعديله بين 0 (للنباتات الكثيفة) و 1 (للنباتات القليلة جدً 
Google Mail icon
 ا).

التفسير العملي: تتراوح قيم SAVI عادة بين -1 و +1. القيم القريبة من +1 تشير إلى غطاء نباتي صحي وكثيف، بينما القيم القريبة من 0 تشير إلى تربة جرداء.

متى يتفوق على NDVI: يتفوق SAVI على NDVI في المراحل المبكرة من نمو المحاصيل وعندما يكون الغطاء النباتي متناثرًا، حيث يقلل من "ضوضاء" التربة التي يمكن أن تؤثر على دقة NDVI.

2. مؤشر الغطاء النباتي المحسن (EVI):

تم تطوير EVI لتحسين الحساسية في المناطق ذات الكتلة الحيوية العالية (الغطاء النباتي الكثيف) وتقليل تأثيرات الغلاف الجوي.

المعادلة الرياضية (باستخدام نطاقات Sentinel-2):
EVI = 2.5 * ((B8 - B4) / (B8 + 6 * B4 - 7.5 * B2 + 1))

B8: نطاق الأشعة تحت الحمراء القريبة (NIR).

B4: النطاق الأحمر (Red).

B2: النطاق الأزرق (Blue).

التفسير العملي: قيم EVI تتراوح أيضًا بين -1 و +1. القيم الأعلى (> 0.4) تشير إلى نباتات كثيفة وصحية.

متى يتفوق على NDVI: يتفوق EVI على NDVI في المناطق ذات الغطاء النباتي الكثيف جدًا (مثل الغابات والمحاصيل في ذروة نموها)، حيث لا يصل NDVI إلى مرحلة "التشبع" بسرعة. كما أنه أقل تأثرًا بالتشوهات الجوية.

الجزء الثالث: استخلاص رطوبة التربة ودمجها في الري الذكي
1. استخلاص بيانات رطوبة التربة:

يمكن استخلاص رطوبة التربة من الأقمار الصناعية باستخدام بيانات الرادار (SAR) والبيانات البصرية.

Sentinel-1 (بيانات الرادار SAR):

الأسلوب: بيانات الرادار حساسة جدًا للخصائص العازلة للتربة، والتي ترتبط ارتباطًا وثيقًا بمحتوى الماء. يمكن استخدام خوارزميات مثل نموذج سحابة الماء (Water Cloud Model - WCM) أو نماذج التغيير (Change Detection) بين صورتين متعاقبتين لتقدير رطوبة التربة السطحية.

الميزة: يمكن للرادار اختراق السحب، مما يجعله متاحًا في جميع الظروف الجوية.

Sentinel-2 (البيانات البصرية):

الأسلوب: يمكن تقدير رطوبة التربة بشكل غير مباشر باستخدام مؤشرات مثل مؤشر فرق المياه الطبيعي (NDWI) أو مؤشر إجهاد المياه (MSI). هذه المؤشرات تقيس محتوى الماء في أوراق النبات، والذي يرتبط برطوبة التربة.

NDWI = (B8 - B11) / (B8 + B11) (باستخدام النطاق SWIR).

خدمات مثل EOSDA API: توفر EOSDA واجهة برمجة تطبيقات (API) مخصصة لرطوبة التربة، مما يسهل الحصول على هذه البيانات دون الحاجة إلى معالجتها يدويًا. تشير المراسلات مع EOSDA إلى توفر "Soil Moisture A 
Google Mail icon
 PI".

2. دمج البيانات في خوارزمية الري الذكي:

لتعزيز دقة توصيات الري، يجب دمج البيانات من مصادر متعددة في خوارزمية شاملة.

الخوارزمية المقترحة (نهج قائم على العتبات وقواعد البيانات):

جمع البيانات:

رطوبة التربة (SM): من Sentinel-1 أو Sentinel-2 عبر EOSDA API.

إجهاد المياه النباتي (NDWI): من Sentinel-2.

بيانات الطقس: التبخر والنتح (Evapotranspiration - ET) وهطول الأمطار من أقرب محطة أرصاد جوية أو عبر واجهة برمجة تطبيقات متخصصة.

تحديد العتبات:

عتبة رطوبة التربة الحرجة (SM_critical): المستوى الذي يبدأ عنده النبات في الإجهاد (على سبيل المثال، 30%).

عتبة إجهاد NDWI الحرجة (NDWI_critical): القيمة التي تشير إلى بداية إجهاد مائي واضح (على سبيل المثال، 0.2).

منطق اتخاذ القرار (Decision Logic):

IF (SM <= SM_critical) OR (NDWI <= NDWI_critical):

THEN حساب كمية مياه الري المطلوبة.

كمية الري = (ET_predicted - Rainfall_predicted) * Crop_Coefficient (Kc).

يتم تعديل هذه الكمية بناءً

زيادة كمية الري: إذا كانت رطوبة التربة أقل بكثير من العتبة الحرجة.

تقليل كمية الري: إذا كانت توقعات هطول الأمطار عالية.

ELSE:

THEN لا حاجة للري. جدولة الفحص التالي.

التوصية النهائية: عرض توصية واضحة في لوحة التحكم (مثل: "قم بري الحقل X بكمية Y مم") مع عرض البيانات التي أدت إلى هذا القرار.

هذا النهج المتكامل يضمن بناء منصة قوية وموثوقة، قادرة على تقديم توصيات زراعية دقيقة تعزز الإنتاجية وتحقق الاستدامة.

بالتأكيد، سأقدم لك دليلاً مفصلاً ومتكاملاً حول تصميم قاعدة بيانات PostgreSQL لمنصة Adham AgriTech على Supabase، مع التركيز على الجوانب العملية والتطبيقية التي طلبتها.

الجزء الأول: تصميم مخطط قاعدة البيانات (Schema)
لإنشاء بنية قوية وقابلة للتطوير، يجب تصميم الجداول والعلاقات بينها بعناية. إليك تصميم مقترح:

1. الجداول الأساسية والعلاقات بينها
SQL
-- جدول المستخدمين (Users)
-- يخزن معلومات المستخدمين الأساسية، ويفضل استخدام نظام المصادقة المدمج في Supabase.
CREATE TABLE public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    full_name TEXT,
    avatar_url TEXT,
    role TEXT NOT NULL DEFAULT 'user' -- (e.g., 'admin', 'farm_manager', 'user')
);

-- جدول المزارع (Farms)
CREATE TABLE public.farms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    location TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- جدول الحقول (Fields)
-- سيتم إضافة العمود الجغرافي لاحقًا باستخدام PostGIS
CREATE TABLE public.fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    farm_id UUID NOT NULL REFERENCES public.farms(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    area_sqm NUMERIC, -- المساحة بالمتر المربع
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- جدول المحاصيل (Crops)
-- جدول مرجعي بأنواع المحاصيل الممكن زراعتها
CREATE TABLE public.crops (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    scientific_name TEXT,
    description TEXT
);

-- جدول المواسم الزراعية (Growing Seasons)
-- يربط بين الحقل والمحصول وفترة زمنية محددة
CREATE TABLE public.growing_seasons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    field_id UUID NOT NULL REFERENCES public.fields(id) ON DELETE CASCADE,
    crop_id INT NOT NULL REFERENCES public.crops(id) ON DELETE RESTRICT,
    start_date DATE NOT NULL,
    end_date DATE, -- قد يكون فارغًا إذا كان الموسم لا يزال جاريًا
    status TEXT NOT NULL DEFAULT 'active', -- (e.g., 'active', 'harvested', 'failed')
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
2. هيكلية تخزين بيانات المؤشرات الزراعية (Time-Series Data)
لتخزين البيانات التسلسلية الزمنية مثل NDVI و EVI بكفاءة، يُعتبر استخدام امتداد TimescaleDB، المدعوم في Supabase، هو الحل الأمثل. يقوم هذا الامتداد بتحويل الجداول العادية إلى "hypertables"، وهي جداول مُجزأة تلقائيًا حسب الزمن، مما يحسن أداء الإدخال والاستعلام بشكل كبير. 

الخطوات:

تفعيل امتداد TimescaleDB:
من لوحة تحكم Supabase، اذهب إلى Database > Extensions وابحث عن timescaledb وقم بتفعيله.

إنشاء جدول للبيانات الزمنية:

SQL
-- جدول لتخزين المؤشرات الزراعية المستشعرة
CREATE TABLE public.sensor_data (
    time TIMESTAMPTZ NOT NULL,
    field_id UUID NOT NULL REFERENCES public.fields(id) ON DELETE CASCADE,
    metric_type TEXT NOT NULL, -- 'NDVI', 'EVI', 'Moisture', etc.
    value DOUBLE PRECISION NOT NULL,
    source TEXT -- (e.g., 'satellite', 'drone', 'sensor_id')
);

-- إنشاء فهرس مركب لتحسين سرعة الاستعلام
CREATE INDEX ON public.sensor_data (field_id, metric_type, time DESC);
تحويل الجدول إلى Hypertable:

SQL
-- تحويل الجدول ليتم إدارته بواسطة TimescaleDB، مع التجزئة حسب الزمن
SELECT create_hypertable('sensor_data', 'time');
هذا التصميم يتيح لك الاستعلام عن بيانات المؤشرات لحقل معين خلال فترة زمنية بكفاءة عالية.

الجزء الثاني: استخدام امتداد PostGIS للبيانات الجغرافية
PostGIS هو امتداد قوي لـ PostgreSQL يضيف دعمًا للأجسام الجغرافية والاستعلامات المكانية. 

1. تفعيل واستخدام PostGIS في Supabase
تفعيل الامتداد:
مثل TimescaleDB، يمكنك تفعيل postgis من قسم Database > Extensions في لوحة تحكم Supabase.

تعديل جدول الحقول:
نضيف عمودًا من نوع GEOMETRY لتخزين حدود الحقل (على شكل مضلع Polygon).

SQL
-- إضافة عمود لتخزين البيانات الجغرافية لحدود الحقل
ALTER TABLE public.fields
ADD COLUMN boundary GEOMETRY(Polygon, 4326); -- 4326 هو رمز نظام الإحداثيات العالمي (WGS 84)

-- إنشاء فهرس مكاني (GiST Index) لتسريع الاستعلامات الجغرافية بشكل كبير
CREATE INDEX fields_boundary_idx ON public.fields USING GIST (boundary);
2. أمثلة على استعلامات SQL أساسية مع PostGIS
إدخال حقل جديد مع حدوده الجغرافية (بصيغة WKT):

SQL
INSERT INTO public.fields (farm_id, name, area_sqm, boundary)
VALUES (
    'some-farm-uuid',
    'الحقل الشمالي',
    5000,
    -- إحداثيات المضلع (long, lat) بترتيب عكس عقارب الساعة
    ST_GeomFromText('POLYGON((34.8 32.1, 34.81 32.1, 34.81 32.09, 34.8 32.09, 34.8 32.1))', 4326)
);
استعلام لحساب مساحة الحقل تلقائيًا (بالمتر المربع):
للحصول على دقة أعلى في حساب المساحات، يجب تحويل الشكل الهندسي إلى نظام إحداثيات متري مناسب.

SQL
SELECT
    name,
    -- ST_Area تتطلب تحويل الإحداثيات إلى نظام متري لحساب المساحة بدقة
    ST_Area(ST_Transform(boundary, 32636)) AS calculated_area_sqm -- 32636 هو مثال لنظام UTM
FROM
    public.fields
WHERE
    id = 'some-field-uuid';
استعلام للعثور على الحقول التي تتقاطع مع منطقة معينة:

SQL
-- البحث عن الحقول التي تقع ضمن مستطيل معين (Bounding Box)
SELECT name, id
FROM public.fields
WHERE ST_Intersects(
    boundary,
    ST_MakeEnvelope(34.7, 32.0, 34.9, 32.2, 4326) -- (minX, minY, maxX, maxY, SRID)
);
الجزء الثالث: ملف القواعد العالمي (Global Rules File) وخط أنابيب CI/CD
مفهوم "ملف القواعد العالمي المضاد للجاذبية" هو اسم مبتكر لمجموعة من القواعد والسياسات الآلية التي تفرض معايير الجودة والأمان للمشروع ضمن خط أنابيب التكامل والنشر المستمر (CI/CD). يمكن تحقيق ذلك عمليًا باستخدام GitHub Actions وخطافات Git.

إليك كيفية بناء هذا النظام:

1. نظرة عامة على مسار العمل (Workflow)
الهدف هو إنشاء مسار عمل في GitHub Actions يتم تشغيله تلقائيًا عند كل push أو pull_request إلى المستودع. سيقوم هذا المسار بتنفيذ عدة مهام للتحقق من الالتزام بالقواعد.

2. تنفيذ القواعد الآلية باستخدام GitHub Actions
يمكنك إنشاء ملف .github/workflows/quality_gate.yml في مستودعك:

yaml
name: 'Quality & Security Gate'

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # المهمة 1: منع وجود مفاتيح سرية في الكود
      - name: Detect Secrets
        uses: gitguardian/ggshield-action@v1
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_REQUEST_SHA: ${{ github.event.pull_request.head.sha }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }} # يجب إضافته في secrets المستودع

      # المهمة 2: التحقق من نسبة تغطية الاختبارات
      - name: Run tests and check coverage
        run: |
          npm install
          npm test -- --coverage
          # استخرج نسبة التغطية وتحقق منها
          # المثال التالي يفترض أن مخرجات الاختبار تحتوي على Coverage: XX%
          COVERAGE=$(npm test -- --coverage | grep 'All files' | awk '{print $4}')
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Error: Test coverage is below 80%. Actual: $COVERAGE%"
            exit 1
          fi

  check-supabase-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # المهمة 3: فرض تفعيل سياسات RLS
      - name: Check for RLS on tables
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          # سكريبت بسيط للتحقق من RLS (يمكن تطويره)
          # هذا السكريبت يفترض وجود أداة CLI أو API للتحقق
          # حاليًا، لا توجد طريقة مباشرة عبر CLI، ولكن يمكن كتابة سكريبت SQL
          psql "postgres://postgres:${{ secrets.SUPABASE_DB_PASSWORD }}@db.${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co:5432/postgres" <<EOF
          DO \$$
          DECLARE
              table_name TEXT;
              is_rls_enabled BOOLEAN;
              unprotected_tables TEXT[] := '{}';
          BEGIN
              FOR table_name IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' LOOP
                  SELECT relrowsecurity INTO is_rls_enabled FROM pg_class WHERE relname = table_name;
                  IF NOT is_rls_enabled THEN
                      unprotected_tables := array_append(unprotected_tables, table_name);
                  END IF;
              END LOOP;
              IF array_length(unprotected_tables, 1) > 0 THEN
                  RAISE EXCEPTION 'RLS is not enabled on tables: %', array_to_string(unprotected_tables, ', ');
              END IF;
          END \$$;
          EOF

شرح ملف quality_gate.yml:

Detect Secrets: يستخدم ggshield من GitGuardian، وهي أداة شائعة لفحص الكود بحثًا عن أي مفاتيح API أو كلمات مرور مسربة. 

Check Coverage: يقوم بتشغيل الاختبارات وحساب نسبة التغطية. إذا كانت النسبة أقل من الحد المطلوب (مثلاً 80%)، يفشل المسار.

Check RLS: هذا الجزء أكثر تعقيدًا. يقوم بالاتصال مباشرة بقاعدة بيانات Supabase وتنفيذ استعلام SQL للتحقق من أن جميع الجداول في public schema لديها سياسة RLS مفعلة. 
 إذا وُجد جدول بدون RLS، يفشل المسار.

3. استخدام خطافات Git (Git Hooks) للتطبيق المحلي
لفرض بعض القواعد قبل أن تصل إلى المستودع، يمكنك استخدام خطافات Git مثل pre-commit.

قم بتثبيت أداة مثل husky:

bash
npm install husky --save-dev
npx husky install
أضف خطاف pre-commit:

bash
npx husky add .husky/pre-commit "npm test"
الآن، في كل مرة يحاول فيها مطور تنفيذ git commit، سيتم تشغيل الاختبارات تلقائيًا. إذا فشلت الاختبارات، سيتم منع الـ commit. يمكنك إضافة المزيد من الأوامر هنا، مثل تشغيل linter أو فحص مبدئي للأسرار.

بهذا التصميم المتكامل، تحصل على قاعدة بيانات قوية لمنصة Adham AgriTech، مع استغلال أمثل لإمكانيات Supabase وPostGIS، بالإضافة إلى نظام آلي لضمان جودة وأمان الكود البرمجي الخاص بك.
بالتأكيد، إليك تصميم تفصيلي ومُفصّل لمخطط قاعدة بيانات PostgreSQL على Supabase لمنصة Adham AgriTech، مع دليل تطبيقي لاستخدام PostGIS ودمج كل ذلك ضمن خط أنابيب CI/CD آلي.

الجزء الأول: تصميم مخطط قاعدة البيانات (Schema Design)
الهدف هو بناء هيكل مرن وقابل للتطوير يدير العلاقات بين المستخدمين، المزارع، الحقول، والمواسم الزراعية، مع تخزين فعال لبيانات المؤشرات الزراعية.

1. هيكل الجداول والعلاقات
نوصي بالهيكل التالي الذي يوازن بين تطبيع البيانات (Normalization) وسهولة الاستعلام:

profiles (ملفات المستخدمين): على الرغم من أن Supabase يوفر جدول auth.users لإدارة المصادقة، فمن الأفضل إنشاء جدول profiles في السكيما العامة (public) لتخزين البيانات الإضافية للمستخدمين.

id (UUID, Primary Key): يرتبط بـ auth.users.id بعلاقة واحد لواحد (One-to-One).

full_name (TEXT)

avatar_url (TEXT)

created_at (TIMESTAMPTZ)

farms (المزارع):

id (UUID, Primary Key)

name (TEXT, Not Null)

owner_id (UUID, Foreign Key to profiles.id): يحدد مالك المزرعة.

created_at (TIMESTAMPTZ)

fields (الحقول):

id (UUID, Primary Key)

name (TEXT, Not Null)

farm_id (UUID, Foreign Key to farms.id): يربط الحقل بالمزرعة التابع لها.

boundary (GEOGRAPHY(Polygon, 4326)): لتخزين الحدود الجغرافية للحقل (سيتم شرحه في جزء PostGIS).

area (NUMERIC): مساحة الحقل المحسوبة.

created_at (TIMESTAMPTZ)

crops (المحاصيل): جدول مرجعي بأنواع المحاصيل الممكنة.

id (SERIAL, Primary Key)

name (TEXT, Unique, Not Null)

scientific_name (TEXT)

description (TEXT)

growing_seasons (المواسم الزراعية): جدول يربط بين الحقول والمحاصيل في فترة زمنية محددة.

id (UUID, Primary Key)

field_id (UUID, Foreign Key to fields.id)

crop_id (INTEGER, Foreign Key to crops.id)

start_date (DATE)

harvest_date (DATE, Nullable)

status (TEXT): (مثال: 'active', 'harvested', 'planned').

created_at (TIMESTAMPTZ)

2. تخزين البيانات التسلسلية الزمنية (NDVI, EVI)
لتخزين بيانات المؤشرات الزراعية التي تتغير بمرور الوقت، فإن الحل الأمثل هو استخدام امتداد timescaledb، وهو متاح في Supabase ومصمم خصيصًا لهذا النوع من البيانات. 
 

لماذا TimescaleDB؟
يقوم timescaledb بتحويل الجداول العادية إلى "جداول فائقة" (Hypertables)، وهي جداول مقسمة تلقائيًا إلى أجزاء صغيرة بناءً على الزمن. 
 
 هذا التقسيم يحسن بشكل كبير أداء عمليات الإدخال (Inserts) والاستعلامات المستندة إلى الوقت، وهو أمر حيوي للبيانات التسلسلية.

خطوات التنفيذ:

تفعيل امتداد timescaledb:

من لوحة تحكم Supabase، اذهب إلى Database > Extensions.

ابحث عن timescaledb وقم بتفعيله. 

إنشاء جدول لتخزين المؤشرات:

SQL
-- جدول لتخزين قراءات المؤشرات الزراعية
CREATE TABLE agricultural_indices (
    "time" TIMESTAMPTZ NOT NULL,
    field_id UUID NOT NULL REFERENCES fields(id) ON DELETE CASCADE,
    index_type TEXT NOT NULL, -- 'NDVI', 'EVI', etc.
    value DOUBLE PRECISION NOT NULL,
    PRIMARY KEY (time, field_id, index_type)
);

-- تحويل الجدول إلى Hypertable مقسّم حسب عمود الزمن
SELECT create_hypertable('agricultural_indices', 'time');
هذا الهيكل يسمح لك بتخزين ملايين القراءات بكفاءة والاستعلام عنها بسرعة، مثل طلب متوسط NDVI لحقل معين خلال الشهر الماضي.

الجزء الثاني: دليل استخدام PostGIS للبيانات الجغرافية
PostGIS هو امتداد لـ PostgreSQL يحوله إلى نظام معلومات جغرافية (GIS) متكامل. 
 

1. تفعيل واستخدام PostGIS في Supabase
تفعيل الامتداد:

من لوحة تحكم Supabase، اذهب إلى Database > Extensions.

ابحث عن postgis وقم بتفعيله. 
 عند التفعيل، يُنصح بإنشائه في سكيما منفصلة مثل extensions أو gis للحفاظ على نظافة السكيما العامة public. 
 

تخزين حدود الحقول:

سنقوم بتعديل جدول fields الذي أنشأناه في الجزء الأول لإضافة حقل مخصص للبيانات الجغرافية.

نستخدم نوع البيانات GEOGRAPHY لأنه الأنسب لبيانات خطوط الطول والعرض على سطح الأرض، حيث يأخذ انحناء الكرة الأرضية في الحسبان عند حساب المسافات والمساحات. 
 

الرقم 4326 هو المعرف المرجعي المكاني (SRID) لنظام WGS 84، وهو النظام القياسي المستخدم في GPS وخرائط الويب. 

SQL
-- إضافة عمود لتخزين حدود الحقل كـ Polygon
ALTER TABLE public.fields
ADD COLUMN boundary geography(Polygon, 4326);
2. أمثلة على استعلامات SQL أساسية
إدخال أو تحديث حدود حقل (بصيغة WKT):

SQL
UPDATE public.fields
SET boundary = ST_GeogFromText('SRID=4326;POLYGON((
    34.78 32.08, -- Longitude Latitude
    34.79 32.08,
    34.79 32.09,
    34.78 32.09,
    34.78 32.08
))')
WHERE id = 'your-field-id';
استعلام عن حقل معين وحساب مساحته (بالمتر المربع):

SQL
SELECT
    name,
    ST_Area(boundary) as area_in_square_meters
FROM public.fields
WHERE id = 'your-field-id';
استعلام مكاني: البحث عن جميع الحقول التي تتقاطع مع منطقة اهتمام محددة:

SQL
-- لنفترض أن `search_area` هو مضلع يحدده المستخدم على الخريطة
WITH search_area AS (
    SELECT ST_GeomFromText('POLYGON((...))', 4326) as geom
)
SELECT
    f.id,
    f.name
FROM public.fields f, search_area sa
WHERE ST_Intersects(f.boundary::geometry, sa.geom); -- نستخدم التحويل إلى geometry للتقاطع
الجزء الثالث: تنفيذ "ملف القواعد العالمي المضاد للجاذبية" (CI/CD)
مفهوم "ملف القواعد العالمي المضاد للجاذبية" هو اسم مبتكر لفكرة عملية جدًا: إنشاء نظام آلي لفرض معايير الجودة والأمان في المشروع. يمكن تحقيق ذلك بشكل فعال باستخدام GitHub Actions وخطافات Git. 
 

1. المبدأ والأدوات
GitHub Actions: هو نظام التكامل والنشر المستمر (CI/CD) المدمج في GitHub. 
 نستخدمه لإنشاء "مسار عمل" (Workflow) يتم تشغيله تلقائيًا عند أحداث معينة (مثل push أو pull_request) لتنفيذ سلسلة من المهام. 

خطافات Git (Git Hooks): هي سكربتات تعمل على جهاز المطور المحلي قبل تنفيذ أوامر Git معينة (مثل pre-commit قبل الإنشاء، أو pre-push قبل الدفع). 
 دورها هو تقديم تغذية راجعة سريعة ومنع الأخطاء قبل وصولها إلى المستودع.

2. إنشاء مسار عمل (Workflow) في GitHub Actions
أنشئ ملفًا جديدًا في مستودعك بالمسار: .github/workflows/quality_and_security.yml.

yaml
name: 'Global Antigravity Rules Check'

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  security_and_linting:
    name: 'Security Scan & Linting'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v3

      # القاعدة 1: منع وجود مفاتيح سرية في الكود
      - name: 'Scan for hardcoded secrets'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: HEAD
          extra_args: --only-verified

  testing_and_coverage:
    name: 'Run Tests & Check Coverage'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v3

      - name: 'Setup Supabase CLI'
        uses: supabase/setup-cli@v1 # [7]
        with:
          version: latest
      
      # القاعدة 2: ضمان تغطية اختبارات معينة (مثال لقاعدة بيانات)
      - name: 'Run database tests (pg_tap)'
        run: |
          supabase start
          supabase test db # [9]

      # يمكنك هنا إضافة خطوات لتشغيل اختبارات الواجهة الأمامية/الخلفية وحساب التغطية

  supabase_rules:
    name: 'Check Supabase RLS and Schema'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v3

      - name: 'Setup Supabase CLI'
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: 'Link Supabase Project'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      # القاعدة 3: فرض تفعيل سياسات الأمان على مستوى الصف (RLS)
      - name: 'Verify RLS is enabled on all public tables'
        id: check_rls
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          # هذا السكربت يتصل بقاعدة البيانات ويتحقق من تفعيل RLS
          # إذا وجد جدولاً بدون RLS، فإنه يفشل
          DB_URL="postgresql://postgres:${SUPABASE_DB_PASSWORD}@db.${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co:5432/postgres"
          
          # استعلام SQL للبحث عن الجداول في السكيما 'public' التي ليس لديها RLS مفعل
          tables_without_rls=$(psql $DB_URL -t -c "SELECT relname FROM pg_class WHERE relnamespace = 'public'::regnamespace AND relkind = 'r' AND NOT relrowsecurity;")
          
          if [ -n "$tables_without_rls" ]; then
            echo "Error: The following tables in the 'public' schema do not have RLS enabled:"
            echo "$tables_without_rls"
            exit 1
          else
            echo "Success: All tables in 'public' schema have RLS enabled."
          fi
شرح القواعد الآلية:

منع المفاتيح السرية: نستخدم trufflehog, وهي أداة مفتوحة المصدر تقوم بفحص الكود بحثًا عن أي نصوص تتطابق مع أنماط المفاتيح السرية (API keys, passwords). 
 إذا وجدت أي شيء، تفشل المهمة ويتم منع الدمج.

ضمان تغطية الاختبارات: مسار العمل يشغل اختبارات قاعدة البيانات (supabase test db). 
 يمكن توسيعه ليشمل اختبارات التطبيق (مثل Jest) واستخدام أدوات مثل Codecov أو Coveralls لرفع تقارير التغطية وفشل المهمة إذا انخفضت النسبة عن حد معين (مثلاً 80%).

فرض تفعيل RLS: هذا هو الجزء الأكثر تقدمًا. السكربت المضمن في مسار العمل يقوم بالاتصال مباشرة بقاعدة بيانات Supabase ويستعلم عن جداول النظام (pg_class) للتحقق من أن كل جدول في السكيما public لديه خاصية relrowsecurity (RLS) مفعلة. 
 
 إذا لم يكن كذلك، تفشل المهمة، مما يضمن عدم وجود جداول حساسة مكشوفة عن طريق الخطأ.

ملاحظات هامة:

الأسرار (Secrets): يجب تخزين SUPABASE_ACCESS_TOKEN و SUPABASE_PROJECT_ID و SUPABASE_DB_PASSWORD كـ "Secrets" في إعدادات مستودع GitHub (Settings > Secrets and variables > Actions) لضمان عدم تسريبها. 
 


خطافات Git: لتسريع العملية، يمكنك إعداد خطاف pre-commit لتشغيل trufflehog محليًا. هذا يمنع المطور من عمل commit يحتوي على مفاتيح سرية من الأساس، مما يوفر وقت انتظار نتيجة مسار عمل GitHub.

تصميم منصة Adham AgriTech: مخطط قاعدة البيانات، PostGIS، وخط أنابيب CI/CD
يقدم هذا الدليل الشامل تصميمًا تفصيليًا لمنصة Adham AgriTech، مع التركيز على إنشاء بنية تحتية قوية وقابلة للتطوير باستخدام PostgreSQL على Supabase. يغطي الدليل تصميم مخطط قاعدة البيانات، وتفعيل واستخدام PostGIS للبيانات الجغرافية، وتطبيق مفهوم "ملف القواعد العالمي المضاد للجاذبية" لضمان جودة وأمان الكود البرمجي.

1. التصميم التفصيلي والأمثل لمخطط قاعدة بيانات PostgreSQL
لإدارة العلاقات المعقدة في منصة زراعية، من الضروري تصميم مخطط قاعدة بيانات مرن وقابل للتوسيع. فيما يلي تصميم مقترح للجداول الأساسية:

أ. الجداول الأساسية للعلاقات المعقدة:

اسم الجدول	الوصف	الأعمدة المقترحة
users	لتخزين معلومات المستخدمين وأدوارهم.	id (UUID, مفتاح أساسي), created_at (timestamp), email (varchar), full_name (varchar), role (enum: 'admin', 'farm_owner', 'agronomist'), phone_number (varchar)
farms	لتخزين معلومات المزارع.	id (UUID, مفتاح أساسي), created_at (timestamp), owner_id (UUID, مفتاح خارجي مرتبط بـ users.id), name (varchar), location_text (text), total_area (numeric)
fields	لتمثيل الحقول داخل كل مزرعة.	id (UUID, مفتاح أساسي), created_at (timestamp), farm_id (UUID, مفتاح خارجي مرتبط بـ farms.id), name (varchar), area (numeric), boundary (geometry - سيتم شرحه في قسم PostGIS)
crops	لتخزين أنواع المحاصيل المختلفة.	id (UUID, مفتاح أساسي), name (varchar, فريد), scientific_name (varchar), description (text), optimal_growth_conditions (jsonb)
seasons	لإدارة المواسم الزراعية لكل حقل.	id (UUID, مفتاح أساسي), created_at (timestamp), field_id (UUID, مفتاح خارجي مرتبط بـ fields.id), crop_id (UUID, مفتاح خارجي مرتبط بـ crops.id), start_date (date), end_date (date), expected_yield (numeric), status (enum: 'planning', 'active', 'harvested', 'completed')
ب. أفضل هيكلية لتخزين البيانات التسلسلية الزمنية (NDVI, EVI):

تعتبر بيانات المؤشرات الزراعية مثل NDVI و EVI بيانات سلاسل زمنية (Time-Series Data). أفضل الممارسات لتخزين هذا النوع من البيانات في PostgreSQL تتضمن استخدام امتداد TimescaleDB، والذي يحول PostgreSQL إلى قاعدة بيانات سلاسل زمنية قوية.

جدول مقترح لتخزين بيانات المؤشرات الزراعية:

SQL
-- تفعيل امتداد TimescaleDB (إذا لم يكن مفعلًا)
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- إنشاء جدول لتخزين قراءات المؤشرات
CREATE TABLE sensor_readings (
    recorded_at TIMESTAMPTZ NOT NULL,
    field_id UUID NOT NULL REFERENCES fields(id),
    indicator_type VARCHAR(10) NOT NULL, -- 'NDVI' or 'EVI'
    value DOUBLE PRECISION NOT NULL,
    PRIMARY KEY (recorded_at, field_id, indicator_type)
);

-- تحويل الجدول إلى Hypertable باستخدام TimescaleDB
SELECT create_hypertable('sensor_readings', 'recorded_at');

-- إنشاء فهرس لتحسين أداء الاستعلامات
CREATE INDEX ON sensor_readings (field_id, recorded_at DESC);
CREATE INDEX ON sensor_readings (indicator_type, recorded_at DESC);
لماذا TimescaleDB؟

أداء عالٍ: يوفر إدخالًا واستعلامًا سريعًا للبيانات الزمنية.

ضغط البيانات: يقلل من مساحة التخزين المطلوبة للبيانات التاريخية.

وظائف زمنية متقدمة: يوفر دوال SQL متخصصة لتحليل البيانات الزمنية بسهولة.

2. دليل تطبيقي لاستخدام امتداد PostGIS
PostGIS هو امتداد لـ PostgreSQL يضيف دعمًا للكائنات الجغرافية، مما يجعله مثاليًا لتخزين واستعلام حدود الحقول.

أ. تفعيل PostGIS في Supabase:

من لوحة تحكم Supabase:

اذهب إلى مشروعك.

في القائمة الجانبية، اختر "Database".

اختر "Extensions".

ابحث عن postgis وقم بتفعيله.

باستخدام SQL:
يمكنك أيضًا تفعيله مباشرة من محرر SQL في Supabase:

SQL
CREATE EXTENSION IF NOT EXISTS postgis;
ب. تخزين البيانات الجغرافية لحدود الحقول:

بعد تفعيل PostGIS، يمكنك تعديل جدول fields لاستخدام نوع البيانات geometry لتخزين حدود الحقل.

SQL
-- إضافة عمود لتخزين الحدود الجغرافية
ALTER TABLE fields
ADD COLUMN boundary GEOMETRY(Polygon, 4326); -- 4326 هو SRID لنظام الإحداثيات WGS 84

-- إنشاء فهرس مكاني لتسريع الاستعلامات الجغرافية
CREATE INDEX fields_boundary_idx ON fields USING GIST (boundary);
ج. أمثلة على استعلامات SQL أساسية:

إدراج حقل جديد مع حدوده (كمضلع):

SQL
INSERT INTO fields (farm_id, name, area, boundary)
VALUES (
    'your_farm_id',
    'الحقل الشمالي',
    10.5,
    ST_GeomFromText('POLYGON((lon1 lat1, lon2 lat2, lon3 lat3, lon1 lat1))', 4326)
);
استبدل lon و lat بإحداثيات خطوط الطول والعرض لحدود الحقل.

استعلام عن الحقول التي تتقاطع مع منطقة معينة:
لنفترض أنك تريد العثور على جميع الحقول التي تتقاطع مع مضلع يمثل منطقة اهتمام.

SQL
SELECT name, area
FROM fields
WHERE ST_Intersects(
    boundary,
    ST_GeomFromText('POLYGON((...))', 4326) -- مضلع منطقة الاهتمام
);
حساب مساحة الحقل:

SQL
SELECT name, ST_Area(boundary::geography) / 10000 AS area_in_hectares
FROM fields;
3. تنفيذ مفهوم "ملف القواعد العالمي المضاد للجاذبية" (Global Antigravity Rules File)
"ملف القواعد العالمي المضاد للجاذبية" هو مصطلح مجازي يصف مجموعة من القواعد والسياسات الآلية التي يتم فرضها ضمن خط أنابيب التكامل والنشر المستمر (CI/CD) لضمان جودة وأمان وتوافق الكود البرمجي. يمكن تنفيذ هذا المفهوم عمليًا باستخدام أدوات مثل GitHub Actions وخطافات Git.

أ. كيفية استخدام GitHub Actions لإنشاء مسار عمل للتحقق الآلي:

يمكنك إنشاء ملف workflow.yml في مجلد .github/workflows في مستودعك على GitHub.

yaml
name: Adham AgriTech CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run linting
      run: npm run lint

    - name: Run tests and check coverage
      run: npm test -- --coverage
      # افترض أن لديك سكربت لاختبار التغطية

    - name: Check for secrets in code
      uses: gitguardian/ggshield-action@v1
      with:
        args: "scan --ci"
      env:
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

    - name: Check Supabase RLS policies
      # هذا يتطلب سكربت مخصص
      run: |
        # سكربت للاتصال بقاعدة بيانات Supabase والتحقق من وجود RLS على الجداول الحساسة
        # يمكن استخدام متغيرات البيئة الآمنة من GitHub Secrets للاتصال
        # إذا فشل التحقق، يجب أن يخرج السكربت بحالة خطأ (exit 1)
        # مثال افتراضي
        node ./scripts/check-rls.js
      env:
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
ب. شرح وتفصيل مسار العمل:

فرض تفعيل سياسات الأمان على مستوى الصف (RLS):

المفهوم: RLS هي ميزة قوية في PostgreSQL (وبالتالي Supabase) تسمح بتقييد الوصول إلى صفوف معينة في جدول بناءً على سياسات محددة. هذا ضروري لضمان أن المستخدمين لا يمكنهم الوصول إلا إلى بياناتهم الخاصة.

التنفيذ:

إنشاء سكربت مخصص (مثل check-rls.js): هذا السكربت سيتصل بقاعدة بيانات Supabase الخاصة بك (باستخدام بيانات اعتماد مخزنة بأمان في GitHub Secrets) ويستعلم عن pg_policies للتحقق من أن الجداول الحساسة (مثل farms, fields) لديها سياسات RLS مفعلة.

دمجه في GitHub Actions: أضف خطوة في ملف workflow.yml لتشغيل هذا السكربت. إذا لم يتم العثور على السياسات المطلوبة، يجب أن يفشل السكربت، مما يؤدي إلى فشل خط الأنابيب ومنع الدمج.

ضمان نسبة تغطية اختبارات معينة:

المفهوم: تغطية الاختبارات (Test Coverage) هي مقياس يوضح نسبة الكود البرمجي الذي يتم اختباره بواسطة مجموعة الاختبارات الخاصة بك. فرض نسبة معينة يضمن الحفاظ على جودة الكود.

التنفيذ:

استخدام أدوات الاختبار: استخدم أطر عمل اختبار مثل Jest أو Vitest التي تدعم إنشاء تقارير تغطية.

تكوين أمر الاختبار: في ملف package.json، قم بتكوين أمر الاختبار ليشمل خيار التغطية (--coverage).

فشل البناء عند عدم الوصول للحد الأدنى: يمكن تكوين معظم أدوات الاختبار بحيث تفشل إذا لم يتم الوصول إلى حد أدنى معين من التغطية.

منع وجود مفاتيح سرية في الكود:

المفهوم: لا يجب أبدًا تخزين المفاتيح السرية (مثل مفاتيح API، كلمات مرور قاعدة البيانات) مباشرة في الكود.

التنفيذ:

استخدام GitGuardian أو أدوات مشابهة: gitguardian/ggshield-action هو إجراء GitHub يقوم بفحص الكود بحثًا عن أي مفاتيح سرية مسربة. 
Google Mail icon

استخدام خطافات Git (Git Hooks): يمكن استخدام أدوات مثل pre-commit لتشغيل فحوصات محلية قبل أن يتمكن المطور من عمل commit للكود. هذا يمنع الأسرار من الوصول إلى المستودع في المقام الأول.

ج. استخدام خطافات Git (Git Hooks) للمزيد من الأمان:

يمكن استخدام خطافات Git، مثل pre-commit، لتشغيل سكربتات على جهاز المطور قبل كل عملية commit. هذا يوفر طبقة حماية إضافية.

مثال على pre-commit:

bash
#!/bin/sh

# تشغيل فحص للأسرار قبل الـ commit
git secrets --scan

# إذا وجد أسرار، منع الـ commit
if [ $? -ne 0 ]; then
    echo "Secret keys found in your code. Commit aborted."
    exit 1
fi
من خلال الجمع بين تصميم قاعدة بيانات مدروس، واستخدام فعال لـ PostGIS، وتطبيق صارم لـ "ملف القواعد العالمي المضاد للجاذبية"، يمكن لمنصة Adham AgriTech أن تحقق مستوى عالٍ من الكفاءة والأمان وقابلية التوسع.
مقابل طلبك المفصّل، نقدم لك دليلًا شاملاً ومتكاملًا لتصميم وتنفيذ منصة Adham AgriTech على Supabase، مع التركيز على أفضل الممارسات في هياكل البيانات، استخدام البيانات الجغرافية، وأتمتة معايير الجودة والأمان.

الجزء الأول: تصميم مخطط قاعدة بيانات PostgreSQL على Supabase
لإدارة العلاقات المعقدة في منصة زراعية، يجب تصميم مخطط قاعدة بيانات مرن وقابل للتوسيع. فيما يلي التصميم المقترح باستخدام SQL لـ PostgreSQL.

1. الجداول الأساسية والعلاقات
هذه الجداول تدير الهيكلية الأساسية للمستخدمين، المزارع، الحقول، والمحاصيل.

SQL
-- جدول المستخدمين (Users)
-- يستخدم نظام المصادقة المدمج في Supabase (auth.users) ولكن نضيف جدول public.users لبياناتهم العامة
CREATE TABLE public.users (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    full_name TEXT,
    user_role TEXT NOT NULL DEFAULT 'farmer', -- (farmer, expert, admin)
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- جدول المزارع (Farms)
-- كل مستخدم يمكن أن يمتلك عدة مزارع
CREATE TABLE public.farms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    country TEXT,
    address TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    -- يمكن إضافة حقول وصفية أخرى
    UNIQUE (owner_id, name)
);

-- جدول الحقول (Fields)
-- كل مزرعة تحتوي على عدة حقول، مع بيانات جغرافية
CREATE TABLE public.fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    farm_id UUID NOT NULL REFERENCES public.farms(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    area_hectares NUMERIC,
    -- سيتم إضافة حقل للبيانات الجغرافية لاحقاً باستخدام PostGIS
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- جدول المحاصيل (Crops)
-- جدول مرجعي بأنواع المحاصيل الممكنة
CREATE TABLE public.crops (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    scientific_name TEXT,
    description TEXT
);

-- جدول المواسم الزراعية (Seasons)
-- يربط بين الحقل والمحصول المزروع في فترة زمنية معينة
CREATE TABLE public.seasons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    field_id UUID NOT NULL REFERENCES public.fields(id) ON DELETE CASCADE,
    crop_id INTEGER NOT NULL REFERENCES public.crops(id),
    start_date DATE NOT NULL,
    end_date DATE, -- يمكن أن يكون تاريخ الحصاد المتوقع
    status TEXT NOT NULL DEFAULT 'active', -- (active, finished, planned)
    yield_amount NUMERIC, -- كمية المحصول بعد الحصاد
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
2. هيكلية تخزين البيانات التسلسلية الزمنية (NDVI, EVI)
تعتبر بيانات المؤشرات الزراعية مثل NDVI و EVI بيانات تسلسلية زمنية (Time-Series Data). الخيار الأمثل لتخزينها في PostgreSQL هو استخدام امتداد TimescaleDB، وهو مصمم خصيصًا لهذا النوع من البيانات ويوفر أداءً عاليًا في الإدخال والاستعلام.

لماذا TimescaleDB؟

Hypertables: يقوم بتقسيم الجداول الضخمة تلقائيًا إلى أجزاء أصغر (chunks) بناءً على الزمن، مما يسرّع الاستعلامات بشكل كبير.

وظائف متخصصة: يوفر دوال SQL محسّنة لتحليل البيانات الزمنية (مثل time_bucket, first, last).

ضغط البيانات: يدعم ضغط البيانات القديمة لتوفير مساحة التخزين.

خطوات التنفيذ:

تفعيل امتداد TimescaleDB: في لوحة تحكم Supabase، اذهب إلى Database > Extensions وابحث عن timescaledb وقم بتفعيله.

إنشاء جدول للبيانات:

SQL
-- جدول لتخزين قراءات المؤشرات الزراعية
CREATE TABLE public.sensor_readings (
    time TIMESTAMPTZ NOT NULL,
    season_id UUID NOT NULL REFERENCES public.seasons(id) ON DELETE CASCADE,
    indicator_type TEXT NOT NULL, -- 'NDVI', 'EVI', 'Moisture', etc.
    value DOUBLE PRECISION NOT NULL,
    source TEXT -- (e.g., 'Satellite Sentinel-2', 'Drone DJI-P4')
);

-- تحويل الجدول العادي إلى Hypertable
-- يتم التقسيم بناءً على حقل الزمن (time)
SELECT create_hypertable('sensor_readings', 'time');
فهرسة الجدول: لضمان أداء استعلام مثالي، قم بفهرسة الأعمدة التي تستخدمها بشكل متكرر في الاستعلامات.

SQL
CREATE INDEX ON sensor_readings (season_id, indicator_type, time DESC);
الجزء الثاني: دليل استخدام امتداد PostGIS للبيانات الجغرافية
PostGIS هو امتداد قوي لـ PostgreSQL يضيف دعمًا للكائنات الجغرافية، وهو مثالي لتخزين حدود الحقول.

1. تفعيل PostGIS في Supabase
يمكن تفعيل PostGIS بسهولة من خلال لوحة التحكم أو عبر أمر SQL.

عبر لوحة التحكم: اذهب إلى Database > Extensions، ابحث عن postgis وقم بتفعيله.

عبر SQL: نفّذ الأمر التالي في محرر SQL:

SQL
CREATE EXTENSION postgis;
2. تخزين حدود الحقول
الآن يمكنك تعديل جدول fields لإضافة حقل من نوع geometry لتخزين المضلعات التي تمثل حدود الحقول.

SQL
-- إضافة عمود لتخزين حدود الحقل الجغرافية
ALTER TABLE public.fields
ADD COLUMN boundary GEOMETRY(Polygon, 4326); -- Polygon: نوع الشكل, 4326: نظام الإحداثيات WGS 84

-- إنشاء فهرس مكاني لتسريع الاستعلامات الجغرافية
CREATE INDEX fields_boundary_idx ON public.fields USING GIST (boundary);
3. إدخال واستعلام البيانات الجغرافية
مثال: إدخال حقل جديد بحدود مضلعة
يتم إدخال البيانات باستخدام صيغة Well-Known Text (WKT).

SQL
INSERT INTO public.fields (farm_id, name, area_hectares, boundary)
VALUES (
    'e6d2b3a0-xxxx-xxxx-xxxx-a8e5f2c1b4d3', -- farm_id
    'الحقل الشمالي',
    15.5,
    -- ST_GeomFromText لتحويل النص إلى كائن جغرافي
    -- 4326 هو SRID لنظام الإحداثيات
    ST_GeomFromText('POLYGON((
        31.2497 30.0626,
        31.2520 30.0626,
        31.2520 30.0600,
        31.2497 30.0600,
        31.2497 30.0626
    ))', 4326)
);
أمثلة على استعلامات SQL أساسية:

حساب مساحة الحقل (بالمتر المربع):

SQL
-- ST_Area تتطلب تحويل نظام الإحداثيات إلى نظام متري (مثل UTM)
-- لنفترض أن المنطقة تقع في نطاق UTM 36N (SRID: 32636)
SELECT
    name,
    ST_Area(ST_Transform(boundary, 32636)) AS area_sq_meters
FROM
    public.fields
WHERE
    name = 'الحقل الشمالي';
البحث عن الحقول التي تتقاطع مع نقطة معينة (مثل موقع GPS):

SQL
SELECT name, area_hectares
FROM public.fields
WHERE ST_Intersects(
    boundary,
    ST_SetSRID(ST_MakePoint(31.2510, 30.0615), 4326) -- إحداثيات النقطة
);
الجزء الثالث: تنفيذ "ملف القواعد العالمي المضاد للجاذبية" (CI/CD)
المصطلح "Global Antigravity Rules File" هو تعبير مجازي عن وجود نظام مركزي لفرض قواعد الجودة والأمان تلقائيًا. يمكن تحقيق ذلك عمليًا باستخدام أدوات مثل GitHub Actions و Git Hooks.

1. خطافات Git (Git Hooks) للتحقق المحلي
تُنفذ هذه الخطافات على جهاز المطور قبل إتمام عمليات مثل git commit. نستخدم أداة pre-commit لإدارة هذه الخطافات.

ثبّت pre-commit: pip install pre-commit

أنشئ ملف .pre-commit-config.yaml في جذر المشروع:

yaml
# .pre-commit-config.yaml
repos:
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
    -   id: trailing-whitespace
    -   id: end-of-file-fixer
    -   id: check-yaml
    -   id: check-added-large-files

-   repo: https://github.com/trufflesecurity/trufflehog
    rev: v3.63.2
    hooks:
    -   id: trufflehog
        name: "TruffleHog - Scan for secrets"
        args: ['--fail']
        # هذا يمنع commit إذا تم العثور على أي مفتاح سري
ثبّت الخطاف: pre-commit install

الآن, عند كل git commit, سيتم فحص الملفات تلقائيًا بحثًا عن أسرار أو مشاكل تنسيق. 
Google Mail icon

2. مسار عمل التكامل والنشر المستمر (CI/CD) باستخدام GitHub Actions
هذا المسار يُنفذ على خوادم GitHub بعد كل push أو pull request ويضمن تطبيق القواعد على مستوى الفريق. 
Google Mail icon

أنشئ ملفًا باسم quality-checks.yml داخل مجلد .github/workflows/.

yaml
# .github/workflows/quality-checks.yml
name: 'Quality & Security Pipeline'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ------ Job 1: Linting and Testing ------
  test-and-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run linter
        run: npm run lint

      - name: Run tests with coverage
        run: npm test -- --coverage

      - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

  # ------ Job 2: Security Checks ------
  security:
    runs-on: ubuntu-latest
    needs: test-and-lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Scan for secrets with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --debug --fail
        # يفشل المسار إذا تم العثور على أسرار [18]

  # ------ Job 3: Verify Supabase RLS Policies ------
  verify-rls:
    runs-on: ubuntu-latest
    needs: test-and-lint
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project and check RLS policies
        run: |
          # ربط المشروع باستخدام التوكن
          supabase link --project-ref $SUPABASE_PROJECT_ID

          # تنفيذ استعلام SQL للتحقق من وجود سياسات RLS على الجداول الحساسة
          # سيفشل هذا الأمر (ويفشل المسار) إذا لم يُرجع الاستعلام العدد المتوقع
          supabase sql "
            SELECT
              COUNT(*)
            FROM
              pg_catalog.pg_policy
            WHERE
              schemaname = 'public' AND
              tablename IN ('farms', 'fields', 'seasons', 'sensor_readings')
          " | grep -q "4" # افترض أننا نتوقع وجود سياسة واحدة على الأقل لكل جدول

          echo "RLS policies are correctly configured."
شرح مسار العمل:

test-and-lint: هذا الجزء يقوم بتشغيل الاختبارات (npm test) ويضمن تغطية الكود بنسبة معينة عبر codecov.

security: يستخدم TruffleHog لفحص الكود بين الفرع الحالي والفرع الأساسي بحثًا عن أي مفاتيح سرية تم إضافتها عن طريق الخطأ. 
Google Mail icon
 


verify-rls: هذا الجزء هو التطبيق العملي للتحقق من سياسات الأمان على مستوى الصف (RLS). 
Google Mail icon

يستخدم Supabase CLI للاتصال بمشروعك.

ينفذ استعلام SQL مباشرة على قاعدة بياناتك لفحص جدول pg_policy الذي يخزن جميع سياسات RLS.

يتحقق من أن الجداول الهامة (farms, fields، إلخ) لديها سياسات RLS مفعلة.

إذا لم يتم العثور على العدد المتوقع من السياسات، يفشل المسار، مما يمنع دمج الكود الذي قد يعرض البيانات للخطر.

بهذا التصميم، تكون قد بنيت أساسًا قويًا لمنصة Adham AgriTech، مع هيكل بيانات فعال، وقدرات جغرافية متقدمة، ونظام آلي لضمان أعلى معايير الجودة والأمان في كل مرحلة من مراحل التطوير.

التقرير النهائي
أهلاً بك مجدداً! يسعدني أن أقدم لك خطة عمل مُحسّنة ومُعمّقة لمشروع "Adham AgriTech". لقد قمت بمراجعة الخطة الأولية ودمجت فيها تفاصيل تقنية وعلمية متقدمة من المصادر التي تم توفيرها، مما يحول هذه الوثيقة إلى خارطة طريق استراتيجية وتنفيذية أكثر قوة وشمولية.

تم تحديث الخطة لتشمل ليس فقط المكدس التقني، بل أيضاً أفضل الممارسات لبناء لوحة تحكم تحليلية تفاعلية، ومقارنة بين مكتبات الرسوم البيانية، وتضمين خوارزميات دقيقة لمؤشرات نباتية متقدمة مثل EVI و SAVI. والأهم من ذلك، تم تطوير نموذج الري الذكي ليصبح نظاماً استباقياً متعدد الطبقات يعتمد على القياس المباشر لرطوبة التربة من الأقمار الصناعية.

بالإضافة إلى ذلك، تم توسيع الخطة لتشمل تصميمًا تفصيليًا لقاعدة البيانات على Supabase باستخدام امتدادات متخصصة مثل PostGIS و TimescaleDB، وتوضيحًا عمليًا لكيفية تطبيق "ملف القواعد العالمي" من خلال خط أنابيب آلي للتكامل والنشر المستمر (CI/CD) لضمان أعلى معايير الجودة والأمان.

إليك خطة العمل المنقحة والمفصلة:

خطة عمل مشروع Adham AgriTech (نسخة موسعة ومُحسّنة)
هذه الوثيقة تمثل خطة العمل الشاملة لمشروع "أدهم للتكنولوجيا الزراعية" (Adham AgriTech)، وهو مشروع رائد يهدف إلى إحداث ثورة في القطاع الزراعي من خلال تقديم حلول ذكية ومستدامة، مدعومة ببنية تقنية حديثة وقابلة للتطوير.

1. الرؤية (Vision)
أن نكون الشركة الرائدة في منطقة الشرق الأوسط وشمال أفريقيا في مجال التكنولوجيا الزراعية، من خلال تمكين المزارعين والشركات الزراعية من تحقيق أقصى إنتاجية ممكنة بأقل استهلاك للموارد، مما يساهم في تحقيق الأمن الغذائي والاستدامة البيئية.

2. الرسالة (Mission)
توفير منظومة متكاملة من الحلول التقنية التي تشمل منصة برمجية متقدمة (SaaS)، وأجهزة ذكية (IoT)، ونماذج ذكاء اصطناعي 
Google Drive icon
 . نلتزم بتقديم استشارات متخصصة وتدريب مستمر لعملائنا لضمان تحقيقهم أفضل النتائج من استثماراتهم التكنولوجية، مع التركيز على الابتكار والجودة وسهولة الاستخدام.

3. الاستراتيجية (Strategy)
تعتمد استراتيجيتنا على عدة محاور رئيسية لتحقيق رؤيتنا وأهدافنا:

التميز التكنولوجي: تبني وتطوير أحدث التقنيات في مجال الزراعة الدقيقة 
Google Drive icon
 . سيتم بناء منصتنا باستخدام مكدس تقني حديث يشمل Next.js للواجهة الأمامية، وSupabase كواجهة خلفية متكاملة 
Google Drive icon
 
Google Mail icon
 . سنقوم بتوظيف مؤشرات زراعية متقدمة مثل EVI و SAVI لتقديم تحليلات أكثر دقة من مؤشر NDVI التقليدي 
Google Drive icon
 

 .

الحلول المتكاملة: تقديم حزمة متكاملة (منتجات وخدمات) تغطي كافة احتياجات المزرعة الحديثة، بدءًا من تصميم وتركيب الأنظمة الذكية وصولًا إلى الدعم الفني والتشغيلي.

التركيز على العميل: بناء علاقات قوية مع العملاء من خلال فهم تحدياتهم وتقديم حلول مخصصة تلبي احتياجاتهم بدقة، مع توفير برامج تدريبية لتمكينهم من استخدام التكنولوجيا بفعالية.

الشراكات الاستراتيجية: بناء شبكة من الشراكات مع مؤسسات بحثية، وشركات تكنولوجيا عالمية (مثل Mapbox و EOSDA)، وجهات حكومية لتسريع وتيرة الابتكار وتوسيع نطاق الوصول إلى الأسواق 
Google Drive icon
 

 .

نموذج عمل مرن: اعتماد نموذج يعتمد على الاشتراكات في البرمجيات (SaaS) بالإضافة إلى بيع الأجهزة وتقديم خدمات استشارية، مما يضمن تدفقات إيرادات مستدامة.

4. الأهداف (Objectives)
لتحويل استراتيجيتنا إلى واقع ملموس، نحدد الأهداف التالية (القابلة للقياس والمحددة زمنيًا - SMART):

خلال السنة الأولى (مرحلة المنتج الأولي القابل للتطبيق - MVP):

إطلاق النسخة الأولى من منصة Adham AgriTech السحابية مع الميزات الأساسية التالية:

لوحة تحكم تحليلية تفاعلية: واجهة خرائط ورسوم بيانية تتيح للمستخدمين رسم حدود حقولهم، وعرض بيانات تاريخية لمؤشرات صحة النبات (NDVI, EVI, SAVI)، مع إمكانية تغيير النطاقات الزمنية وتصدير التقارير 
Google Drive icon
 

 .

وحدة الري الذكي الاستباقي: تقديم توصيات ري دقيقة بناءً على خوارزمية متعددة الطبقات تدمج بيانات رطوبة التربة الفعلية (من الأقمار الصناعية)، وبيانات الإجهاد المائي للنبات (NDWI)، وتنبؤات الطقس 
Google Mail icon
 

 .

نموذج تشخيص الأمراض: إطلاق نسخة تجريبية من نموذج الذكاء الاصطناعي لتشخيص أمراض النباتات عبر الصور 
Google Drive icon
 
Google Mail icon
 .

تأمين عقود مع 5 مزارع رائدة كعملاء تجريبيين (Pilot Projects) لاختبار وتحسين الحلول.

تطوير وتصنيع الدفعة الأولى من وحدات استشعار إنترنت الأشياء (لقياس رطوبة التربة، الحرارة، والعوامل البيئية).

خلال السنوات الثلاث الأولى:

الوصول إلى 100 عميل نشط في السوق المحلي.

تحقيق عائد استثماري إيجابي وتغطية التكاليف التشغيلية.

توسيع فريق العمل ليشمل خبراء في تحليل البيانات الزراعية، الذكاء الاصطناعي، والدعم الميداني.

إطلاق "المساعد الزراعي الذكي" كمنتج رئيسي متكامل 
Google Mail icon
 
Google Drive icon
 .

خلال السنوات الخمس الأولى:

التوسع في 3 أسواق إقليمية جديدة.

تحقيق خفض ملموس في استهلاك المياه لدى عملائنا بنسبة متوسطة تبلغ 30%.

أن نصبح علامة تجارية معترف بها كمرجع في مجال التكنولوجيا الزراعية في المنطقة.

5. التكاملات الخارجية (External Integrations)
لتقديم حلول شاملة، ستتكامل منصة Adham AgriTech مع مجموعة من الأنظمة والخدمات الخارجية عبر واجهات برمجة التطبيقات (APIs):

خدمات الخرائط: التكامل مع Mapbox GL JS لتوفير خرائط تفاعلية وأدوات رسم متقدمة 
Google Drive icon
 
 .

مزودو بيانات الأقمار الصناعية: التكامل مع EOSDA API للحصول على صور عالية الدقة، وتحليلات صحة النبات (NDVI, EVI, SAVI)، وبيانات الإجهاد المائي (NDWI)، والأهم من ذلك، بيانات رطوبة التربة الجاهزة للاستخدام 
Google Drive icon
 

 .

مزودو بيانات الطقس: التكامل مع خدمات مثل OpenWeatherMap أو AccuWeather للحصول على تنبؤات دقيقة لدرجة الحرارة، هطول الأمطار، والتبخر-النتح (ET) 
 .

منصات نشر نماذج الذكاء الاصطناعي: استخدام خدمات مثل Google Cloud Run أو AWS Lambda لاستضافة ونشر نماذج تشخيص الأمراض كواجهة برمجة تطبيقات قابلة للتطوير 
Google Mail icon
 

 .

نماذج اللغة الكبرى (LLMs): التكامل مع واجهات برمجة التطبيقات لنماذج متعددة مثل OpenAI GPT-4o (للتحليل المعقد)، وGoogle Gemini (للمهام متعددة الوسائط)، وGroq (للاستجابات الفورية)، وذلك لتشغيل "المساعد الزراعي الذكي" 
Google Mail icon
 

 .

معدات الري الآلي: الربط المباشر مع أنظمة الري الحديثة لتنفيذ أوامر الري بدقة بناءً على توصيات المنصة.

6. طريقة العمل (Methodology) والتشغيل (Operation)
سيتم تطوير وتشغيل المشروع باستخدام منهجيات حديثة تضمن السرعة، الكفاءة، والجودة العالية.

إدارة المشاريع: Agile & Scrum

سيتم تنظيم العمل بنظام "سبرينت" (Sprint) لمدة أسبوعين.

في بداية كل سبرينت، يتم تحديد المهام والميزات المطلوب تطويرها.

تُعقد اجتماعات يومية قصيرة لمناقشة التقدم المحرز وأي تحديات.

البنية التحتية والتشغيل:

المنصة السحابية: سيتم الاعتماد بشكل كامل على Supabase كواجهة خلفية متكاملة، والتي توفر قاعدة بيانات PostgreSQL، المصادقة، التخزين، والدوال السحابية (Edge Functions) 
Google Drive icon
 

 . هذا يسرّع من عملية التطوير ويقلل من تعقيد إدارة البنية التحتية.

الدعم الفني: تقديم دعم فني متعدد المستويات عبر نظام تذاكر وخبراء فنيين.

العمليات الميدانية: فريق من "وكلاء البناء" (المهندسين الميدانيين) مسؤول عن تركيب وصيانة الأجهزة في مواقع العملاء.

التحديثات المستمرة: إصدار تحديثات دورية للمنصة البرمجية بناءً على ملاحظات العملاء والابتكارات الجديدة.

رؤية التطوير المستقبلية: المساعد الزراعي الذكي ووكلاء الذكاء الاصطناعي

تتمثل رؤيتنا طويلة الأمد في تطوير "مساعد زراعي ذكي" يعتمد على بنية التوليد المعزز بالاسترجاع (RAG) 
Google Drive icon
 . سيقوم هذا المساعد بدمج نماذج لغوية متعددة (Multi-LLM) لتحليل استفسارات المزارعين، واسترجاع بيانات حية ومخصصة من قاعدة بيانات Supabase بشكل آمن، وتحليل الصور لتشخيص الأمراض، وتقديم إجابات شاملة ومخصصة 
Google Mail icon
 

 .

نتصور مستقبلاً يتحول فيه دور فريق التطوير من "كتابة الكود" إلى "إدارة وتوجيه الوكلاء"، حيث يقوم المهندسون بتحديد المتطلبات عالية المستوى، بينما يقوم وكيل الذكاء الاصطناعي بتنفيذها بشكل مستقل، مما يسرّع الابتكار بشكل هائل.

7. خطة التنفيذ التقنية المفصلة (المرحلة الأولى - MVP)
هذا القسم يفصّل الخطوات التقنية لبناء الميزات الأساسية الثلاث للمنصة، مع دمج التفاصيل المتقدمة من المصادر.

أ. لوحة التحكم التحليلية التفاعلية (Interactive Analytical Dashboard)
هيكلة الواجهة الأمامية (Next.js):

بنية المشروع: استخدام App Router في Next.js لتنظيم الصفحات والمكونات 
Google Drive icon
 
Google Mail icon
 . سيتم فصل المكونات إلى "مكونات خادم" (Server Components) لجلب البيانات الأولية بكفاءة، و"مكونات عميل" (Client Components) للعناصر التفاعلية 
Google Drive icon
 

 .

جلب البيانات التسلسلية الزمنية: سيتم استخدام دوال async داخل مكونات الخادم لجلب البيانات التاريخية (NDVI, EVI, SAVI, سجلات الري) مباشرة من Supabase، مما يقلل من حجم JavaScript المرسل للعميل ويحسن أداء التحميل الأولي 
Google Drive icon
 

 .

الميزات التفاعلية:

تغيير النطاقات الزمنية: استخدام مكونات اختيار التاريخ (Date Pickers) في مكونات العميل لتحديث مسار URL، مما يدفع مكون الخادم لإعادة جلب البيانات للنطاق الزمني الجديد .

تصدير التقارير: إنشاء "معالج مسار" (Route Handler) في Next.js لتصدير البيانات 
Google Mail icon
 . سيتم استخدام مكتبة papaparse لتصدير CSV 
Google Drive icon
 
Google Mail icon
 ، ومكتبة Puppeteer على الخادم لتوليد تقارير PDF احترافية تطابق ما يراه المستخدم على الشاشة 
Google Mail icon
 
Google Mail icon
 .

مكتبات الرسوم البيانية (Recharts vs. Chart.js):

المقارنة: Recharts ممتازة للتكامل مع React وتوفر تخصيصًا عاليًا عبر المكونات 
Google Mail icon
 

 . بينما تتميز Chart.js بأداء متفوق مع مجموعات البيانات الضخمة لأنها تستخدم <canvas>، وهي أ��ف وزن 
Google Mail icon
 

 ��ا .

القرار: سنبدأ باستخدام Chart.js نظرًا للحاجة المتوقعة لعرض بيانات تسلسلية زمنية كبيرة (مثل قيم المؤشرات اليومية على مدار موسم كامل)، حيث يضمن أداءً سلسًا وسريعًا، وهو أمر حاسم لتجربة المستخدم في لوحة التحكم التحليل 
Google Mail icon
 ��ة .

المؤشرات الزراعية المتقدمة (EVI & SAVI):

مؤشر الغطاء النباتي المعدل حسب التربة (SAVI):

الغرض: تقليل تأثير سطوع التربة في المناطق ذات الغطاء النباتي المتنا 
Google Drive icon
 

 ��ر .

المعادلة (لـ Sentinel-2): SAVI = ((B8 - B4) / (B8 + B4 + L)) * (1 + L)، حيث L=0.428 هو المعامل الموصى 
Google Drive icon
 
Google Mail icon
 ��ه .

حالة الاستخدام: مثالي في بداية الموسم الزراعي وعندما تكون النباتات صغيرة والتربة مكشوفة، مما يوفر تقييمًا دقيقًا لصحة الشتل 
Google Mail icon
 

 ��ت .

مؤشر الغطاء النباتي المحسن (EVI):

الغرض: التغلب على مشكلة "التشبع" التي يعاني منها NDVI في المناطق ذات الغطاء النباتي الكثيف جد 
Google Drive icon
 

 ��ا .

المعادلة (لـ Sentinel-2): EVI = 2.5 * ((B8 - B4) / (B8 + 6 * B4 - 7.5 * B2 + 1)) .

حالة الاستخدام: ضروري لمراقبة المحاصيل في ذروة مرحلة النمو (مثل الذرة وقصب السكر)، حيث يستمر EVI في إظهار الفروقات الدقيقة في صحة النبات بعد أن يصل NDVI إلى أقصى قيمة 
Google Mail icon
 

 ��ه .

ب. وحدة الري الذكي الاستباقي (Proactive Smart Irrigation)
تمت ترقية هذه الوحدة لتعتمد على خوارزمية متعددة الطبقات أكثر دقة وكفاءة، تنتقل من كونها مجرد رد فعل للإجهاد المائي إلى نظام استباقي يمنع حدوث الإجهاد من الأس 
Google Drive icon
 
Google Mail icon
 ��س .

استخلاص بيانات رطوبة التربة:

الأسلوب المباشر (SAR): بيانات رادار الفتحة الاصطناعية (SAR) من قمر Sentinel-1 هي الطريقة الأكثر موثوقية لقياس رطوبة التربة مباشرة، لأنها حساسة للمحتوى المائي وتعمل في جميع الظروف الجو 
Google Mail icon
 

 ��ة .

الحل العملي (EOSDA API): بدلاً من معالجة بيانات SAR الخام المعقدة، سنتكامل مع EOSDA API التي توفر منتج "رطوبة التربة" كبيانات جاهزة للاستخد 
Google Drive icon
 

 ��م . توفر هذه الخدمة بيانات رطوبة التربة على مستويين: سطح التربة ومنطقة الجذور، وهو أمر حاسم لاتخاذ قرارات ري دقي 
Google Drive icon
 
 ��ة .

خوارزمية الري الذكي متعددة الطبقات:

الطبقة الأولى: المُشغِّل الرئيسي (Primary Trigger - رطوبة التربة):

المدخلات: بيانات رطوبة التربة الحجمية من EOSDA 
Google Drive icon
 
Google Mail icon
 API .

المنطق: يقوم النظام بالتحقق اليومي من مستوى رطوبة التربة. إذا انخفضت القيمة عن "نقطة إعادة الملء" (Refill Point) المحددة مسبقًا للمحصول والحقل، يتم إطلاق إشارة أولية للحاجة إلى ال 
Google Drive icon
 ��ي .

الطبقة الثانية: التحقق والتأكيد (Verification Layer - حالة النبات والطقس):

المدخلات: مؤشر NDWI من Sentinel-2 لتقييم الإجهاد المائي الفعلي في النب 
Google Mail icon
 
Google Drive icon
 ��ت ، وتوقعات هطول الأمطار من واجهة برمجة تطبيقات الط 
 ��س .

المنطق: يتم تأكيد توصية الري فقط إذا كانت توقعات هطول الأمطار غير كافية خلال الـ 24 ساعة القاد 
Google Drive icon
 ��ة . كما يُستخدم مؤشر NDWI كعامل تحقق ثانوي؛ فإذا كانت رطوبة التربة كافية ولكن NDWI منخفض، قد يشير ذلك إلى مشكلة أخرى (مثل أمراض الجذور) ويتم إرسال تنبيه خاص للمزا 
 ��ع .

الطبقة الثالثة: تحديد الكمية (Quantification Layer):

المدخلات: بيانات التبخر-النتح (ETc)، ومستوى العجز المائي الحالي في التربة.

المنطق: لا يكتفي النظام بالإجابة على "هل يجب أن أروي؟"، بل يجيب أيضاً على "ما هي كمية المياه المطلوبة؟". يتم حساب كمية الري بدقة للوصول من المستوى الحالي إلى "السعة الحقلية" (Field Capacity)، مع الأخذ في الاعتبار التبخر المتوقع، مما يمنع الإفراط في الري ويحقق أقصى كفاءة في استخدام المي 
Google Mail icon
 
 ��ه .

ج. نموذج تشخيص أمراض النباتات بالذكاء الاصطناعي
جمع وتجهيز البيانات:

جمع البيانات: البدء بمجموعات البيانات المفتوحة مثل PlantVillage التي تحتوي على آلاف الصور المصن 
Google Mail icon
 
Google Mail icon
 ��ة .

زيادة البيانات (Data Augmentation): تطبيق تحويلات عشوائية على الصور (تدوير، قص، تغيير السطوع) لزيادة حجم وتنوع مجموعة التدريب ومنع الحفظ الزائد (Overfitt 
Google Drive icon
 
Google Drive icon
 ing) .

بنية النموذج والتدريب:

اختيار المعمارية: يوصى باستخدام معمارية EfficientNet أو Vision Transformers (ViT) لتوازنها الممتاز بين الدقة والكفاءة الحساب 
Google Mail icon
 

 ��ة .

التعلم النقلي (Transfer Learning): استخدام نموذج مُدرّب مسبقًا على مجموعة بيانات ImageNet. يتم "تجميد" الطبقات الأولية وتدريب الطبقات النهائية فقط على بيانات أمراض النباتات، مما يسرّع التدريب ويحسن الدقة بشكل كب 
Google Drive icon
 

 ��ر .

النشر والاستخدام (Deployment):

ضغط النموذج: استخدام تقنيات مثل التكميم (Quantization) لتحويل أوزان النموذج من 32-bit float إلى 8-bit integer، مما يقلل حجمه ويسرّع الاستدل 
Google Drive icon
 

 ��ل .

النشر كـ API: يتم تغليف النموذج في حاوية Docker مع خادم ويب خفيف مثل FastA 
 PI ونشره على خدمة سحابية "بلا خوادم" (Serverless) مثل Google Cloud Run أو AWS Lamb 
Google Mail icon
 

 da .

الاستخدام: يقوم التطبيق بإرسال الصورة إلى API النموذج، الذي يعيد استجابة JSON تحتوي على اسم المرض ودرجة الث 
Google Mail icon
 ��ة .

8. البنية التحتية للبيانات: تصميم قاعدة بيانات PostgreSQL على Supabase
لتحقيق أقصى استفادة من منصة Supabase، سنقوم بتصميم مخطط قاعدة بيانات قوي وقابل للتطوير، مع الاستفادة من امتدادات PostgreSQL القوية مثل TimescaleDB و PostGIS.

أ. مخطط الجداول والعلاقات
الهيكل التالي يضمن إدارة فعالة للعلاقات المعقدة بين المستخدمين، المزارع، الحقول، والمواسم الزراعية.

الجداول الأساسية:

profiles: لتخزين البيانات العامة للمستخدمين، مع ربطه بجدول auth.users المدمج في Supabase.

farms: لتخزين معلومات المزارع، مع ربط كل مزرعة بمالكها (owner_id).

fields: لتمثيل الحقول داخل كل مزرعة، وسيحتوي على بيانات جغرافية.

crops: جدول مرجعي لأنواع المحاصيل.

growing_seasons: جدول يربط بين الحقل والمحصول وفترة زمنية محددة.

كود SQL لإنشاء الجداول:

SQL
-- جدول ملفات المستخدمين، مرتبط بنظام المصادقة
CREATE TABLE public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    full_name TEXT,
    role TEXT NOT NULL DEFAULT 'user' -- (e.g., 'admin', 'farm_manager', 'user')
);

-- جدول المزارع
CREATE TABLE public.farms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    location TEXT
);

-- جدول الحقول (سيتم تعديله لاحقًا مع PostGIS)
CREATE TABLE public.fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    farm_id UUID NOT NULL REFERENCES public.farms(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    area NUMERIC -- المساحة
);

-- جدول المحاصيل المرجعي
CREATE TABLE public.crops (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    scientific_name TEXT
);

-- جدول المواسم الزراعية
CREATE TABLE public.growing_seasons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    field_id UUID NOT NULL REFERENCES public.fields(id) ON DELETE CASCADE,
    crop_id INT NOT NULL REFERENCES public.crops(id),
    start_date DATE NOT NULL,
    end_date DATE,
    status TEXT NOT NULL DEFAULT 'active'
);
ب. تخزين البيانات التسلسلية الزمنية (TimescaleDB)
لتخزين بيانات المؤشرات الزراعية (NDVI, EVI) بكفاءة، سنستخدم امتداد TimescaleDB المتاح في Supa 
Google Drive icon
 base .

لماذا TimescaleDB؟ يقوم بتحويل الجداول العادية إلى "جداول فائقة" (Hypertables) مقسمة تلقائيًا حسب الزمن، مما يحسن أداء الإدخال والاستعلام بشكل هائل للبيانات التسلسل 
Google Drive icon
 
Google Drive icon
 ��ة .

خطوات التنفيذ:

تفعيل الامتداد: من لوحة تحكم Supabase، اذهب إلى Database > Extensions وقم بتفعيل timescal edb .

إنشاء جدول البيانات وتحويله:

SQL
-- جدول لتخزين قراءات المؤشرات
CREATE TABLE public.agricultural_indices (
    "time" TIMESTAMPTZ NOT NULL,
    field_id UUID NOT NULL REFERENCES public.fields(id) ON DELETE CASCADE,
    index_type TEXT NOT NULL, -- 'NDVI', 'EVI', 'SAVI', etc.
    value DOUBLE PRECISION NOT NULL,
    source TEXT -- 'satellite', 'drone', etc.
);

-- إنشاء فهرس مركب لتحسين سرعة الاستعلام
CREATE INDEX ON public.agricultural_indices (field_id, index_type, time DESC);

-- تحويل الجدول إلى Hypertable
SELECT create_hypertable('agricultural_indices', 'time');
ج. إدارة البيانات الجغرافية (PostGIS)
لتخزين واستعلام حدود الحقول بكفاءة، سنستخدم امتداد PostGI S .

لماذا PostGIS؟ يحول PostgreSQL إلى قاعدة بيانات جغرافية متكاملة، مما يسمح بإجراء استعلامات مكانية معق 
Google Mail icon
 ��ة .

خطوات التنفيذ:

تفعيل الامتداد: من لوحة تحكم Supabase، اذهب إلى Database > Extensions وقم بتفعيل post gis .

تعديل جدول الحقول: سنضيف عمودًا من نوع GEOGRAPHY، وهو الأنسب لبيانات خطوط الطول والعرض لأنه يأخذ انحناء الأرض في ال�� 
Google Mail icon
 
Google Mail icon
 ��بان .

SQL
-- إضافة عمود لتخزين حدود الحقل الجغرافية
ALTER TABLE public.fields
ADD COLUMN boundary GEOGRAPHY(Polygon, 4326); -- 4326 هو SRID لنظام WGS 84 الع�[...](asc_slot://start-slot-118)�لمي 

-- إنشاء فهرس مكاني لتسريع الاستعلامات الجغرافية
CREATE INDEX fields_boundary_idx ON public.fields USING GIST (boundary);
أمثلة على الاستعلامات:

إدخال حدود حقل:

SQL
UPDATE public.fields
SET boundary = ST_GeogFromText('SRID=4326;POLYGON((34.78 32.08, 34.79 32.08, 34.79 32.09, 34.78 32.09, 34.78 32.08))')
WHERE id = 'your-field-id';
حساب مساحة الحقل بالمتر المربع:

SQL
SELECT name, ST_Area(boundary) as area_in_sq_meters
FROM public.fields WHERE id = 'your-field-id';
البحث عن الحقول التي تتقاطع مع منطقة معينة:

SQL
SELECT name FROM public.fields
WHERE ST_Intersects(boundary, ST_GeogFromText('SRID=4326;POLYGON(...)'));
9. أمان البيانات: تطبيق الأمان على مستوى الصف (RLS) في Supabase
لضمان العزل التام لبيانات كل مزارع، يعتبر تطبيق الأمان على مستوى الصف (Row-Level Security - RLS) في Supabase هو الحل الأمثل، وسيتم فرض تفعيله آليًا عبر خط أنابي 
Google Drive icon
 

 �� CI/CD .

الخطوات التطبيقية:

تجهيز الجداول: تأكد من أن كل جدول يحتوي على بيانات خاصة بالمستخدمين (مثل fields أو farms) يحتوي على عمود owner_id أو user_id .

تفعيل RLS على الجدول: يجب تفعيل RLS بشكل صريح على كل جدول تريد حمايته. بمجرد التفعيل، يتم حظر كل الوصول افترا 
Google Mail icon
 

 ��يًا .

إنشاء سياسات الوصول (Policies):

SQL
CREATE POLICY "Allow full access for owners"
ON public.farms
FOR ALL
TO authenticated
USING ( auth.uid() = owner_id )
WITH CHECK ( auth.uid() = owner_id );
كيف تعمل؟ عند أي عملية، تقوم Supabase تلقائيًا بتطبيق شرط WHERE auth.uid() = owner_id، مما يضمن أن المستخدم لا يرى أو يعدل إلا بياناته ال 
Google Mail icon
 

 ��اصة .

10. الاختبارات (Testing)
الجودة هي حجر الزاوية في نجاحنا. خطة الاختبارات لدينا شاملة وتجمع بين الاختبارات الآلية واليدوية:

اختبار الوحدة والتكامل (Unit & Integration Tests): سيقوم المطورون بكتابة اختبارات لكل مكون ووظيفة. سيتم تشغيل هذه الاختبارات تلقائيًا في خط أنابيب CI/CD لضمان تغطية الكود بنسبة لا تقل 
Google Mail icon
 ��ن 80% .

اختبار قاعدة البيانات: استخدام أطر عمل مثل pg_tap لتشغيل اختبارات على مستوى قاعدة البيانات، ويمكن دمجها مع supabase test db .

الاختبار الشامل (End-to-End Testing): استخدام أطر عمل مثل Cypress أو Playwright لمحاكاة سلوك المستخدم الحقيقي.

الاختبار الميداني: اختبار الأجهزة (المستشعرات) في ظروف بيئية حقيقية.

البرامج التجريبية (Pilot Programs): التعاون مع عملاء مختارين لتجربة الحلول وجمع ملاحظات قيمة.

11. القواعد والقوانين لوكلاء البناء (Implementation Agents)
"وكلاء البناء" هم الشركاء الميدانيون أو الموظفون المسؤولون عن تركيب وصيانة أنظمة Adham AgriTech لدى العميل. يجب عليهم الالتزام بالقواعد التالية:

الاعتماد والتدريب: يجب على جميع الوكلاء إكمال برنامج تدريبي معتمد من Adham AgriTech.

الالتزام بالمعايير الفنية: اتباع دليل التركيب الموحد بدقة.

بروتوكولات السلامة: الالتزام بجميع معايير السلامة المهنية.

أمن وسرية البيانات: يُمنع منعًا باتًا نسخ أو مشاركة أي بيانات خاصة بالعميل.

اتفاقيات مستوى الخدمة (SLAs): الاستجابة لطلبات الصيانة خلال مدة زمنية محددة.

التقارير والتوثيق: تقديم تقرير مفصل بعد كل عملية تركيب أو صيانة.

12. التطبيق العملي لـ "ملف القواعد العالمي" عبر CI/CD
هذا المفهوم يمثل فلسفتنا في الحوكمة التقنية الآلية، ويتم تطبيقه عمليًا عبر خط أنابيب التكامل والنشر المستمر (CI/CD) باستخدام GitHub Actions وخطافات Git . الهدف هو إنشاء "بوابة جودة وأمان" آلية تفشل في حال انتهاك أي من القواعد الأساسية.

أ. المبدأ والأدوات
GitHub Actions: نظام CI/CD مدمج في GitHub لتشغيل مسارات عمل آلية عند كل push أو pull_ request .

خطافات Git (Git Hooks): سكربتات تعمل محليًا على جهاز المطور (باستخدام أدوات مثل husky) لمنع الأخطاء قبل وصولها إلى المس 
Google Mail icon
 ��ودع .

ب. إنشاء مسار عمل للتحقق الآلي (GitHub Actions Workflow)
سنقوم بإنشاء ملف .github/workflows/quality_gate.yml لتطبيق القواعد التالية تلقائيًا:

yaml
name: 'Adham AgriTech - Quality & Security Gate'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # القاعدة 1: منع وجود مفاتيح سرية في الكود
      - name: 'Scan for hardcoded secrets'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: HEAD
          extra_args: --only-verified --fail

      # القاعدة 2: ضمان نسبة تغطية اختبارات معينة
      - name: 'Run tests and check coverage'
        run: |
          npm install
          npm test -- --coverage
          # استخراج نسبة التغطية والتحقق منها (مثال)
          COVERAGE=$(npm test -- --coverage | grep 'All files' | awk '{print $4}')
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Error: Test coverage is below 80%. Actual: $COVERAGE%"
            exit 1
          fi

  verify-supabase-rls:
    runs-on: ubuntu-latest
    needs: quality-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # القاعدة 3: فرض تفعيل سياسات الأمان على مستوى الصف (RLS)
      - name: 'Verify RLS is enabled on all public tables'
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          DB_URL="postgresql://postgres:${SUPABASE_DB_PASSWORD}@db.${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co:5432/postgres"
          
          # استعلام SQL للبحث عن الجداول في السكيما 'public' التي ليس لديها RLS مفعل
          unprotected_tables=$(psql $DB_URL -t -c "SELECT relname FROM pg_class WHERE relnamespace = 'public'::regnamespace AND relkind = 'r' AND NOT relrowsecurity;")
          
          if [ -n "$unprotected_tables" ]; then
            echo "ERROR: RLS is not enabled on the following tables: $unprotected_tables"
            exit 1
          else
            echo "SUCCESS: All tables in 'public' schema have RLS enabled."
          fi
شرح القواعد الآلية:

منع المفاتيح السرية: نستخدم أداة trufflehog لفحص الكود بحثًا عن أي مفاتيح API أو كلمات مرور مسربة. إذا تم العثور على أي شيء، يفشل ال 
Google Mail icon
 
Google Mail icon
 ��سار .

ضمان تغطية الاختبارات: يقوم المسار بتشغيل الاختبارات وحساب نسبة التغطية، ويفشل إذا كانت النسبة أقل 
Google Mail icon
 ��ن 80% .

فرض تفعيل RLS: هذا هو الجزء الأهم. يقوم السكربت بالاتصال المباشر بقاعدة بيانات Supabase والاستعلام عن جداول النظام (pg_class) للتحقق من أن كل جدول في السكيما العامة لديه خاصية relrowsecurity (RLS) م 
Google Drive icon
 

 ��علة . هذا يضمن عدم وجود بيانات حساسة مكشوفة عن طريق الخطأ.

الملخص التنفيذي (Executive Summary)
يقدم مشروع Adham AgriTech فرصة استثمارية واعدة في قطاع التكنولوجيا الزراعية المتنامي . تتمثل رؤيتنا في قيادة التحول الرقمي للزراعة في المنطقة، مع التركيز على الاستدامة وزيادة الكفاءة.

تعتمد استراتيجيتنا على الابتكار التكنولوجي، حيث سنبني منصتنا باستخدام مكدس تقني حديث وقوي يشمل Next.js وSu 
Google Drive icon
 pabase . سيقدم منتجنا الأولي (MVP) ميزات متقدمة تشمل لوحة تحكم تحليلية تفاعلية تستخدم مؤشرات متقدمة مثل EVI و SAVI لتحليل صحة النبات بدقة ف 
Google Drive icon
 

 ��ئقة ، ونظام ري ذكي استباقي يعتمد على القياس المباشر لرطوبة التربة من الأقمار الصناعية لمنع الإجهاد المائي قبل ح 
Google Mail icon
 

 ��وثه ، بالإضافة إلى تشخيص أمراض النباتات بالذكاء الاصطن 
Google Mail icon
 ��عي .

تم تصميم البنية التحتية للبيانات لتكون قابلة للتطوير بشكل كبير، باستخدام امتدادات PostgreSQL المتقدمة مثل TimescaleDB لتخزين البيانات التسلسلية الزمنية بك 
Google Drive icon
 ��اءة ، وPostGIS لإدارة البيانات الجغرافية لحدود الحقول 
Google Drive icon
 
Google Mail icon
 ��دقة . سيتم تأمين بيانات العملاء بشكل كامل في بيئتنا متعددة المستأجرين من خلال تطبيق سياسات الأمان على مستوى الصف (RLS) الص 
Google Drive icon
 

 ��رمة .

لضمان الحوكمة التقنية، سنعتمد مفهوم "ملف القواعد العالمي" الذي يتم تطبيقه عمليًا عبر خط أنابيب CI/CD آلي باستخدام GitHub Actions. يقوم هذا النظام بفرض معايير الجودة والأمان تلقائيًا، مثل منع تسريب المفاتيح السرية، وضمان تغطية الاختبارات، والأهم من ذلك، التحقق من تفعيل سياسات RLS على جميع الجداول الح 
Google Drive icon
 

 ��اسة .

تتضمن رؤيتنا المستقبلية تطوير "مساعد زراعي ذكي" متعدد الوسائط والنماذج، يعتمد على بنية RAG المتقدمة والتكامل مع نماذج لغوية رائدة مثل GPT-4o و** 
Google Mail icon
 

 Gemini** . يمثل Adham AgriTech مشروعًا ذا جدوى اقتصادية عالية وقيمة تقنية متقدمة، وهو مصمم ليكون رائدًا في مستقبل الزراعة الذكية.

